<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Wonderland</title>
  <icon>https://github.com/waynexia.png</icon>
  
  <link href="https://waynexia.github.io/atom.xml" rel="self"/>
  
  <link href="https://waynexia.github.io/"/>
  <updated>2023-11-23T08:35:22.628Z</updated>
  <id>https://waynexia.github.io/</id>
  
  <author>
    <name>Wayne</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Querying Prometheus</title>
    <link href="https://waynexia.github.io/2023/11/querying-prometheus/"/>
    <id>https://waynexia.github.io/2023/11/querying-prometheus/</id>
    <published>2023-11-23T16:13:33.000Z</published>
    <updated>2023-11-23T08:35:22.628Z</updated>
    
    <content type="html"><![CDATA[<p>Explain PromQL in simple SQL that you are familiar with.</p><blockquote><p>This blog is work-in-progress. But you can still read and discuss it with me.</p></blockquote><p>Planned content:</p><ul><li>select data</li><li>operations</li><li>format in storage</li><li>joins, group and set operation</li><li>get distributed</li><li>extension on types and operations</li><li>counter, histogram and summary</li></ul><h1 id="Select-data"><a href="#Select-data" class="headerlink" title="Select data"></a>Select data</h1><p>Prometheus collects data in an unreliable way. The data process pipeline has considered and brings lots of â€œspecial logicâ€ to make those unreliable data look reasonable and intuitive. But as the price, that logic might not be straightforward as a traditional SQL-based database. This section includes lookback,  null-handling, offset, interval.</p><p>Notice that those mechanisms always take effort together. To keep the explanation dry, other cases are ignored when explaining one (E.g., â€œoffsetâ€ section assumes there is no â€œlookbackâ€).</p><h2 id="offset"><a href="#offset" class="headerlink" title="offset"></a>offset</h2><p>This is the simplest one. Offset is used to â€œbiasâ€ the dataâ€™s timestamp â€“ every data point in Prometheus has a related timestamp, as well as the query itself. In SQL, the table (Prometheus names it â€œmetricâ€) looks just like this:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> metric (<br>ts, <span class="hljs-type">timestamp</span>(<span class="hljs-number">3</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>    v, <span class="hljs-keyword">double</span>,<br>    tag_1 string,<br>    tag_2 string,<br>    ...<br>    <span class="hljs-keyword">PRIMARY</span> KEY (tag_1, tag_2, ...),<br>);<br></code></pre></td></tr></table></figure><p>The <code>offset</code> provides a way to <strong>push backward</strong> (toward an earlier time) the time range of querying:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> ... <span class="hljs-keyword">FROM</span> metric <span class="hljs-keyword">WHERE</span> ts <span class="hljs-operator">&gt;=</span> (<span class="hljs-keyword">START</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">OFFSET</span>) <span class="hljs-keyword">and</span> ts <span class="hljs-operator">&lt;</span> (<span class="hljs-keyword">END</span> <span class="hljs-operator">-</span> <span class="hljs-keyword">OFFSET</span>);<br></code></pre></td></tr></table></figure><p>For example, if we query data between <code>2023-11-14T18:00:00Z</code> and <code>2023-11-14T22:00:00Z</code>, and with â€œ1hâ€ offset, the equal SQL would be something like below:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> ... <span class="hljs-keyword">FROM</span> metric <span class="hljs-keyword">WHERE</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-string">&#x27;2023-11-14T17:00:00Z&#x27;</span> <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;</span> <span class="hljs-string">&#x27;2023-11-14T21:00:00Z&#x27;</span><br></code></pre></td></tr></table></figure><p>Another point is the offset can be negative. In this case, you are just â€œminus a negativeâ€</p><h2 id="interval"><a href="#interval" class="headerlink" title="interval"></a>interval</h2><p>You might be wondering why the results from Prometheus step are aligned to the given resolution but not the data collection interval. Here is an example result part I get with <code>7s</code> resolution:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">[   ...,<br>    [1700635385,&quot;1&quot;],<br>    [1700635392,&quot;1&quot;],<br>    [1700635399,&quot;1&quot;],<br>    [1700635406,&quot;1&quot;],<br>    [1700635413,&quot;1&quot;],<br>    ...<br>]<br></code></pre></td></tr></table></figure><p>Thatâ€™s because Prometheus doesnâ€™t generate timestamp directly from the dataâ€™s timestamp, but in a reversed way, where the timestamp in the result is determined first, then finds values suited for that timestamp and feeds them into calculate operators. The <code>interval</code> is one of the key parameters for determining the timestamps in result. It works very simply â€“ if we use a <code>for</code> loop to simulate this behavior, it would be</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">for</span> (ts = start; ts &lt; end; ts += interval) &#123;&#125;<br></code></pre></td></tr></table></figure><h2 id="lookback"><a href="#lookback" class="headerlink" title="lookback"></a>lookback</h2><p>Also, unlike SQL where filter filters the â€œexactâ€ what you require, PromQL will take its liberty to find data out the range of your query and present them to you. This behavior is called â€œlookbackâ€, looking at a larger range and fetching data for calculation.<br>For example, if the current timestamp we are calculating is <code>1700000000</code> (<code>2023-11-14T22:13:20Z</code>), and lookback delta is â€˜5mâ€™ (300s). The filter is not <code>WHERE ts = 1700000000</code>, but this:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> ... <span class="hljs-keyword">FROM</span> metric <span class="hljs-keyword">WHERE</span> ts <span class="hljs-operator">&gt;=</span> <span class="hljs-number">1699999700</span> <span class="hljs-keyword">AND</span> ts <span class="hljs-operator">&lt;=</span> <span class="hljs-number">1700000000</span>;<br></code></pre></td></tr></table></figure><p>That is, Prometheus will take up to 5 minutes of data into consideration when calculating one data point.</p><h2 id="null-handling"><a href="#null-handling" class="headerlink" title="null handling"></a>null handling</h2><p>TODO</p><h2 id="donâ€™t-repeat"><a href="#donâ€™t-repeat" class="headerlink" title="donâ€™t repeat"></a>donâ€™t repeat</h2><p>Though Prometheus will try its best to find data, but it wonâ€™t grab a repeated dataset for calculation, where all the points are the same, i.e., it wonâ€™t repeat on one point to fill absent timestamps.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;Explain PromQL in simple SQL that you are familiar with.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This blog is work-in-progress. But you can still read and di</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>åŸå­ä¹‹å¿ƒ</title>
    <link href="https://waynexia.github.io/2023/08/atomic-heart/"/>
    <id>https://waynexia.github.io/2023/08/atomic-heart/</id>
    <published>2023-08-30T22:54:53.000Z</published>
    <updated>2023-11-23T08:35:22.624Z</updated>
    
    <content type="html"><![CDATA[<p>ä»æ¦‚å¿µå›¾å’Œ PV å¼€å§‹å°±æº¢å‡ºå±å¹•çš„å¤å¤ç§‘å¹»çš„å‘³é“è®©äººéå¸¸å¿ƒåŠ¨ï¼Œè€Œä¸”é¦–å‘ XGP å®Œå…¨æ²¡æœ‰é—¨æ§›ã€‚</p><p>å¯¹æˆ‘æ¥è¯´ï¼Œç§‘å¹»çš„èƒŒæ™¯è®¾å®šåˆ°äº”åå¹´å‰å’Œäº”åå¹´åå®Œå…¨æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œæ¯•ç«Ÿéƒ½ç®—æ˜¯â€œé¥ä¸å¯åŠâ€çš„æ—¶ä»£äº†ã€‚è€Œä¸”è™½ç„¶ä¿„å¼æ¸¸æˆæ¥è§¦å¾—ä¸å¤šï¼Œä½†æ˜¯å¤è€çš„ç§‘å¹»æ•…äº‹å¬äº†ä¸å°‘ï¼Œè¿™ä¸ªå¸¦å…¥èµ·æ¥æ˜¯éå¸¸ç†Ÿç»ƒäº†ã€‚</p><p>è¿‡å»å¼ç§‘å¹»çš„é†é†å‘³å°±æ˜¯åˆè€åˆæ–°ï¼Œæœ‰äº›æ˜¯æ—¶ä»£æœ¬èº«çš„é™åˆ¶ï¼Œæœ‰äº›æ˜¯æ•…æ„åšæ—§çš„æ•ˆæœã€‚åŸå­ä¹‹å¿ƒè¿™æ¬¡çš„åšæ—§æˆ‘è§‰å¾—ä½“éªŒèµ·æ¥å¾ˆæ»¡æ„ï¼Œæ¯”æ³¢å£«é¡¿çš„ç‹—è¿˜çµæ´»çš„æœºå™¨äººï¼Œè„¸ä¸Šæ˜¯é¢å…·ä¸€æ ·çš„è¡¨æƒ…ï¼›ç©ºå¤©æµ®å²›ä¸Šå»ºçš„æ˜¯è€å¼æ­¥é“å’Œå°çº¢ç“¦æˆ¿ï¼›æ¿€å…‰æ„Ÿåº”çš„é”é”ä½çš„ç”µæ¢¯é‡ŒæŒ‚ç€çš„æ˜¯è½¬ç›˜ç”µè¯ç­‰ç­‰ã€‚æ­¤å¤–ï¼Œç¾æœ¯è®¾ç½®éå¸¸ä¼˜ç§€â€”â€”è¿™ä¹Ÿæ˜¯æœ€çªå‡ºçš„äº®ç‚¹ã€‚è€Œä¸”ä¸åªæ˜¯ç¾æœ¯æœ¬èº«ï¼Œä½œä¸ºå¤§èƒŒæ™¯è®¾å®šçš„ä¸¤æäº‰éœ¸å’Œçº¢è‰²é£æ ¼ä¹Ÿè®©äººè§‰å¾—éå¸¸å¤å¤ã€‚åŠ ä¸Šä¸€å¼€å§‹å°±èƒ½è§åˆ°çš„ä¸€å †å¥‡è§‚ã€è¶…å¤§é›•åƒã€è¶…å¤§äººåƒæµ·æŠ¥å’Œæ²¡æœ‰æ„Ÿæƒ…çš„å¤è¯»æœºäººç­‰ç­‰ï¼Œå†ä¸€è¿æƒ³åˆ°æ¸¸æˆåˆšå‘å”®çš„æ—¶å€™çš„é‚£æ®µå°å­¦ç”Ÿæ™¯åŒºä»‹ç»ï¼Œåªèƒ½è¯´å¤ªè‰ºæœ¯äº†ã€‚</p><p><img src="./statue.jpeg" alt="statue"></p><hr><p>è™½ç„¶ç¾æœ¯éŸ³ä¹è®¾å®šç­‰ç­‰éƒ½å’Œä¸Šä¹˜ï¼Œä½†æ˜¯ä½œä¸ºæ¸¸æˆæœ¬èº«çš„ game play éƒ¨åˆ†è¿˜æ˜¯è®©äººæœ‰ç‚¹å¤´ç–¼ï¼ˆå­—é¢ï¼‰ã€‚è™½ç„¶æ˜¯åœ¨ä¸€ä¸ªå¾ˆä¸é”™çš„åœºæ™¯é‡Œï¼Œä½†æ˜¯æ²¡è¿‡å¤šä¹…å°±ä¸§å¤±äº†æ¢ç´¢çš„æ¬²æœ›ã€‚åœ¨è·¯ä¸Šæ»¡æ˜¯æ€ªç‰©ï¼Œå¦‚æœä¸æ˜¯ä¹Ÿé©¬ä¸Šå°±æ˜¯äº†ã€‚æ•Œäººè¶…è¿œçš„ç´¢æ•ŒèŒƒå›´ï¼Œè”åŠ¨å’Œå¢æ®–æœºåˆ¶ï¼Œä½¿å¾—åœ¨æˆ·å¤–çš„æ—¶å€™æ°¸è¿œåˆ«æƒ³åœä¸‹æ¥ã€‚è€Œä¸æ­¤ç›¸å¯¹çš„æ˜¯è¾ƒä½çš„æ”¶ç›Šå’Œè¾ƒå·®çš„æ”»å‡»ä½“éªŒï¼Œè‹¦è‹¦æˆ˜æ–—ä¸å¦‚ç›´æ¥é€ƒè·‘ã€‚è¿˜æœ‰éšå¤„å¯è§çš„æœ‰å½¢å›´å¢™ï¼Œä»¥åŠä¸å¯è§çš„ bug å½¢æˆçš„ç©ºæ°”é™·é˜±ï¼Œä¸æ²¿ç€ä¸»è·¯èµ°é©¬ä¸Šå°±ä¼šæ•™ä½ åæ‚”ã€‚</p><p>è¿™ä¸€å¥—æµç¨‹ä¸‹æ¥ï¼Œåœ¨æˆ·å¤–ç›´æ¥å¥”å‘ä¸‹ä¸€ä¸ªç›®æ ‡ç‚¹å˜æˆäº†æœ€ä¼˜è§£ã€‚è·¯è¾¹çš„å°å±‹ï¼Ÿæ²¡çœ‹è§ï¼Œé‡Œé¢æŒ‡å®šä¸€å †ä¸çŸ¥é“ä»€ä¹ˆä¸œè¥¿ç­‰ç€ä½ ï¼Œæœåˆ®å®Œå¤§æ¦‚ç‡ä¹Ÿå°±å‡ é¢—å­å¼¹ï¼Œè€Œä¸”å­å¼¹æœ¬èº«å°±ç”¨ä¸å®Œã€‚åæ¥å»äº‘äº†äº›å¼€å‘èŠ±è¾¹ï¼Œå¬è¯´æœ‰è®¸å¤šä¹‹å‰æ—©æœŸé˜¶æ®µå±•ç¤ºè¿‡çš„æ€ªç‰©éƒ½è¢«ç§»é™¤äº†ï¼ŒåŸå› æ˜¯æ‹…å¿ƒå½±å“æ¢ç´¢ä½“éªŒã€‚çœ‹äº†ä¸‹ç§»æ‰çš„é‚£å‡ ä¸ªæ›´æ˜¯é€†å¤©ï¼Œå“¼ç€å°æ›²å¼€ç€è½¦ç»™ä½ æ¥ä¸€å¥— QTE çš„é¸¨å¼å’Œå¤©èŠ±æ¿ä¸Šçš„å€’æŒ‚æƒŠå“é­”ç›’é“èœ˜è››ã€‚åªèƒ½è¯´æ”¹äº†ä½†æ²¡å®Œå…¨æ”¹ã€‚</p><p>åªéœ€è¦è·‘è·¯è¿˜ä¸æ˜¯æœ€ç—›è‹¦çš„ï¼Œæ¸¸æˆé‡Œå‘å‰æ–¹ç§»åŠ¨å’Œå‘ä¾§/åæ–¹ç§»åŠ¨çš„é€Ÿåº¦æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ˜¾ç¤ºçš„è§†é‡ä¹Ÿä¸æ˜¯å¾ˆå¤§ï¼Œç©ç€ç©ç€å°±å®¹æ˜“å¤´æ™•ï¼Œä¸ªäººä½“éªŒæ˜¯åªèƒ½æ’‘åŠä¸ªå°æ—¶ã€‚æˆ‘çŒœå¯èƒ½æ˜¯ä¸ºäº†çœæ‰å‰è¿›çš„æ—¶å€™éœ€è¦ä¸€ç›´æŒ‰ç€è·‘æ­¥é”®æ‰€åŠ çš„è®¾å®šå§ï¼Œä½†æ˜¯ä¸è¯´åœ¨éœ€è¦æ‹å¼¯çš„æ—¶å€™ä¼šå¾ˆè‡ªç„¶åœ°å·¦å³æ‘‡æ†ä¸€èµ·æ‰“ï¼Œå¹³å¸¸èµ°è·¯çœ‹åˆ°ä¸ªç®±å­ä»€ä¹ˆçš„ä¹Ÿä¼šåŠ¨æ‘‡æ†ï¼Œè¿™æ—¶å€™çªç„¶æ…¢ä¸‹æ¥å°±è·Ÿè¸©äº†ä»€ä¹ˆä¸œè¥¿ä¸€æ ·ï¼Œæ‰‹æ„Ÿç¨€çƒ‚ã€‚å®Œç¾åœ°æ¨¡æ‹Ÿäº†æ™•è½¦çš„æ„Ÿè§‰ï¼šä½ ä¸çŸ¥é“å¸ˆå‚…ä»€ä¹ˆæ—¶å€™æ²¹é—¨ä»€ä¹ˆæ—¶å€™åˆ¹è½¦ï¼Œåªæœ‰ä½ çš„å‰åº­ç³»ç»Ÿå’Œçœ¼ç›åœ¨è„‘å­é‡Œé¢æ‰“æ¶ã€‚</p><p>åœ°å›¾è®¾è®¡æ„Ÿè§‰ä¹Ÿèƒ½å†æå‡ä¸€ä¸‹ï¼Œåœ°å›¾ä¸Šè¿˜æ”¾äº†å·¨é‡çš„åªæœ‰ä¸€æˆªçš„æ­»è·¯ï¼Œå¾ˆå®¹æ˜“èµ°ç€èµ°ç€å¿˜è®°åˆšåˆšæƒ³è¦å»çœ‹çš„åœ°æ–¹æ˜¯å“ªé‡Œï¼Œçº¯çº¯çš„åå‘å¼•å¯¼ã€‚æœ‰äº›npcçš„ä½ç½®ä¹Ÿå¾ˆå¥‡æ€ªï¼Œæœ‰æ”¾åˆ°å­˜æ¡£ç‚¹å¤–é¢çš„ï¼Œæœ‰ä¸‰å››ä¸ªå‚¨ç‰©ç®±è¿ç»­æ”¾ä¸€èµ·çš„ï¼Œè¿˜æœ‰ä¸€å¼€å§‹æœ‰ä¸€æ¡å¾€æ¥ä¸‹æ¥èµ°çš„è·¯æ”¾åˆ°äº†å®‰å…¨åŒºå†…ï¼Œæ¥æ¥å›å›ç»•äº†åŠå¤©æ‰å‘ç°ã€‚</p><p>é™¤äº†ç¾æœ¯å‰§æƒ…ï¼Œæˆ˜æ–—ä¹Ÿæ˜¯å æ¯”æ¯”è¾ƒå¤§çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼Œæä¾›äº†ä¸‰å››å¥—æŠ€èƒ½ï¼Œä¸‰ç§å…ƒç´ å’Œä¸€å †ä¸åŒåŠ¨ä½œçš„æ­¦å™¨èƒ½å¤Ÿä½¿ç”¨ï¼Œè€Œä¸”è¿˜æœ‰éå¸¸å…ˆè¿›çš„æ— ç—›æ´—ç‚¹ç§‘æŠ€é¼“åŠ±å°è¯•å„ç§ç»„åˆï¼Œæ„ç­‘ä½“éªŒä¸ç”¨çº ç»“äº†ã€‚ä¸è¿‡ç­‰åˆ°æ„ç­‘å®Œä¸Šæ‰‹å®æ“çš„æ—¶å€™ä¼šå‘ç°ï¼Œæ¸¸æˆä¸å¸¦è§†è§’é”å®šçš„ï¼Œåˆ«è¯´è¿œç¨‹æ­¦å™¨çš„ç„å‡†ï¼Œå…‰æ˜¯æƒ³çŸ¥é“æ•Œäººçš„æ–¹ä½å°±è´¹è€å¤§åŠ²äº†ã€‚æ‰“å¤§å‹bossæˆ–è€…æ··æˆ˜çš„æ—¶å€™åŸºæœ¬å°±æ˜¯å…¨ç¨‹åœ¨è½¬åœˆåœˆï¼ˆè±å› å“ˆç‰¹.gifï¼‰ã€‚</p><p><img src="./game-over.jpeg" alt="game-over"></p><blockquote><p>ä¸è¿‡æ¯æ¬¡æ­»äº¡éƒ½æœ‰ä¸€ä¸ªå°åŠ¨ç”»çœ‹ï¼ˆ</p></blockquote><p>å¯èƒ½é¼ æ ‡æ“ä½œè¿˜ç›¸å¯¹å¥½ä¸€ç‚¹ï¼Œä½†æ˜¯æ‰‹æŸ„ç©å®¶æ“ä½œèµ·æ¥çœŸçš„æ€€ç–‘staffè‡ªå·±æ‰“ä¸æ‰“ã€‚æ€ªç‰©éšä¾¿ä¸€ä¸ªåŠ¨ä½œå°±å†²å‡ºäº†è§†é‡ï¼Œå®ƒè¦æ˜¯é«˜å…´ä½ çš„å³æ‘‡æ†æ ¹æœ¬æ”¾ä¸å¼€ã€‚æ‰“äº†å‡ åœºä¹‹åä¸“é—¨å‡ºå»æŠŠé—ªé¿æ”¹åˆ°æ‰‹æŸ„èƒŒé”®ï¼Œä¸ç„¶å®Œå…¨å°±æ˜¯ç«™æ¡©æ´»é¶å­ã€‚</p><p>å¦å¤–æ€ªç‰©çš„ç§ç±»ç›¸å¯¹æ¥è¯´è¿˜ç®—å¯ä»¥ï¼Œå‰é¢è¿˜è¯´åˆ äº†å¥½å‡ ä¸ªã€‚ä½†æ˜¯å®é™…æ¸¸ç©èµ·æ¥è¿˜æ˜¯è§‰å¾—éå¸¸é‡å¤å’Œæ¯ç‡¥ã€‚ä¸ä»…æ˜¯åˆ·æ–°å¾—å¤ªå¯†é›†äº†ï¼Œè€Œä¸”å–œæ¬¢æ»¥ç”¨ä¹Ÿæ˜¯ä¸€ä¸ªåŸå› ï¼Œæœ‰äº‹æ²¡äº‹æ€»è¦ç»™ä½ æ”¾ç‚¹æ€ªåœ¨æ—è¾¹ç”Ÿæ€•ä½ é—²ç€ã€‚æœ€å—ä¸äº†çš„ä¸€æ¬¡æ˜¯è¿˜åœ¨ç”µæ¢¯é‡Œé¢è¿‡å‰§æƒ…ï¼Œçªç„¶ç”µæ¢¯åˆ°äº†ï¼Œé—¨æ‰“å¼€å†²è¿‡æ¥ä¸€ä¸ªå°èƒ¡å­ç»™æˆ‘å°±æ˜¯ä¸€æ‹³ï¼Œç­‰æˆ‘æ‰“å®Œåˆšåˆšæ‰‹å¥—è¯´äº†ä»€ä¹ˆå®Œå…¨ä¸è®°å¾—äº†ã€‚</p><p>è§£è°œè¦ç´ ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåˆè§æµç¨‹èµ°ä¸‹æ¥å·²ç»ç†Ÿç»ƒåœ°æŒæ¡äº†ä¸‰ç§è‹è”é«˜ç§‘æŠ€ç”µå­é”çš„å¼€é”æ–¹æ³•ï¼Œè¿™ç§å®Œå…¨é‡å¤ï¼Œåˆä¸æ€ä¹ˆéœ€è¦åŠ¨è„‘å­çš„å†…å®¹åœ¨å…³é”®çš„åœ°æ–¹é”ä¸€ä¸¤ä¸‹å°±ç®—äº†ï¼Œæœ‰çš„åœ°æ–¹å¤§è·¯ä¸Šèµ°å¾—å¥½å¥½çš„ä¹Ÿè¦ç»™ä½ æ¥æŠŠé”å¡ä¸€ä¸‹å®åœ¨æ˜¯æ„ä¹‰ä¸æ˜ã€‚å…¶ä»–çš„åœºæ™¯è°œé¢˜ä¹Ÿç›´æ¥è¿›è¡Œä¸€ä¸ªé‡å¤çš„ä½¿ç”¨ï¼Œè¯•éªŒåœºå’Œå¤–é¢å‰§æƒ…é‡åˆ°çš„è°œé¢˜ï¼ˆåœ¨æˆ‘æ‰“è¿‡çš„é‡Œé¢ï¼‰æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œç»™äººä¸ºäº†æ”¾è°œé¢˜è€Œæ”¾è°œé¢˜çš„æ„Ÿè§‰ã€‚ä¸»è§’è¯­éŸ³è‡ªå·±ä¹Ÿåæ§½å¾ˆå¤šæ¬¡ï¼Œçœ‹èµ·æ¥æ˜¯æ•…æ„çš„ã€‚</p><p>æœ€åç¨‹åºè´¨é‡ä¹Ÿæœ‰ç‚¹é—®é¢˜ï¼Œ æ²¡æœ‰å¾å…†åœ°é—ªé€€äº†å¥½å‡ å›ï¼Œè¿˜æœ‰åŸºæœ¬å…¨ç¨‹å­˜åœ¨çš„è·³å¯¹è¯æ—¶å€™çš„èŠ±å±ç­‰ç­‰ã€‚å¯¹æ‰‹æŸ„æ“ä½œæ¨¡å¼çš„é€‚é…ä¹Ÿå¾ˆæ•·è¡ï¼Œåœ¨è¿™é‡Œå‘è¡¨ä¸€ä¸ªçˆ†è®ºï¼šå‡¡æ˜¯æ‰‹æŸ„æ¨¡å¼ä¸‹è¿˜å‡ºç°è‡ªç”±å…‰æ ‡uiçš„ä¸€å¾‹æ‰£åˆ†ï¼Œ<ruby>å¿…é¡»ä½¿ç”¨å…‰æ ‡<rt>Atomic Heart</rt></ruby>çš„ç›´æ¥0åˆ†ã€‚</p><p><img src="./twins.jpeg" alt="twins"></p><blockquote><p>å›¾æ–‡æ— å…³ï¼Œåªæ˜¯æƒ³æ”¾ä¸€å¼ åŒç”Ÿèˆä¼¶åœ¨è¿™é‡Œ</p></blockquote><hr><p>æ•…äº‹è®¾å®šçš„ç‹é“ï¼ˆï¼Ÿï¼‰è‹è”ä¸ç‰¹è‰²CommunismèƒŒæ™¯ï¼Œä»¥åŠè¿™ä¸ªå¤§é›†ä½“<u title="åŠ ä¸Šå›´ç»•è¿™ä¸ªèƒŒæ™¯å±•å¼€çš„äººç‰©åŠ¨æœºã€å…³ç³»å’Œå†²çªæ ¹æºã€‚äººäººå¹³ç­‰ï¼Œåªæ˜¯æœ‰äº›äººæ›´åŠ å¹³ç­‰">ç®€ç›´æ˜¯</u><u title="â€”â€”èµµé¼æ–°">æ•™ç§‘ä¹¦</u>èˆ¬çš„åˆ»æ¿å°è±¡ï¼š</p><blockquote><p>é‡‡ç”¨è¿™ä¸€æ–¹æ³•çš„å­¦è€…ä¸€èˆ¬ä¸ä¼šå¯¹å…¶ç†è®ºä¸­çš„äººçš„è¡Œä¸ºæ¨¡å¼åšå‡ºè¯¦ç»†è¯´æ˜ã€‚â€¦â€¦ä¸»ä¹‰ç†è®ºå¹¶æœªå¯¹äººçš„è¡Œä¸ºæ¨¡å¼åšå‡ºè¯¦ç»†ç•Œå®šï¼Œâ€¦â€¦ä¸»ä¹‰ç†è®ºä¸­ï¼Œç”Ÿäº§æ–¹å¼å’Œä¸ä¹‹ç›¸é€‚åº”çš„é˜¶çº§å…³ç³»è¢«çœ‹ä½œå†å²å‘å±•çš„å”¯ä¸€ä¸»çº¿ã€‚</p></blockquote><p>é¦–å‘ä¸­æ–‡çš„æ¸¸æˆç°åœ¨è¶Šæ¥è¶Šå¤šäº†ï¼Œä½†æ˜¯é¦–å‘ä¸­æ–‡è¯­éŸ³ï¼Œè€Œä¸”è¿˜æ˜¯è¿™ä¹ˆä¼˜ç§€çš„é…éŸ³è´¨é‡å’Œå®Œå…¨èå…¥çš„æœ¬åœ°åŒ–æ•ˆæœç°åœ¨ä¹Ÿå¾ˆå°‘è§åˆ°ï¼ˆç”šè‡³æŠŠæœ¬åœŸæ¸¸æˆç®—ä¸Šä¹Ÿæ˜¯è¿™æ ·ï¼‰ã€‚æœ€å‡ºåœˆçš„å°±æ˜¯çº¢è‰²é­…é­”å°å†°ç®±ï¼Œåœ¨å®¢å…å¤–æ”¾ç¡®å®æœ‰äº›ç¾è€»ã€‚åœºæ™¯ç´ æé‡Œé¢æ‰€æœ‰ï¼ˆæˆ‘é‡åˆ°çš„ï¼‰çš„æ–‡å­—éƒ½åšäº†ç¿»è¯‘ï¼Œå‡†å¿ƒå¯¹å‡†å°±ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼Œæœ‰äº›åœºæ™¯è¿˜ç›´æ¥å°†ç´ æåšæˆäº†ä¸­æ–‡çš„ã€‚å¯¹ä¸€ä¸ªåå°æ—¶æµç¨‹çš„æ¸¸æˆæ¥è¯´æ–‡æœ¬é‡åº”è¯¥ç®—åå¤šçš„é‚£ä¸€æ¡£äº†ï¼Œè”åŠ¨æœ€è¿‘æ˜Ÿç©ºå·è·‘å‡ºæ¥çš„zh-MSï¼Œç®€ç›´æ˜¯äº‘æ³¥ä¹‹åˆ«ã€‚æ–‡æœ¬æ±‰åŒ–è¿˜èƒ½é ç”¨çˆ±å‘ç”µï¼Œä½†æ˜¯ä¼˜ç§€çš„é…éŸ³ç°åœ¨è¿˜åªæœ‰å‚å•†èƒ½æä¾›ï¼Œç°åœ¨çš„ç§‘æŠ€æ›´å¤šçš„ä¹Ÿåªæ˜¯åœ¨éŸ³è‰²å±‚é¢çš„è½¬æ¢ï¼Œèå…¥æ„Ÿå¼ºè¿˜å¾—é äººå£°ï¼Œä¸Šä¸€æ¬¡æœ‰è¿™ç§é…éŸ³ä½“éªŒæ˜¯å¾ˆä¹…ä¹‹å‰äº†ã€‚å·è¿™äº›ä¸æ¯”ç”»è´¨æ•°æ¯›ã€å…‰è¿½é˜´å½±æ¥å¾—æ›´æ‹ŸçœŸï¼Ÿ</p><p>é…ä¹åœ¨å‡ åœºå…³é”®æˆ˜æ–—å’Œå‰§æƒ…éƒ½æŒºæœ‰ä»£å…¥æ„Ÿçš„ï¼Œå¯èƒ½è·Ÿæœ¬æ¥ä¹åº“ä¸°å¯Œä¹Ÿæœ‰å…³ç³»å§ï¼Œè·Ÿå¤šè¿˜éƒ½æ˜¯ç¬¦åˆè®¾å®šçš„æ—¶ä»£å’ŒèƒŒæ™¯çš„ã€‚å½“ç„¶ä¹Ÿæ²¡æœ‰å®Œå…¨å±€é™åœ¨è‹è”éŸ³ä¹é‡Œé¢ï¼Œåœ¨æŸ³æ ‘åŸ¹è‚²é—´é‚£é¦–æ— äººå£°çš„é­”ç¬›ä¹Ÿè®©äººå°è±¡æ¯”è¾ƒæ·±åˆ»ã€‚æµç¨‹ä¸­è¿˜æœ‰ä¸€ä¸ªåœºæ™¯å°±æ˜¯è®¾å®šåœ¨æ­Œå‰§é™¢é‡Œé¢ï¼Œä¸Šæ¼”ç€æœºå™¨äººèŠ­è•¾èˆçš„è¡¨æ¼”ã€‚ç”¨å¾ˆæœ‰åˆ›æ„çš„æ–¹å¼ä¸€è¾¹å±•ç¤ºç¾æœ¯è®¾è®¡ï¼Œä¸€è¾¹æ¨è¿›å‰§æƒ…èƒŒæ™¯ï¼Œæˆªå›¾é”®å…¨ç¨‹é«˜å¼ºåº¦ä¸Šç­ã€‚èŠ­è•¾å’Œæ­Œå‰§éƒ½çœ‹å¾—æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯è§‰å¾—è¿™é‡Œç”¨æœºå™¨äººå±•ç¤ºçš„ä¸œè¥¿å¾ˆæ£’ï¼Œå¯æƒœçš„å°±æ˜¯æ²¡æœ‰å®Œæ•´çš„ä¸€å¹•ï¼Œè€Œéƒ½æ˜¯å‡ ä¸ªé›¶æ•£åŠ¨ä½œçš„è¡¨æ¼”ã€‚</p><p><img src="./projection.jpeg" alt="projection"></p><p>å‰§æƒ…æ¨è¿›æ–¹é¢è¿˜æœ‰å‡ æ®µç”»é£çªå˜çš„ã€æœ‰ç‚¹æ„è¯†æµçš„è¿‡åœºã€‚è§’è‰²æ–­ç‰‡ä¹‹åçªç„¶å‡ºç°åœ¨ä¸€ä¸ªå¥‡å¦™çš„åœ°æ–¹ï¼Œå‘¨å›´å‡ ä¸ªå£°éŸ³ä¸€ç›´å¯¹ä½ è®²ç€å¬ä¸æ‡‚çš„è°œè¯­ã€‚å¯èƒ½æ˜¯è·¯ä¸Šå·æ‡’æ²¡æœ‰çœ‹åˆ°ç›¸å…³çš„å‰§æƒ…æç¤ºï¼Œåœ¨æ“ä½œçš„æ—¶å€™å¤šå°‘æ˜¯æœ‰ç‚¹äº‘é‡Œé›¾é‡Œçš„ã€‚ä¸è¿‡å¯èƒ½ä¹Ÿä¸å¤ªå½±å“ï¼Œè¿™å‡ æ®µçš„æ“ä½œæœ¬èº«ä¹Ÿæ¯”è¾ƒå¼±ï¼ŒåŸºæœ¬åªè¦èµ°è·¯å°±è¡Œäº†ï¼Œä¹Ÿè®¸åè€Œæ›´åŠ è´´è¿‘è§’è‰²å½“æ—¶çš„æ„Ÿè§‰ã€‚</p><p>æœ€åå†³æˆ˜ç¯‡å¯¹ç•™ä¸‹æ¥çš„ä¼ç¬”è¿›è¡Œäº†å›æ”¶ï¼ŒåŒ…æ‹¬è¿™å‡ æ®µè¿‡åœºä¹Ÿç»™äº†è§£é‡Šï¼ˆä¸è¿‡è¿˜æ˜¯ä¸çŸ¥é“é‚£åªçŒ«çŒ«åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿï¼‰ã€‚ä½†æ˜¯ï¼è¿™ä¸ªç»“å±€å®åœ¨æ˜¯å¤ªç»·ä¸ä½äº†ï¼Œæœ€åäºŒååˆ†é’Ÿçš„æµç¨‹è·Ÿæˆ‘çš„å°å­¦ä½œæ–‡ä¸€æ¨¡ä¸€æ ·ï¼Œä¸€çœ‹å­—æ•°å·®ä¸å¤šäº†å°±ç›´æ¥æ¥ä¸ªå”çªç»“å°¾ã€‚æœ€åå†³æˆ˜å‰ä¼šç»™ä½ ä¸¤ä¸ªé€‰é¡¹ï¼Œç±»ä¼¼é€‰è¾¹çš„ã€‚é‡Œé¢ä¸€ä¸ªæ˜¯å†²è¿›å»æ‰“å‡ æ¶ï¼Œç„¶åè¾“è¾“è¾“ï¼Œå¦ä¸€ä¸ªç›´æ¥ <em>â€œæˆ‘ä¸å¹²äº†ï¼Œæˆ‘è¦å»æµ·æ»©åº¦å‡â€</em> ç„¶åå¼€å§‹ç»“æŸæ’­ç‰‡ã€‚å½“æ—¶å¿ƒæƒ…æ˜¯éå¸¸éœ‡æ’¼çš„ï¼Œæ€€ç–‘è‡ªå·±åˆ°åº•çœ‹äº†ä¸ªå•¥ã€‚</p><hr><p><em>æˆ‘ä¸å†™äº†ï¼Œæˆ‘è¦å»ç¡è§‰</em></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;ä»æ¦‚å¿µå›¾å’Œ PV å¼€å§‹å°±æº¢å‡ºå±å¹•çš„å¤å¤ç§‘å¹»çš„å‘³é“è®©äººéå¸¸å¿ƒåŠ¨ï¼Œè€Œä¸”é¦–å‘ XGP å®Œå…¨æ²¡æœ‰é—¨æ§›ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹æˆ‘æ¥è¯´ï¼Œç§‘å¹»çš„èƒŒæ™¯è®¾å®šåˆ°äº”åå¹´å‰å’Œäº”åå¹´åå®Œå…¨æ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ï¼Œæ¯•ç«Ÿéƒ½ç®—æ˜¯â€œé¥ä¸å¯åŠâ€çš„æ—¶ä»£äº†ã€‚è€Œä¸”è™½ç„¶ä¿„å¼æ¸¸æˆæ¥è§¦å¾—ä¸å¤šï¼Œä½†æ˜¯å¤è€çš„ç§‘å¹»æ•…äº‹å¬äº†ä¸å°‘ï¼Œè¿™ä¸ªå¸¦å…¥èµ·æ¥</summary>
      
    
    
    
    
    <category term="Experience" scheme="https://waynexia.github.io/tags/Experience/"/>
    
    <category term="Game" scheme="https://waynexia.github.io/tags/Game/"/>
    
  </entry>
  
  <entry>
    <title>çœ‹ä¸è§çš„æ§åˆ¶æµ</title>
    <link href="https://waynexia.github.io/2022/12/async-cancellation-zh/"/>
    <id>https://waynexia.github.io/2022/12/async-cancellation-zh/</id>
    <published>2022-12-04T16:06:20.000Z</published>
    <updated>2023-11-23T08:35:22.624Z</updated>
    
    <content type="html"><![CDATA[<h1 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h1><p>è¿™ç¯‡åšå®¢ä¼šè®²ä¸€ä¸ªåœ¨<a target="_blank" rel="noopener" href="https://github.com/GreptimeTeam/greptimedb">GreptimeDB</a>ä¸­é‡åˆ°çš„â€œå¥‡æ€ªâ€çš„<a target="_blank" rel="noopener" href="https://github.com/GreptimeTeam/greptimedb/issues/350">é—®é¢˜</a>ã€‚å…ˆå‰§é€ä¸€ä¸‹æ˜¯å…³äºâ€async cancellationâ€çš„ã€‚</p><p>å…ˆæè¿°ä¸€ä¸ªç®€åŒ–çš„åœºæ™¯ï¼Œæˆ‘ä»¬åœ¨ä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„æµ‹è¯•ä¸­å‘ç°äº†å…ƒä¿¡æ¯æŸåçš„é—®é¢˜ï¼Œæœ‰ä¸€ä¸ªåº”è¯¥å•è°ƒé€’å¢çš„åºåˆ—å·é‡å¤äº†ã€‚å®ƒçš„æ›´æ–°é€»è¾‘éå¸¸ç®€å•ï¼šä»ä¸€ä¸ªåŸå­å˜é‡ä¸­è¯»å–å½“å‰å€¼ï¼Œå°†æ–°å€¼å†™å…¥æ–‡ä»¶é‡Œç„¶åæ›´æ–°è¿™ä¸ªåŸå­å˜é‡ã€‚æ•´ä¸ªæµç¨‹éƒ½æ˜¯ä¸²è¡ŒåŒ–çš„ï¼ˆ<code>file</code>æ˜¯ä¸€ä¸ªç‹¬å å¼•ç”¨ï¼‰ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">update_metadata</span></span>(file: &amp;<span class="hljs-keyword">mut</span> File, counter: AtomicU64) -&gt; <span class="hljs-built_in">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> next_number = counter.load(Ordering::Relaxed) + <span class="hljs-number">1</span>;<br>    persist_number(file, number).<span class="hljs-keyword">await</span>?;<br>    counter.fetch_add(<span class="hljs-number">1</span>, Ordering::Relaxed);<br>&#125;<br></code></pre></td></tr></table></figure><p>å‡ºäºä¸€äº›åŸå› ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨è¿™é‡Œä½¿ç”¨<code>fetch_add</code>ï¼ˆå³ä½¿å®ƒå¯ä»¥ç”¨ï¼Œå¹¶ä¸”å¦‚æœç”¨äº†å°±æ²¡è¿™å›å„¿äº‹äº†ğŸ¤ªï¼‰ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå½“è¿™ä¸ªæµç¨‹åœ¨ä¸­é—´å‡ºç°é”™è¯¯çš„æ—¶å€™æˆ‘ä»¬ä¸å¸Œæœ›æ›´æ–°å†…å­˜ä¸­çš„è®¡æ•°å™¨ï¼Œæ¯”å¦‚<code>persist_number()</code>å†™å…¥æ–‡ä»¶æ—¶å¤±è´¥å°±ä¼šä»<code>?</code>æå‰è¿”å›ã€‚æˆ‘ä»¬æ¸…æ¥šåœ°çŸ¥é“è¿™é‡Œæœ‰äº›å‡½æ•°ä¼šå¤±è´¥ï¼Œå¹¶ä¸”åœ¨å¤±è´¥çš„æ—¶å€™ä¼šææ—©ç»“æŸæ‰§è¡Œæ¥ä¼ æ’­é”™è¯¯ï¼Œæ‰€ä»¥ç¼–ç çš„æ—¶å€™æœ‰æ³¨æ„è¿™äº›é—®é¢˜ã€‚</p><p>ä½†æ˜¯åˆ°äº†<code>.await</code>è¿™é‡Œäº‹æƒ…å°±å˜å¾—å¥‡å¦™äº†èµ·æ¥ï¼Œå› ä¸ºasync cancellationå¸¦æ¥äº†ä¸€ä¸ªéšè—çš„æ§åˆ¶æµã€‚</p><h1 id="Async-Cancellation"><a href="#Async-Cancellation" class="headerlink" title="Async Cancellation"></a>Async Cancellation</h1><h2 id="async-task-and-runtime"><a href="#async-task-and-runtime" class="headerlink" title="async task and runtime"></a>async task and runtime</h2><p>å¦‚æœè¿™æ—¶å€™ä½ å·²ç»çŒœåˆ°äº†æ˜¯è°å¹²çš„å¥½äº‹ï¼Œå¯ä»¥è·³è¿‡è¿™ä¸€ç« èŠ‚ã€‚æˆ–è€…è®©æˆ‘ä»ä¸€äº›ä¼ªä»£ç å¼€å§‹è§£é‡Šåœ¨â€await pointâ€é‚£é‡Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»¥åŠruntimeæ˜¯å¦‚ä½•å‚ä¸å…¶ä¸­çš„ã€‚é¦–å…ˆæ˜¯<code>poll_future</code>ï¼Œæ¥è‡ªå®šä¹‰åœ¨<code>Future</code>çš„<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/future/trait.Future.html#tymethod.poll"><code>poll</code></a>æ–¹æ³•ã€‚æˆ‘ä»¬å†™çš„å¼‚æ­¥æ–¹æ³•éƒ½ä¼šè¢«è½¬åŒ–æˆç±»ä¼¼è¿™æ ·å­çš„ä¸€ä¸ªåŒ¿åçš„<code>Future</code>å®ç°ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">poll_future</span></span>() -&gt; FutureOutput &#123;<br>    <span class="hljs-keyword">match</span> status_of_the_task &#123;<br>        Ready(output) =&gt; &#123;<br>            <span class="hljs-comment">// the task is finished, and we have it output.</span><br>            <span class="hljs-comment">// some logic</span><br>            <span class="hljs-keyword">return</span> our_output;<br>        &#125;,<br>        Pending =&gt; &#123;<br>            <span class="hljs-comment">// it is not ready, we don&#x27;t have the output.</span><br>            <span class="hljs-comment">// thus we cannot make progress and need to wait</span><br>            <span class="hljs-keyword">return</span> Pending;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>async</code>å—é€šå¸¸åŒ…å«å…¶ä»–çš„å¼‚æ­¥æ–¹æ³•ï¼Œæ¯”å¦‚<code>update_metadata</code>å’Œ<code>persist_number</code>ã€‚è¿™é‡ŒæŠŠ<code>persist_number</code>ç§°ä¸º<code>update_metadata</code>çš„å­å¼‚æ­¥ä»»åŠ¡ã€‚æ¯ä¸ª<code>.await</code>éƒ½ä¼šè¢«å±•å¼€æˆç±»ä¼¼<code>poll_future</code>çš„ä¸œè¥¿ï¼Œç­‰å¾…å­ä»»åŠ¡çš„ç»“æœå¹¶ç»§ç»­æ‰§è¡Œã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­å°±æ˜¯ç­‰å¾…<code>persist_number</code>çš„ç»“æœè¿”å›<code>Ready</code>å†æ›´æ–°è®¡æ•°å™¨ï¼Œå¦åˆ™ä¸æ›´æ–°ã€‚</p><p>ç¬¬äºŒæ®µä¼ªä»£ç æ˜¯ä¸€ä¸ªç®€åŒ–çš„runtimeï¼Œå®ƒè´Ÿè´£è½®è¯¢(poll)å¼‚æ­¥ä»»åŠ¡ç›´åˆ°å®ƒä»¬å®Œæˆï¼ˆä¸è¿‡è€ƒè™‘åˆ°æ¥ä¸‹æ¥è¦è¯´çš„ï¼Œâ€œç›´åˆ°â€¦â€¦å®Œæˆâ€å¯èƒ½ä¸æ˜¯ä¸€ä¸ªåˆé€‚çš„è¡¨è¿°ï¼‰ã€‚åœ¨GreptimeDBä¸­ä½¿ç”¨<a target="_blank" rel="noopener" href="https://docs.rs/tokio/latest/tokio/"><code>tokio</code></a>ä½œä¸ºruntimeã€‚ç°åœ¨çš„å¼‚æ­¥runtimeå¯èƒ½æœ‰å¾ˆå¤šç‰¹æ€§å’ŒåŠŸèƒ½ï¼Œä½†æ˜¯æœ€åŸºç¡€çš„ä¸€ä¸ªå°±æ˜¯è½®è¯¢è¿™äº›ä»»åŠ¡ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">runtime</span></span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-keyword">let</span> future_tasks: <span class="hljs-built_in">Vec</span>&lt;Task&gt; = <span class="hljs-keyword">self</span>.get_tasks();<br>        <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks &#123;<br>            <span class="hljs-keyword">match</span> task.poll_future()&#123;<br>                Ready(output) =&gt; &#123;<br>                    <span class="hljs-comment">// this task is finished. wake it with the result</span><br>                    task.wake(output);<br>                &#125;,<br>                Pending =&gt; &#123;<br>                    <span class="hljs-comment">// this task needs some time to run. poll it later</span><br>                    <span class="hljs-keyword">self</span>.poll_later(task);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™å°±æ˜¯ä¸€ä¸ªéå¸¸ç®€åŒ–çš„futureå’Œruntimeçš„æ¨¡å‹ï¼Œå°±æ˜¯æŠŠä¸Šé¢çš„ä¸¤ä¸ªæ–¹æ³•ç»“åˆèµ·æ¥ã€‚ä»æŸç§æ–¹é¢æ¥è¯´ï¼Œå®ƒä»¬ä¸è¿‡å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼ˆçœŸå®çš„runtimeéå¸¸å¤æ‚ï¼Œè¿™é‡Œä¸ºäº†å†…å®¹é›†ä¸­çœç•¥äº†å¾ˆå¤šä¸œè¥¿ï¼‰ã€‚éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œæ¯ä¸ª<code>.await</code>éƒ½ä»£è¡¨ç€ä¸€ä¸ªæˆ–è€…å¤šä¸ªå‡½æ•°è°ƒç”¨(è°ƒç”¨åˆ°<code>poll()</code>æˆ–è€…è¯´æ˜¯<code>poll_future()</code>çš„)ã€‚è¿™å°±æ˜¯æ ‡é¢˜æ‰€è°“çš„â€œéšè—çš„æ§åˆ¶æµâ€ï¼Œä»¥åŠcancellationå‘ç”Ÿçš„åœ°æ–¹ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">run</span></span>() &#123;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> Ready(result) = task.poll() &#123;<br>            <span class="hljs-keyword">break</span> result;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¼„æ˜ç™½åŸç†å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯ï¼ˆå¯¹æˆ‘æ¥è¯´ï¼‰èƒ½å¤Ÿæƒ³åˆ°å¹¶ä¸è‡ªç„¶ã€‚åœ¨æŠŠå…¶ä»–é—®é¢˜éƒ½æ’é™¤æ‰ä¹‹åæˆ‘ä¸€ç›´ç›¯ç€å’Œç¬¬ä¸€ä¸ªç¤ºä¾‹é‡Œé¢å·®ä¸å¤šé•¿çš„è¿™å‡ è¡Œï¼ŒçŸ¥é“é—®é¢˜å°±å‘ç”Ÿåœ¨è¿™é‡Œï¼Œåœ¨è¿™ä¸ª<code>.await</code>ä¸Šã€‚ä¹Ÿä¸çŸ¥é“æ˜¯å¤ªå¤šæ¬¡æˆåŠŸçš„å¼‚æ­¥å‡½æ•°è°ƒç”¨éº»ç—¹äº†æ³¨æ„è¿˜æ˜¯æˆ‘çš„å¿ƒæ™ºæ¨¡å‹ä¸­æ²¡æœ‰æŠŠè¿™ä¸¤ç‚¹è”ç³»èµ·æ¥ï¼Œæœ¬åƒåœ¾èŠ±äº†ä¸€æ•´æ™šæ¥æ€€ç–‘äººç”Ÿã€‚</p><h2 id="cancellation"><a href="#cancellation" class="headerlink" title="cancellation"></a>cancellation</h2><p>ç›®å‰ä¸ºæ­¢çš„å†…å®¹æ˜¯é—®é¢˜å¤ç›˜çš„æ ‡å‡†æµç¨‹ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥æƒ³å±•å¼€è®¨è®ºä¸€ä¸‹cancellationï¼Œå®ƒæ˜¯ä¸runtimeçš„è¡Œä¸ºç›¸å…³çš„ã€‚è™½ç„¶rustä¸­çš„å¾ˆå¤šruntimeéƒ½æœ‰ç±»ä¼¼çš„è¡Œä¸ºï¼Œä½†æ˜¯è¿™ä¸æ˜¯ä¸€ä¸ªå¿…é¡»çš„ç‰¹æ€§ï¼Œæ¯”å¦‚æˆ‘çš„è¿™ä¸ª<a target="_blank" rel="noopener" href="https://github.com/waynexia/texn">ç©å…·runtime</a>å°±ä¸æ”¯æŒcancellationã€‚æˆ‘ä¼šä»¥tokioä¸ºä¾‹ï¼Œå› ä¸ºè¿™æ˜¯è¿™ä¸ªé—®é¢˜å‘ç”Ÿçš„åœ°æ–¹ã€‚å…¶ä»–çš„runtimeå¯èƒ½ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚</p><p>åœ¨tokioä¸­ï¼Œå¯ä»¥ä½¿ç”¨<a target="_blank" rel="noopener" href="https://docs.rs/tokio/latest/tokio/task/struct.JoinHandle.html#method.abort"><code>JoinHandle::abort()</code></a>æ¥å–æ¶ˆä¸€ä¸ªtaskã€‚taskç»“æ„ä¸­æœ‰ä¸€ä¸ªâ€œcancel marker bitâ€æ¥è·Ÿè¸ªä¸€ä¸ªä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆäº†ã€‚å¦‚æœå®ƒå‘ç°ä¸€ä¸ªtaskè¢«å–æ¶ˆäº†ï¼Œå°±ä¼šåœæ­¢æ‰§è¡Œè¿™ä¸ªtaskã€‚(ä»£ç åœ¨<a target="_blank" rel="noopener" href="https://github.com/tokio-rs/tokio/blob/00bf5ee8a855c28324fa4dff3abf11ba9f562a85/tokio/src/runtime/task/state.rs#L283-L291">è¿™é‡Œ</a>ï¼‰</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// If the task is running, we mark it as cancelled. The thread</span><br><span class="hljs-comment">// running the task will notice the cancelled bit when it</span><br><span class="hljs-comment">// stops polling and it will kill the task.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// The set_notified() call is not strictly necessary but it will</span><br><span class="hljs-comment">// in some cases let a wake_by_ref call return without having</span><br><span class="hljs-comment">// to perform a compare_exchange.</span><br>snapshot.set_notified();<br>snapshot.set_cancelled();<br></code></pre></td></tr></table></figure><p>async cancellationèƒŒåçš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯runtimeæ”¾å¼ƒäº†ç»§ç»­è½®è¯¢ä½ çš„taskï¼Œå°±å’Œ<code>?</code>å·®ä¸å¤šã€‚æŸç§ç¨‹åº¦ä¸Šå¯èƒ½æ›´æ£˜æ‰‹ä¸€ç‚¹ï¼Œå› ä¸ºæˆ‘ä»¬ä¸èƒ½åƒ<code>Err</code>é‚£æ ·å¤„ç†è¿™ä¸ªcancellationã€‚ä¸è¿‡è¿™ä»£è¡¨æˆ‘ä»¬éœ€è¦è€ƒè™‘æ¯ä¸€ä¸ª<code>.await</code>éƒ½æœ‰å¯èƒ½éšæ—¶è¢«cancelæ‰å—ï¼Ÿè¿™ä¹Ÿå¤ªéº»çƒ¦äº†ã€‚ä»¥æœ¬æ–‡çš„è¿™ä¸ªmetadataæ›´æ–°çš„æƒ…å†µä¸ºä¾‹ï¼Œå¦‚æœæŠŠcancelçº³å…¥è€ƒè™‘èŒƒå›´ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å’Œå†…å­˜ä¸­çš„çŠ¶æ€ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°±è¦å›æ»šæŒä¹…åŒ–çš„æ”¹åŠ¨ç­‰ç­‰ç­‰ç­‰ğŸ«  åæ¶ˆæ¯æ˜¯ï¼Œåœ¨æŸäº›æ–¹é¢ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œruntimeå¯ä»¥å¯¹ä½ çš„futureåšä»»ä½•äº‹æƒ…ã€‚ä¸è¿‡å¥½åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å®ƒä»¬éƒ½è¿˜æ˜¯å¾ˆéµå®ˆè§„çŸ©çš„ã€‚</p><h1 id="Runtime-Behavior"><a href="#Runtime-Behavior" class="headerlink" title="Runtime Behavior"></a>Runtime Behavior</h1><p>è¿™ä¸€å°èŠ‚æ‰“ç®—è®¨è®ºä¸€ä¸‹æˆ‘æ‰€æœŸæœ›çš„runtimeçš„è¡Œä¸ºï¼Œä»¥åŠæœ‰å“ªäº›æ˜¯æˆ‘ä»¬ç°åœ¨å·²ç»å¯ä»¥ç”¨å¾—ä¸Šçš„ã€‚</p><h2 id="marker-trait"><a href="#marker-trait" class="headerlink" title="marker trait"></a>marker trait</h2><p>é¦–å…ˆè‡ªç„¶å¸Œæœ›runtimeä¸è¦æ— æ¡ä»¶åœ°å–æ¶ˆæˆ‘çš„taskï¼Œè€Œæ˜¯å°è¯•é€šè¿‡ç±»å‹ç³»ç»Ÿæ¥å˜å¾—æ›´å‹å¥½ï¼Œæ¯”å¦‚å€ŸåŠ©ç±»ä¼¼<code>CancelSafe</code>çš„marker trait ã€‚å¯¹äºcancellation safetyè¿™ä¸ªè¯ï¼Œtokioåœ¨å®ƒçš„<a target="_blank" rel="noopener" href="https://docs.rs/tokio/latest/tokio/macro.select.html#cancellation-safety">æ–‡æ¡£</a>ä¸­æœ‰æåˆ°ï¼š</p><blockquote><p>To determine whether your own methods are cancellation safe, look for the location of uses of  <code>.await</code> . This is because when an asynchronous method is cancelled, that always happens at an  <code>.await</code> . If your function behaves correctly even if it is restarted while waiting at an  <code>.await</code> , then it is cancellation safe.  </p></blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯ç”¨æ¥æè¿°ä¸€ä¸ªtaskæ˜¯å¦å¯ä»¥å®‰å…¨åœ°è¢«å–æ¶ˆæ‰ã€‚è¿™è‚¯å®šæ˜¯ä¸€ä¸ªasync taskçš„å±æ€§ä¹‹ä¸€ã€‚åœ¨ä¸Šé¢çš„é“¾æ¥ä¸­tokioç»´æŠ¤äº†ä¸€ä¸ªå¾ˆé•¿çš„åˆ—è¡¨ï¼Œåˆ—å‡ºäº†å“ªäº›æ˜¯å®‰å…¨çš„ä»¥åŠå“ªäº›æ˜¯ä¸å®‰å…¨çš„ã€‚çœ‹èµ·æ¥è¿™å’Œ<a href="jhttps://doc.rust-lang.org/std/panic/trait.UnwindSafe.html"><code>UnwindSafe</code></a>è¿™ä¸ªmarker traitå¾ˆåƒã€‚ä¸¤è€…éƒ½æ˜¯æè¿°â€œè¿™ç§æ§åˆ¶æµç¨‹å¹¶ä¸æ€»æ˜¯è¢«é¢„æ–™åˆ°çš„â€ï¼Œå¹¶ä¸”â€œæœ‰å¯èƒ½å¯¼è‡´ä¸€äº›å¾®å¦™çš„bugâ€çš„è¿™æ ·ä¸€ç§å±æ€§ã€‚</p><p>å¦‚æœæœ‰è¿™æ ·ä¸€ä¸ª<code>CancelSafe</code>çš„traitï¼Œæˆ‘ä»¬æœ‰é€”å¾„å¯ä»¥å‘Šè¯‰runtimeæˆ‘ä»¬çš„å¼‚æ­¥ä»»åŠ¡æ˜¯å¦å¯ä»¥å®‰å…¨åœ°è¢«å–æ¶ˆæ‰ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ç§æ–¹å¼è®©ç”¨æˆ·æ‰¿è¯ºâ€œcancellingâ€è¿™ä¸ªæ§åˆ¶æµç¨‹æ˜¯è¢«ä»”ç»†å¤„ç†è¿‡çš„ã€‚å¦‚æœå‘ç°æ²¡æœ‰å®ç°è¿™ä¸ªtraitï¼Œé‚£å°±æ„å‘³ç€æˆ‘ä»¬ä¸å¸Œæœ›è¿™ä¸ªtaskè¢«å–æ¶ˆæ‰ï¼Œç®€å•è€Œæ¸…æ™°ã€‚ä»¥<code>timeout()</code>ä¸ºä¾‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// The marker trait</span><br><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">CancelSafe</span></span> &#123;&#125;<br><br><span class="hljs-comment">/// Only cancellable task can be timeout-ed</span><br><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">timeout</span></span>&lt;F&gt;(duration: Duration, future: F) -&gt; Timeout&lt;F&gt; <span class="hljs-keyword">where</span><br>    F: Future + CancelSafe<br>&#123;&#125;<br></code></pre></td></tr></table></figure><h2 id="volunteer-cancel"><a href="#volunteer-cancel" class="headerlink" title="volunteer cancel"></a>volunteer cancel</h2><p>å¦ä¸€ä¸ªæ–¹å¼æ˜¯è®©ä»»åŠ¡è‡ªæ„¿åœ°å–æ¶ˆã€‚å°±åƒKotlinä¸­çš„<a target="_blank" rel="noopener" href="https://kotlinlang.org/docs/cancellation-and-timeouts.html#cancellation-is-cooperative">cooperative cancellation</a>ä¸€æ ·ï¼Œå®ƒæœ‰ä¸€ä¸ª<a target="_blank" rel="noopener" href="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/is-active.html"><code>isActive</code></a>æ–¹æ³•æ¥æ£€æŸ¥ä¸€ä¸ªtaskæ˜¯å¦è¢«å–æ¶ˆæ‰ã€‚è¿™åªæ˜¯ä¸€ä¸ªæ£€æµ‹æ–¹æ³•ï¼Œæ˜¯å¦è¦å–æ¶ˆå®Œå…¨å–å†³äºtaskæœ¬èº«ã€‚ä¸‹é¢æ˜¯Kotlinæ–‡æ¡£ä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œcooperative cancellationå‘ç”Ÿåœ¨ç¬¬5è¡Œã€‚è¿™ç§æ–¹å¼æŠŠâ€œéšè—çš„æ§åˆ¶æµç¨‹â€æ”¾åœ¨äº†æ¡Œé¢ä¸Šï¼Œè®©æˆ‘ä»¬èƒ½ä»¥ä¸€ç§æ›´è‡ªç„¶åœ°æ¥è€ƒè™‘å’Œå¤„ç†calcellationï¼Œå°±åƒ<code>Option</code>æˆ–<code>Result</code>ä¸€æ ·ã€‚</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()<br><span class="hljs-keyword">val</span> job = launch(Dispatchers.Default) &#123;<br>    <span class="hljs-keyword">var</span> nextPrintTime = startTime<br>    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> (isActive) &#123; <span class="hljs-comment">// cancellable computation loop</span><br>        <span class="hljs-comment">// print a message twice a second</span><br>        <span class="hljs-keyword">if</span> (System.currentTimeMillis() &gt;= nextPrintTime) &#123;<br>            println(<span class="hljs-string">&quot;job: I&#x27;m sleeping <span class="hljs-subst">$&#123;i++&#125;</span> ...&quot;</span>)<br>            nextPrintTime += <span class="hljs-number">500L</span><br>        &#125;<br>    &#125;<br>&#125;<br>delay(<span class="hljs-number">1300L</span>) <span class="hljs-comment">// delay a bit</span><br>println(<span class="hljs-string">&quot;main: I&#x27;m tired of waiting!&quot;</span>)<br>job.cancelAndJoin() <span class="hljs-comment">// cancels the job and waits for its completion</span><br>println(<span class="hljs-string">&quot;main: Now I can quit.&quot;</span>)<br></code></pre></td></tr></table></figure><p>å¹¶ä¸”æˆ‘è®¤ä¸ºè¿™ä¹Ÿä¸éš¾å®ç°ï¼ŒTokioç°åœ¨å·²ç»æœ‰äº†<a target="_blank" rel="noopener" href="https://github.com/tokio-rs/tokio/blob/00bf5ee8a855c28324fa4dff3abf11ba9f562a85/tokio/src/runtime/task/state.rs#L41"><code>Cancelled</code> bit</a>å’Œ<a target="_blank" rel="noopener" href="https://docs.rs/tokio-util/latest/tokio_util/sync/struct.CancellationToken.html"><code>CancellationToken</code></a>ã€‚è™½ç„¶çœ‹èµ·æ¥å’ŒæœŸæœ›çš„è¿˜æœ‰ç‚¹ä¸ä¸€æ ·ã€‚æœ€åè¿˜éœ€è¦runtimeæŠŠcancellationçš„æƒåˆ©äº¤ç»™taskã€‚å¦åˆ™æƒ…å†µå¯èƒ½æ²¡æœ‰ä»€ä¹ˆå¤§çš„ä¸åŒã€‚</p><h2 id="explicit-detach"><a href="#explicit-detach" class="headerlink" title="explicit detach"></a>explicit detach</h2><p>ç°åœ¨æ˜¯å¦æœ‰æ‰‹æ®µèƒ½é˜²æ­¢taskè¢«å–æ¶ˆå‘¢ï¼Ÿåœ¨tokioä¸­æˆ‘ä»¬å¯ä»¥é€šè¿‡drop <code>JoinHandle</code>æ¥â€œdetachâ€ä¸€ä¸ªä»»åŠ¡åˆ°åå°ã€‚ä¸€ä¸ªdetach taskæ„å‘³ç€æ²¡æœ‰å‰å°çš„handleæ¥æ§åˆ¶è¿™ä¸ªä»»åŠ¡ï¼Œä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ä¹Ÿå°±ä½¿å¾—å…¶ä»–äººä¸èƒ½åœ¨å¤–é¢å¥—ä¸€å±‚<code>timeout</code>æˆ–<code>select</code>ï¼Œä»è€Œé—´æ¥åœ°ä½¿å®ƒä¸ä¼šè¢«å–æ¶ˆæ‰§è¡Œã€‚å¹¶ä¸”å¼€å¤´æåˆ°çš„é—®é¢˜å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼è§£å†³çš„ã€‚</p><blockquote><p>A  <code>JoinHandle</code>  <em>detaches</em> the associated task when it is dropped, which means that there is no longer any handle to the task, and no way to  <code>join</code> on it.  </p></blockquote><p>ä¸è¿‡è™½ç„¶æœ‰åŠæ³•èƒ½å¤Ÿå®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘åœ¨æƒ³æ˜¯å¦åƒ<a target="_blank" rel="noopener" href="https://docs.rs/glommio/0.7.0/glommio/struct.Task.html#method.detach"><code>glommio&#39;s</code></a>ä¸€æ ·æœ‰ä¸€ä¸ªæ˜¾å¼çš„<code>detach</code>æ–¹æ³•ï¼Œç±»ä¼¼ä¸€ä¸ªä¸è¿”å›<code>JoinHandle</code>çš„<code>spawn</code>æ–¹æ³•ä¼šæ›´å¥½ã€‚ä½†è¿™äº›éƒ½æ˜¯çç¢çš„äº‹æƒ…ï¼Œä¸€ä¸ªruntimeé€šå¸¸ä¸ä¼šå®Œå…¨æ²¡æœ‰ç†ç”±å°±å–æ¶ˆä¸€ä¸ªtaskï¼Œå¹¶ä¸”åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éƒ½æ˜¯å‡ºäºç”¨æˆ·çš„è¦æ±‚ï¼Œåªä¸è¿‡æœ‰æ—¶å€™å¯èƒ½æ²¡æœ‰æ³¨æ„åˆ°ï¼Œå°±åƒ<code>select</code>ä¸­çš„é‚£äº›â€œæœªé€‰ä¸­çš„åˆ†æ”¯â€æˆ–è€…<code>tonic</code>ä¸­è¯·æ±‚å¤„ç†çš„é€»è¾‘é‚£æ ·ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬ç¡®å®šä¸€ä¸ªtaskæ˜¯ä¸èƒ½è¢«å–æ¶ˆçš„è¯ï¼Œæ˜¾å¼åœ°detachå¯èƒ½èƒ½é¢„é˜²æŸäº›æ‚²å‰§çš„å‘ç”Ÿã€‚</p><h1 id="Back-To-The-Problem"><a href="#Back-To-The-Problem" class="headerlink" title="Back To The Problem"></a>Back To The Problem</h1><p>ç›®å‰ä¸ºæ­¢æ‰€æœ‰é—®é¢˜éƒ½æ¸…æ™°äº†ï¼Œè®©æˆ‘ä»¬å¼€å§‹ä¿®å¤è¿™ä¸ªbugå§ï¼é¦–å…ˆï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬çš„futureä¼šè¢«å–æ¶ˆå‘¢ï¼Ÿé€šè¿‡å‡½æ•°è°ƒç”¨é“¾è·¯å¾ˆå®¹æ˜“å°±èƒ½å‘ç°æ•´ä¸ªå¤„ç†è¿‡ç¨‹éƒ½æ˜¯åœ¨<code>tonic</code>çš„è¯·æ±‚æ‰§è¡Œé€»è¾‘ä¸­å°±åœ°æ‰§è¡Œçš„ï¼Œè€Œå¯¹äºä¸€ä¸ªç½‘ç»œè¯·æ±‚æ¥è¯´æœ‰ä¸€ä¸ªè¶…æ—¶è¡Œä¸ºæ˜¯å¾ˆå¸¸è§çš„ã€‚è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯å°†æœåŠ¡å™¨å¤„ç†é€»è¾‘detachåˆ°å¦ä¸€ä¸ªruntimeä¸­ï¼Œä»è€Œé˜²æ­¢å®ƒè¢«å–æ¶ˆã€‚åªéœ€è¦<a target="_blank" rel="noopener" href="https://github.com/GreptimeTeam/greptimedb/pull/376/files#diff-9756dcef86f5ba1d60e01e41bf73c65f72039f9aaa057ffd03f3fc2f7dadfbd0R46-R54">å‡ è¡Œä»£ç </a>å°±èƒ½å®Œæˆã€‚</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-meta">@@ -30,12 +40,24 @@</span> impl BatchHandler &#123;<br>         &#125;<br>         batch_resp.admins.push(admin_resp);<br><br><span class="hljs-deletion">-        for db_req in batch_req.databases &#123;</span><br><span class="hljs-deletion">-            for obj_expr in db_req.exprs &#123;</span><br><span class="hljs-deletion">-                let object_resp = self.query_handler.do_query(obj_expr).await?;</span><br><span class="hljs-deletion">-                db_resp.results.push(object_resp);</span><br><span class="hljs-addition">+        let (tx, rx) = oneshot::channel();</span><br><span class="hljs-addition">+        let query_handler = self.query_handler.clone();</span><br><span class="hljs-addition">+        let _ = self.runtime.spawn(async move &#123;</span><br><span class="hljs-addition">+            // execute request in another runtime to prevent the execution from being cancelled unexpected by tonic runtime.</span><br><span class="hljs-addition">+            let mut result = vec![];</span><br><span class="hljs-addition">+            for db_req in batch_req.databases &#123;</span><br><span class="hljs-addition">+                for obj_expr in db_req.exprs &#123;</span><br><span class="hljs-addition">+                    let object_resp = query_handler.do_query(obj_expr).await;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+                    result.push(object_resp);</span><br><span class="hljs-addition">+                &#125;</span><br>             &#125;<br></code></pre></td></tr></table></figure><p>ç°åœ¨ä¸€åˆ‡æ­£å¸¸äº†ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;The-Problem&quot;&gt;&lt;a href=&quot;#The-Problem&quot; class=&quot;headerlink&quot; title=&quot;The Problem&quot;&gt;&lt;/a&gt;The Problem&lt;/h1&gt;&lt;p&gt;è¿™ç¯‡åšå®¢ä¼šè®²ä¸€ä¸ªåœ¨&lt;a target=&quot;_blank&quot; rel=&quot;n</summary>
      
    
    
    
    
    <category term="Rust" scheme="https://waynexia.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>The Hidden Control Flow</title>
    <link href="https://waynexia.github.io/2022/12/async-cancellation/"/>
    <id>https://waynexia.github.io/2022/12/async-cancellation/</id>
    <published>2022-12-04T16:06:19.000Z</published>
    <updated>2023-11-23T08:35:22.624Z</updated>
    
    <content type="html"><![CDATA[<h1 id="The-Problem"><a href="#The-Problem" class="headerlink" title="The Problem"></a>The Problem</h1><p>This post is talking about a â€œweirdâ€ <a target="_blank" rel="noopener" href="https://github.com/GreptimeTeam/greptimedb/issues/350">problem</a> we encountered in <a target="_blank" rel="noopener" href="https://github.com/GreptimeTeam/greptimedb">GreptimeDB</a>. And, a little spoiler, itâ€™s about the â€œasync cancellationâ€.</p><p>Letâ€™s first describe the (simplified) scenario. We observed metadata corruption in a long-run test. A series number is duplicated, but it should be increased monotonously. The update logic is very straightforward â€“ load value from an in-memory atomic counter, persist the new series number to file, and then update the in-memory counter. The entire procedure is serialized (<code>file</code> is a mutable reference):</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">update_metadata</span></span>(file: &amp;<span class="hljs-keyword">mut</span> File, counter: AtomicU64) -&gt; <span class="hljs-built_in">Result</span>&lt;()&gt; &#123;<br>    <span class="hljs-keyword">let</span> next_number = counter.load(Ordering::Relaxed) + <span class="hljs-number">1</span>;<br>    persist_number(file, number).<span class="hljs-keyword">await</span>?;<br>    counter.fetch_add(<span class="hljs-number">1</span>, Ordering::Relaxed);<br>&#125;<br></code></pre></td></tr></table></figure><p>For some reason, we are not using <code>fetch_add</code> here, though it does work, and if weâ€™ve done so, then the story wonâ€™t happen ğŸ¤ª For example, we donâ€™t want to update the in-memory counter when this procedure fails halfway, like operation <code>persist_number()</code> cannot write to the file. Here the sweet sugar <code>?</code> stands for such a situation. We know clearly that this function call may fail, and if it fails the caller returns early to propagate the error. So we will handle it carefully with that in mind.</p><p>But things become tricky with <code>.await</code>, the hidden control flow comes due to async cancellation.</p><h1 id="Async-Cancellation"><a href="#Async-Cancellation" class="headerlink" title="Async Cancellation"></a>Async Cancellation</h1><h2 id="async-task-and-runtime"><a href="#async-task-and-runtime" class="headerlink" title="async task and runtime"></a>async task and runtime</h2><p>If you have figured out the shape of the â€œcriminalâ€, you may want to skip this section. Instead, Iâ€™ll start with some pseudocode to show what happens in the â€œawait pointâ€, and how it interacts with the runtime. First is <code>poll_future</code>, it comes from the <code>Future</code>â€˜s <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/future/trait.Future.html#tymethod.poll"><code>poll</code></a> function, as every <code>async fn</code>â€˜s we write will be desugared to an anonymous <code>Future</code> implementation.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">poll_future</span></span>() -&gt; FutureOutput &#123;<br>    <span class="hljs-keyword">match</span> status_of_the_task &#123;<br>        Ready(output) =&gt; &#123;<br>            <span class="hljs-comment">// the task is finished, and we have it output.</span><br>            <span class="hljs-comment">// some logic</span><br>            <span class="hljs-keyword">return</span> our_output;<br>        &#125;,<br>        Pending =&gt; &#123;<br>            <span class="hljs-comment">// it is not ready, we don&#x27;t have the output.</span><br>            <span class="hljs-comment">// thus we cannot make progress and need to wait</span><br>            <span class="hljs-keyword">return</span> Pending;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>async</code> block usually contains other async functions, like <code>update_metadata</code> and <code>persist_number</code>. Say <code>persist_number</code> is a sub-async-task of <code>update_metadata</code>. Each <code>.await</code> point will be expanded to something like <code>poll_future</code> â€“ <code>await</code>ing the subtaskâ€™s output and make progress when the subtask is ready. Here we need to wait <code>persist_number</code>â€˜s task returns <code>Ready</code> before we update the counter, otherwise we cannot do it.</p><p>And the second one is a (toy) runtime, which is in response to poll futures delivered to it. In GreptimeDB we use <a target="_blank" rel="noopener" href="https://docs.rs/tokio/latest/tokio/"><code>tokio</code></a> as our runtime. An async runtime may have tons of features and logic, but the most basic one is to poll: as the name tells, keep running unfinished tasks until they finish (but consider the things Iâ€™m going to write later, the â€œuntilâ€ might not be a proper word).</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">runtime</span></span>(&amp;<span class="hljs-keyword">self</span>) &#123;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-keyword">let</span> future_tasks: <span class="hljs-built_in">Vec</span>&lt;Task&gt; = <span class="hljs-keyword">self</span>.get_tasks();<br>        <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> tasks &#123;<br>            <span class="hljs-keyword">match</span> task.poll_future()&#123;<br>                Ready(output) =&gt; &#123;<br>                    <span class="hljs-comment">// this task is finished. wake it with the result</span><br>                    task.wake(output);<br>                &#125;,<br>                Pending =&gt; &#123;<br>                    <span class="hljs-comment">// this task needs some time to run. poll it later</span><br>                    <span class="hljs-keyword">self</span>.poll_later(task);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>That is it, a very minimalist model of future and runtime. Combining these two functions, you will find that in some aspects, it is just a loop (again, Iâ€™ve omitted lots of details to keep tight on the topic; the real world is way more complex). I want to stress the thing that each <code>.await</code> imply one or more function calls (call to <code>poll()</code> or <code>poll_future()</code>). This is the â€œhidden control flowâ€ in the title and the place cancellation takes effort.</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">run</span></span>() &#123;<br>    <span class="hljs-keyword">loop</span> &#123;<br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> Ready(result) = task.poll() &#123;<br>            <span class="hljs-keyword">break</span> result;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Know it is not hard, but thinking about it is not easy (at least for me). Iâ€™ve stared at these lines for minutes after I narrow the scope down to as simple as the first code snippet. I know the problem is definitely in the <code>.await</code>. But donâ€™t know whether too many successful async calls have numbed me or my mental model hasnâ€™t linked these two points. The bulky garbage, me, spent a whole sleepless night doubting life and the world.</p><h2 id="cancellation"><a href="#cancellation" class="headerlink" title="cancellation"></a>cancellation</h2><p>So far is the standard part. We will then talk about cancellation, which is runtime-dependent. Though many runtimes in rust have similar behavior, this is not a required feature, i.e., a runtime can not support cancellation at all like <a target="_blank" rel="noopener" href="https://github.com/waynexia/texn">this toy</a>. And Iâ€™ll take tokio as an example because the story happens there. Other runtimes may be similar.</p><p>In tokio, one can use <a target="_blank" rel="noopener" href="https://docs.rs/tokio/latest/tokio/task/struct.JoinHandle.html#method.abort"><code>JoinHandle::abort()</code></a> to cancel a task. Tasks have a â€œcancel marker bitâ€ tracks whether itâ€™s cancelled. And if the runtime finds a task is cancelled, it will kill that task (code from <a target="_blank" rel="noopener" href="https://github.com/tokio-rs/tokio/blob/00bf5ee8a855c28324fa4dff3abf11ba9f562a85/tokio/src/runtime/task/state.rs#L283-L291">here</a>):</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// If the task is running, we mark it as cancelled. The thread</span><br><span class="hljs-comment">// running the task will notice the cancelled bit when it</span><br><span class="hljs-comment">// stops polling and it will kill the task.</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">// The set_notified() call is not strictly necessary but it will</span><br><span class="hljs-comment">// in some cases let a wake_by_ref call return without having</span><br><span class="hljs-comment">// to perform a compare_exchange.</span><br>snapshot.set_notified();<br>snapshot.set_cancelled();<br></code></pre></td></tr></table></figure><p>The theory behind async cancellation is also elementary. Itâ€™s just the runtime gives up to keep polling your task when itâ€™s not yet finished, just like <code>?</code> or even tougher because we cannot catch this cancellation like <code>Err</code>. But does it means that we need to take care of every single <code>.await</code>? It would be very annoying. Take this metadata updating as an example. If we have to consider this, we need to check if the file is consistent with the memory state and revert the persisted change if found inconsistency. Wellâ€¦ ğŸ«  In some aspects, yes. The runtime can literally do anything to your future. But the good thing is that most of them are disciplined.</p><h1 id="Runtime-Behavior"><a href="#Runtime-Behavior" class="headerlink" title="Runtime Behavior"></a>Runtime Behavior</h1><p>This section will discuss what I would expect from a runtime and what we can get for now.</p><h2 id="marker-trait"><a href="#marker-trait" class="headerlink" title="marker trait"></a>marker trait</h2><p>I want the runtime not to cancel my task unconditionally and turn to the type system for help. This is wondering if there is a marker trait like <code>CancelSafe</code>. For the word cancellation safety, tokio has said about it in its <a target="_blank" rel="noopener" href="https://docs.rs/tokio/latest/tokio/macro.select.html#cancellation-safety">documentation</a>:</p><blockquote><p>To determine whether your own methods are cancellation safe, look for the location of uses of  <code>.await</code> . This is because when an asynchronous method is cancelled, that always happens at an  <code>.await</code> . If your function behaves correctly even if it is restarted while waiting at an  <code>.await</code> , then it is cancellation safe.  </p></blockquote><p>That is, whether a task is safe to be cancelled. This is definitely an â€œattributeâ€ of an async task. You can find that tokio has a long list of what is safe and what isnâ€™t in the library from the above link. And, in some ways, I think itâ€™s just like the <a href="jhttps://doc.rust-lang.org/std/panic/trait.UnwindSafe.html"><code>UnwindSafe</code></a> marker. Both are â€œ<em>this sort of control flow is not always anticipated</em>â€œ and â€œ<em>has the possibility of causing subtle bugs</em>â€œ.</p><p>With such a <code>CancelSafe</code> trait, we can tell the runtime if our spawned future is ok to be cancelled, and we promise the â€œcancellingâ€ control flow is carefully handled. And if without this, means we donâ€™t want the task to be cancelled. Simple and clear. This is also an approach for the runtimes to require their users (like you and me) to check if their tasks are able to be cancelled. Take <code>timeout()</code> as an example:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">/// The marker trait</span><br><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">CancelSafe</span></span> &#123;&#125;<br><br><span class="hljs-comment">/// Only cancellable task can be timeout-ed</span><br><span class="hljs-keyword">pub</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">timeout</span></span>&lt;F&gt;(duration: Duration, future: F) -&gt; Timeout&lt;F&gt; <span class="hljs-keyword">where</span><br>    F: Future + CancelSafe<br>&#123;&#125;<br></code></pre></td></tr></table></figure><h2 id="volunteer-cancel"><a href="#volunteer-cancel" class="headerlink" title="volunteer cancel"></a>volunteer cancel</h2><p>Another approach is to cancel voluntarily. Like the <a target="_blank" rel="noopener" href="https://kotlinlang.org/docs/cancellation-and-timeouts.html#cancellation-is-cooperative">cooperative cancellation in Kotlin</a>, it has an <a target="_blank" rel="noopener" href="https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/is-active.html"><code>isActive</code></a> method for a task to check if it is cancelled. And this is only a tester method, to cancel or not is fully dependent on the task itself. I paste an example from Kotlinâ€™s document below, the â€œcooperative cancellationâ€ happens in line 5. This way brings the â€œhidden control flowâ€ on the table and makes it more natural to consider and handle the cancellation just like <code>Option</code> or <code>Result</code>.</p><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()<br><span class="hljs-keyword">val</span> job = launch(Dispatchers.Default) &#123;<br>    <span class="hljs-keyword">var</span> nextPrintTime = startTime<br>    <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">while</span> (isActive) &#123; <span class="hljs-comment">// cancellable computation loop</span><br>        <span class="hljs-comment">// print a message twice a second</span><br>        <span class="hljs-keyword">if</span> (System.currentTimeMillis() &gt;= nextPrintTime) &#123;<br>            println(<span class="hljs-string">&quot;job: I&#x27;m sleeping <span class="hljs-subst">$&#123;i++&#125;</span> ...&quot;</span>)<br>            nextPrintTime += <span class="hljs-number">500L</span><br>        &#125;<br>    &#125;<br>&#125;<br>delay(<span class="hljs-number">1300L</span>) <span class="hljs-comment">// delay a bit</span><br>println(<span class="hljs-string">&quot;main: I&#x27;m tired of waiting!&quot;</span>)<br>job.cancelAndJoin() <span class="hljs-comment">// cancels the job and waits for its completion</span><br>println(<span class="hljs-string">&quot;main: Now I can quit.&quot;</span>)<br></code></pre></td></tr></table></figure><p>And this is not hard to achieve in my opinion. Tokio already has the <a target="_blank" rel="noopener" href="https://github.com/tokio-rs/tokio/blob/00bf5ee8a855c28324fa4dff3abf11ba9f562a85/tokio/src/runtime/task/state.rs#L41"><code>Cancelled</code> bit</a> and <a target="_blank" rel="noopener" href="https://docs.rs/tokio-util/latest/tokio_util/sync/struct.CancellationToken.html"><code>CancellationToken</code></a>. But they look a bit different than what I describe. And after all of these, we need runtime to give the cancellation right back to our task. Or the situation might not have big difference.</p><h2 id="explicit-detach"><a href="#explicit-detach" class="headerlink" title="explicit detach"></a>explicit detach</h2><p>Can we force the runtime not to cancel our tasks at present? In tokio we can â€œdetachâ€ a task to the background by dropping the <code>JoinHandle</code>. A detached task means there is no foreground handle to the spawned task, and in some aspect, others cannot wrap a <code>timeout</code> or <code>select</code> over it, making it un-cancellable. And the problem in the very beginning is solved in this way.</p><blockquote><p>A  <code>JoinHandle</code>  <em>detaches</em> the associated task when it is dropped, which means that there is no longer any handle to the task, and no way to  <code>join</code> on it.  </p></blockquote><p>Though there is the functionality, I would wonder if itâ€™s better to have an explicit <code>detach</code> method like <a target="_blank" rel="noopener" href="https://docs.rs/glommio/0.7.0/glommio/struct.Task.html#method.detach"><code>glommio&#39;s</code></a>, or even a <code>detach</code> method in the runtime like <code>spawn</code>, which doesnâ€™t return the <code>JoinHandle</code>. But these are trifles. A runtime usually wonâ€™t cancel a task for no reason, and in most cases, itâ€™s required by the users. But sometimes you havenâ€™t noticed that, like those â€œunselect branchesâ€ in <code>select</code>, or the logic in <code>tonic</code>â€˜s request handler. And if we are sure that a task is ready for cancellation, explicit detach may prevent it from tragedy sometime.</p><h1 id="Back-To-The-Problem"><a href="#Back-To-The-Problem" class="headerlink" title="Back To The Problem"></a>Back To The Problem</h1><p>So far everything is clear. Letâ€™s start to wipe out this bug! First is, why our future is cancelled? Through the function call graph we can easily find the entire process procedure is executed in-place in <code>tonic</code>â€˜s request licensing runtime, and itâ€™s common for an internet request to have a timeout behavior. And the solution is also simple, just detaching the server processing logic into another runtime to prevent it from cancelled with the request. Only <a target="_blank" rel="noopener" href="https://github.com/GreptimeTeam/greptimedb/pull/376/files#diff-9756dcef86f5ba1d60e01e41bf73c65f72039f9aaa057ffd03f3fc2f7dadfbd0R46-R54">a few lines</a>:</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-meta">@@ -30,12 +40,24 @@</span> impl BatchHandler &#123;<br>         &#125;<br>         batch_resp.admins.push(admin_resp);<br><br><span class="hljs-deletion">-        for db_req in batch_req.databases &#123;</span><br><span class="hljs-deletion">-            for obj_expr in db_req.exprs &#123;</span><br><span class="hljs-deletion">-                let object_resp = self.query_handler.do_query(obj_expr).await?;</span><br><span class="hljs-deletion">-                db_resp.results.push(object_resp);</span><br><span class="hljs-addition">+        let (tx, rx) = oneshot::channel();</span><br><span class="hljs-addition">+        let query_handler = self.query_handler.clone();</span><br><span class="hljs-addition">+        let _ = self.runtime.spawn(async move &#123;</span><br><span class="hljs-addition">+            // execute request in another runtime to prevent the execution from being cancelled unexpected by tonic runtime.</span><br><span class="hljs-addition">+            let mut result = vec![];</span><br><span class="hljs-addition">+            for db_req in batch_req.databases &#123;</span><br><span class="hljs-addition">+                for obj_expr in db_req.exprs &#123;</span><br><span class="hljs-addition">+                    let object_resp = query_handler.do_query(obj_expr).await;</span><br><span class="hljs-addition">+</span><br><span class="hljs-addition">+                    result.push(object_resp);</span><br><span class="hljs-addition">+                &#125;</span><br>             &#125;<br></code></pre></td></tr></table></figure><p>Now all fine.</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;The-Problem&quot;&gt;&lt;a href=&quot;#The-Problem&quot; class=&quot;headerlink&quot; title=&quot;The Problem&quot;&gt;&lt;/a&gt;The Problem&lt;/h1&gt;&lt;p&gt;This post is talking about a â€œweir</summary>
      
    
    
    
    
    <category term="Rust" scheme="https://waynexia.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>Paper Reading: CURP protocol</title>
    <link href="https://waynexia.github.io/2022/09/curp-notes/"/>
    <id>https://waynexia.github.io/2022/09/curp-notes/</id>
    <published>2022-09-18T17:58:33.000Z</published>
    <updated>2023-11-23T08:35:22.624Z</updated>
    
    <content type="html"><![CDATA[<p>è®ºæ–‡åå­—æ˜¯ã€ŠExploiting Commutativity For Practical Fast Replicationã€‹</p><p>CURPå…¨ç§°Consistent Unordered Replication Protocolï¼Œä¸»è¦æ˜¯åˆ©ç”¨æ“ä½œä¹‹é—´çš„ç›¸å…³æ€§ï¼ˆCommutativeï¼‰æ¥å®ç°å±€éƒ¨ä¹±åºæäº¤çš„åè®®ã€‚è¿™é‡ŒCommutativeæŒ‡çš„æ˜¯ä¸åŒæ“ä½œè®°å½•ä¹‹é—´æ˜¯å¦å¯ä»¥äº¤æ¢æ‰§è¡Œé¡ºåºè€Œä¸å½±å“æœ€ç»ˆç»“æœï¼Œæ¯”å¦‚<code>x=1</code>ã€<code>y=2</code>å’Œ<code>x=3</code>ä¸‰æ¡è®°å½•ä¸­<code>y=2</code>ä¸å…¶ä»–ä¸¤æ¡éƒ½æ˜¯æ— å…³çš„ï¼Œæ»¡è¶³Commutativeå¯ä»¥ä¹±åºæ‰§è¡Œï¼Œè€Œ<code>x=1</code>ä¸<code>x=3</code>ä¹‹é—´æœ‰å…³ç³»ï¼Œéœ€è¦ä¸€ä¸ªç¡®å®šçš„æ‰§è¡Œé¡ºåºã€‚</p><p>ç›¸æ¯”äºå…¶ä»–çš„å¤åˆ¶åè®®ï¼ŒCURPçš„ç‰¹ç‚¹æ˜¯å¯¹äºæ»¡è¶³Commutativeçš„è®°å½•å¯ä»¥ä»¥1 RTTçš„å»¶æ—¶å®Œæˆæäº¤ã€‚</p><h1 id="é›†ç¾¤è§’è‰²"><a href="#é›†ç¾¤è§’è‰²" class="headerlink" title="é›†ç¾¤è§’è‰²"></a>é›†ç¾¤è§’è‰²</h1><p>é™¤äº†å¸¸è§çš„<code>Client</code>ï¼Œ<code>Leader</code>ï¼Œ<code>Backup</code>ä¹‹å¤–CRUPä¸­è¿˜å¼•å…¥äº†ä¸€ä¸ªæ–°çš„<code>Witness</code>è§’è‰²ã€‚ç®€å•æ¦‚æ‹¬ä¸€ä¸‹è¿™äº›è§’è‰²ï¼š</p><ul><li><code>Client</code><ul><li>ä¸<code>Witness</code>å’Œ<code>Leader</code>äº¤äº’ï¼Œå¯¹<code>Witness</code>çš„é€šä¿¡æ˜¯å¹¿æ’­çš„å½¢å¼(åŒæ—¶ä¸æ‰€æœ‰<code>Witness</code>é€šä¿¡)  </li><li>è‡ªå·±ä¹Ÿæœ‰ä¸€å®šçš„çŠ¶æ€ï¼Œä¸»è¦æ˜¯å…³äºæ“ä½œçš„æ‰§è¡Œæƒ…å†µçš„ã€‚</li></ul></li><li><code>Witness</code>  <ul><li>CURPåè®®å®šä¹‰çš„è§’è‰²ï¼Œå­˜åœ¨å¤æ•°ä¸ªå®ä¾‹ï¼Œä¸”å®ä¾‹ä¹‹é—´å¯¹ç­‰  </li><li>æœ‰å­˜å‚¨èƒ½åŠ›æ¥ä¸´æ—¶å­˜å‚¨è¿‘æœŸçš„æ“ä½œè®°å½•ï¼Œä½†ä¸éœ€è¦ç»´æŠ¤çŠ¶æ€æœºï¼ˆæ“ä½œç»“æœï¼‰ï¼Œå°±æ˜¯ä¸€ä¸ªWAL</li><li>éœ€è¦æ„ŸçŸ¥å…·ä½“çš„æ“ä½œå†…å®¹å¹¶åˆ¤æ–­æ“ä½œä¹‹é—´æ˜¯å¦æœ‰å¯äº¤æ¢æ€§(commutative)  </li><li>å®ä¾‹é—´ç‹¬ç«‹è¿ä½œåŠå†³ç­–ï¼Œä¹Ÿç‹¬ç«‹äº<code>Leader</code>/<code>Backup</code>ã€‚</li></ul></li><li><code>Leader</code><ul><li>é›†ç¾¤ä¸»èŠ‚ç‚¹ï¼Œæœ‰å…¶ä»–ä¸»å¤‡åè®®ä¸­å¸¸è§çš„<code>Leader</code>çš„èƒ½åŠ›(ç»´æŠ¤çŠ¶æ€æœºï¼Œç­”å¤è¯»å†™è¯·æ±‚ï¼Œæ•°æ®åŒæ­¥ç­‰)  </li><li>åŒæ ·éœ€è¦æ„ŸçŸ¥å…·ä½“æ“ä½œå¹¶åˆ¤æ–­å¯äº¤æ¢æ€§</li><li>å¯ä»¥åœ¨æŠŠæ“ä½œåŒæ­¥ç»™<code>Backup</code>ä¹‹å‰ç­”å¤è¯·æ±‚</li><li>è®ºæ–‡ä¸­å«<code>Master</code></li></ul></li><li><code>Backup</code><ul><li>æ™®é€šçš„backupè§’è‰²</li></ul></li></ul><p>åœ¨è®ºæ–‡çš„æ­£æ–‡éƒ¨åˆ†ä¸­<code>Witness</code>éƒ½æ˜¯ä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„éƒ¨ç½²å®ä¾‹æ¥è®¨è®ºçš„ï¼Œä¸è¿‡é™„å½•é‡Œä¹Ÿæåˆ°å®è·µä¸­ä¹Ÿæ²¡å¿…è¦å°†<code>Witness</code>å•ç‹¬éƒ¨ç½²ï¼Œè€Œæ˜¯è·Ÿç€<code>Leader</code>/<code>Backup</code>ä¸€èµ·è¿ä½œï¼Œåªä½œä¸ºé€»è¾‘ä¸Šçš„ä¸€ä¸ªç‹¬ç«‹å•å…ƒã€‚æ‰€ä»¥ä¸€äº›RPCè¯·æ±‚å®é™…ä¸Šæ˜¯å¯ä»¥åˆå¹¶ï¼ˆæ¯”å¦‚<code>Client</code>åŒæ—¶è¯·æ±‚<code>Leader</code>å’Œä¸å…¶åœ¨ä¸€èµ·çš„<code>Witness</code>ï¼‰æˆ–è€…æ˜¯æœ¬åœ°IPCï¼ˆæ¯”å¦‚<code>Leader</code>/<code>Backup</code>è¯·æ±‚å¯¹åº”çš„<code>Witness</code>ï¼‰çš„ã€‚å› æ­¤å¯¹äºå®é™…ä½¿ç”¨çš„æ—¶å€™æ¥è¯´<code>Witness</code>æ›´åƒæ˜¯CURPå¼•å…¥çš„æ–°æœºåˆ¶çš„ä¸€ä¸ªæ¦‚æ‹¬æŠ½è±¡ã€‚</p><h1 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h1><p>åè®®çš„å…·ä½“å†…å®¹å¯ä»¥ä»å‡ ä¸ªåŸºæœ¬æ“ä½œæ¥è¯´æ˜</p><h2 id="æ›´æ–°"><a href="#æ›´æ–°" class="headerlink" title="æ›´æ–°"></a>æ›´æ–°</h2><p>ç”±<code>Client</code>å‘èµ·ï¼Œ<code>Client</code>åŒæ—¶å¯¹<code>Leader</code>åŠ<strong>æ‰€æœ‰</strong><code>Witnesses</code>å‘å‡ºè¯·æ±‚ï¼Œæ ¹æ®è¿™ä¸ªè¯·æ±‚ä¸ä¹‹å‰çš„è¯·æ±‚æ˜¯å¦æ— å…³(å¯äº¤æ¢ï¼Œcommutative)æœ‰ä¸¤ç§æƒ…å†µï¼š  </p><ul><li>å¦‚æœæ— å…³ï¼Œé‚£ä¹ˆ<code>Leader</code>å’Œ<strong>æ‰€æœ‰</strong><code>Witnesses</code>éƒ½ä¼šacceptè¿™ä¸ªè¯·æ±‚ã€‚<code>Client</code>åœ¨æ”¶åˆ°<strong>å…¨éƒ¨</strong>çš„acceptç­”å¤ä¹‹åå¯ä»¥å½“è¿™ä¸ªè¯·æ±‚å·²å®Œæˆã€‚</li><li>å¦‚æœ<code>Leader</code>æˆ–ä»»æ„ä¸€ä¸ª <code>Witness</code> è®¤ä¸ºæœ‰å…³(not commutative)ï¼Œ<code>Client</code>éƒ½éœ€è¦è¦æ±‚<code>Leader</code>è¿›è¡Œä¸€æ¬¡syncï¼Œå°†çŠ¶æ€ä¸<code>Backups</code>è¿›è¡ŒåŒæ­¥åç­”å¤<code>Client</code>ã€‚<code>Client</code>å¯ä»¥ä¾æ®è¿™ä¸ªsyncè¯·æ±‚çš„ç­”å¤å°†è¯·æ±‚å®Œæˆï¼Œè¿™ç§æƒ…å†µä¸‹<code>Witness</code>çš„ç­”å¤æ²¡æœ‰å½±å“ã€‚</li></ul><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ¬¡æ“ä½œä»<code>Client</code>å‘èµ·åˆ°å®Œæˆä¸€å…±æœ‰ä¸‰ä¸ªçŠ¶æ€ï¼š<code>Proposed</code>ï¼Œ<code>Unsynced</code>å’Œ<code>Synced</code>ã€‚<code>Client</code>ä¼šå¯¹é™¤äº†<code>Backup</code>ä¹‹å¤–çš„æ‰€æœ‰èŠ‚ç‚¹å‘èµ·è¯·æ±‚ï¼Œåœ¨ä¸Šé¢çš„ç¬¬ä¸€ç§æƒ…å†µä¸‹æˆä¸º<code>Unsynced</code>ï¼Œæ­¤æ—¶<code>Client</code>å·²ç»å¯ä»¥è®¤ä¸ºè¯¥æ“ä½œå®Œæˆï¼Œ<code>Leader</code>ä¹Ÿå¯ä»¥æŠŠæ“ä½œåº”ç”¨åˆ°çŠ¶æ€æœºä¸Šã€‚<code>Leader</code>åº”ç”¨<code>Unsynced</code>æ“ä½œçš„è¿‡ç¨‹å«åšâ€œæ¨æµ‹æ‰§è¡Œï¼ˆspeculative executionï¼‰â€ã€‚<code>Unsynced</code>çš„æ“ä½œä¼šåœ¨ä¸€ä¸‹æ¬¡æ”¶åˆ°syncè¯·æ±‚æ—¶å¾€<code>Backups</code>è¿›è¡ŒåŒæ­¥ï¼ŒåŒæ­¥å®Œæˆçš„æ“ä½œç§°ä¸º<code>Synced</code>ã€‚è€Œåœ¨ä¸Šé¢çš„ç¬¬äºŒç§æƒ…å†µä¸‹æ“ä½œä¼šè·³è¿‡<code>Unsynced</code>è¿™ä¸€æ­¥ã€‚</p><p>ä½†æ˜¯ä»<code>Leader</code>è§†è§’çœ‹ä¸€ä¸ªæ“ä½œåªè¦<code>Leader</code>è®¤ä¸ºæ˜¯commutativeçš„å®ƒå°±ä¼šåº”ç”¨åˆ°çŠ¶æ€æœºï¼Œä½†è¿™ä¸ªæ“ä½œå¯èƒ½ä¼šè¢«<code>Witness</code>æ‹’ç»ï¼ˆè®¤ä¸ºæ˜¯not commutativeï¼‰ã€‚è¿™æ—¶å€™éœ€è¦ä¾èµ–<code>Client</code>æ¥å‘èµ·syncè¯·æ±‚ï¼Œè¦æ±‚<code>Leader</code>ä¸<code>Backups</code>è¿›è¡ŒåŒæ­¥ã€‚</p><h2 id="Leader-æ•…éšœæ¢å¤"><a href="#Leader-æ•…éšœæ¢å¤" class="headerlink" title="Leader æ•…éšœæ¢å¤"></a>Leader æ•…éšœæ¢å¤</h2><p>æ–° <code>Leader</code> çš„äº§ç”Ÿ/æ¢å¤æœ‰ä¸¤æ­¥ï¼Œé¦–å…ˆåŒæ­¥ <code>Backup</code> çš„çŠ¶æ€ï¼Œç„¶åéšä¾¿æŒ‘ä¸€ä¸ª <code>Witness</code> æ¥é‡æ”¾æ²¡åŒæ­¥åˆ° <code>Backup</code> ä¸­çš„æ“ä½œã€‚</p><p>åŒæ­¥<code>Backup</code>çŠ¶æ€å°±è·å¾—äº†æ‰€æœ‰<code>Synced</code>çš„æ“ä½œï¼Œè€Œä»ä¸Šé¢çš„æ›´æ–°æµç¨‹å¯ä»¥çŸ¥é“<code>Unsynced</code>çš„æ“ä½œå­˜åœ¨äº<strong>å…¨éƒ¨</strong>çš„<code>Witnesses</code>ä¸­ï¼Œæ‰€ä»¥è¿™é‡Œéšä¾¿æŒ‘ä¸€ä¸ª <code>Witness</code> éƒ½æœ‰å…¨éƒ¨æ‰€éœ€çš„ä¿¡æ¯ã€‚å¦å¤–<code>Unsynced</code>æ“ä½œåœ¨ä¸åŒçš„<code>Witnesses</code>ä¸Šæ‰€æäº¤çš„é¡ºåºå¯èƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥CURPè¦æ±‚åªæœ‰æ»¡è¶³commutativeå¯ä»¥ä¹±åºæ‰§è¡Œçš„æ“ä½œæ‰å¯ä»¥æ¨æµ‹æ‰§è¡Œã€‚</p><p>å¦å¤–è¿˜éœ€è¦è§£å†³<code>Backup</code>å’Œ<code>Witness</code>å¯èƒ½å­˜åœ¨é‡å¤è®°å½•çš„é—®é¢˜ï¼Œå¦‚æœå°†å·²ç»æ˜¯<code>Synced</code>çš„æ“ä½œå†è¿›è¡Œé‡æ”¾æ˜¯ä¼šå¯¼è‡´çŠ¶æ€é”™è¯¯çš„ã€‚å› æ­¤CURPéœ€è¦ä¿è¯æ¯ä¸ªæ“ä½œåªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œç®€å•æ¥è¯´å°±æ˜¯è®©<code>Client</code>ç»™æ¯ä¸ªæ“ä½œåŠ ä¸Šä¸€ä¸ª<code>RPC ID</code>ã€‚</p><blockquote><p>To avoid duplicate executions of the requests that are already replicated to backups, CURP relies on exactly-once semantics provided by RIFL, which detects already executed client requests and avoids their re-execution</p></blockquote><p>å½“ç„¶å¦‚æœæ˜¯ä¸€ä¸ª <code>Backup</code> æˆä¸ºæ–° <code>Leader</code> å°±å¯ä»¥è·³è¿‡ç¬¬ä¸€æ­¥ã€‚</p><h2 id="è¯»å–"><a href="#è¯»å–" class="headerlink" title="è¯»å–"></a>è¯»å–</h2><p><code>Client</code> å¯ä»¥ç›´æ¥ä» <code>Leader</code> è¯»ï¼Œä¸è¿‡éœ€è¦è¿™æ¬¡è¯»æ“ä½œä¹Ÿä¸å…¶ä»– <code>Unsynced</code> çš„æ“ä½œæ— å…³ï¼Œå¦åˆ™éœ€è¦å…ˆ sync ä¸€ä¸‹ï¼Œå› ä¸ºå¯¹åŒä¸€ä¸ªå†…å®¹çš„è¯»å’Œå†™æ“ä½œæ˜¯æ— æ³•ä¹±åºæ‰§è¡Œçš„ã€‚è€Œåœ¨<code>Leader</code>è§†è§’çœ‹ï¼Œæ¨æµ‹æ‰§è¡Œçš„æ“ä½œä¸ä¸€å®šåœ¨é‡å¯/å˜æ›´Leaderä¹‹åè¿˜å­˜åœ¨ï¼ˆåœ¨<code>Leader</code>åº”ç”¨åˆ°çŠ¶æ€æœºåï¼Œä½†æ˜¯è¢«<code>Witnesses</code>è®°å½•ä¸‹æ¥ä¹‹å‰å‘ç”Ÿcrashï¼‰ï¼Œæ‰€ä»¥è¯»æ¨æµ‹æ‰§è¡Œçš„å†…å®¹ä¹Ÿéœ€è¦æ£€æŸ¥commutativeã€‚æ‰€ä»¥è¿™ç§è¯»æ“ä½œä¸æ›´æ–°æ“ä½œçš„åŒºåˆ«åªæœ‰(1)ä¸æ¶‰åŠ <code>Witness</code> (2)ä¸ä¼šå½±å“ <code>Leader</code> çš„çŠ¶æ€æœºï¼Œå› æ­¤ä¸éœ€è¦è¢«è®°å½•ã€‚</p><p><code>Client</code> ä¹Ÿå¯ä»¥ä» <code>Backup</code> è¯»ï¼Œä¸è¿‡è¯»ä¹‹å‰éœ€è¦å…ˆå‘ä¸€ä¸ª <code>Witness</code> è¯¢é—®è¿™ä¸ªæ“ä½œæ˜¯å¦ commutativeã€‚åªæœ‰åœ¨å¾—åˆ°è‚¯å®šç­”å¤çš„æƒ…å†µä¸‹æ‰å¯ä»¥è¯» <code>Backup</code>ï¼Œå¦åˆ™è¿˜æ˜¯åªèƒ½ä» <code>Leader</code> è¯»ã€‚å‰é¢è¦æ±‚ä¸€ä¸ªæ“ä½œè¢«è®°å½•åˆ°æ‰€æœ‰ <code>Witnesses</code> ä¹Ÿè€ƒè™‘åˆ°äº†è¿™é‡Œèƒ½å¤Ÿéšæ„è¯·æ±‚ <code>Witness</code> æ¥è¯¢é—® commutativeã€‚</p><p>åŒæ—¶å› ä¸º<code>Backups</code>ä¹‹é—´çš„çŠ¶æ€å¯èƒ½å› ä¸ºåŒæ­¥è¿›åº¦ä¸åŒè€Œå‡ºç°å·®å¼‚ï¼Œä¸ºäº†ä»ä»»æ„ä¸€ä¸ª <code>Backup</code> éƒ½èƒ½è¯»åˆ°åŒæ ·çš„ç»“æœï¼Œ<code>Backups</code> ä¹‹é—´è¿˜éœ€è¦æ„ŸçŸ¥äº’ç›¸çš„åŒæ­¥çŠ¶æ€(å³ä¸€ä¸ªæ“ä½œæ˜¯å¦è¢«æ‰€æœ‰çš„ <code>Backups</code> åŒæ­¥å®Œæˆ)ã€‚</p><blockquote><p>even if a value is replicated to some of backups, the value may get lost if the master crashes and a new master recovers from a backup that didnâ€™t receive the new value. A simple solution for this problem is that backups donâ€™t allow reading values that are not yet fully replicated to all backups.</p></blockquote><h2 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h2><p>è¿™é‡Œè®¨è®º<code>Witness&#39; records</code>å’Œ<code>RPC ID</code>ä¸¤ä¸ªèµ„æºçš„å›æ”¶ã€‚</p><p>ä»å‰é¢å¯çŸ¥ï¼Œ<code>Witness</code> åªæœ‰åœ¨æ–°è®°å½•ä¸ç°åœ¨æ‰€æœ‰è®°å½•éƒ½æ— å…³çš„æƒ…å†µä¸‹æ‰èƒ½ acceptã€‚æ‰€ä»¥ä¸ºäº†æé«˜æˆåŠŸç‡ <code>Witness</code> å¿…é¡»å°½å¿«ä¸¢æ‰ä¸å¿…è¦çš„æ•°æ®(è¢« <code>Leader</code> åŒæ­¥åˆ°äº† <code>Backups</code> ä¸Šï¼Œå³syncedçš„æ•°æ®)ã€‚åœ¨ CURP ä¸­ <code>Leader</code> ä¼šç»™ <code>Witness</code> å‘ GC æŒ‡ä»¤ï¼Œå‘Šè¯‰ <code>Witness</code> å“ªäº›æ“ä½œå·²ç»å®Œæˆäº†åŒæ­¥å¹¶å¯ä»¥ä¸¢å¼ƒã€‚</p><p>åœ¨ <code>Witness GC</code> å’Œæ›´ä¹‹å‰çš„æ•…éšœæ¢å¤ç¯èŠ‚éƒ½éœ€è¦å¯¹æ“ä½œè®°å½•è¿›è¡Œæ ‡è¯†ï¼ŒCPUP ä½¿ç”¨çš„æ˜¯ <code>RIFL</code> ä¸­çš„ <code>RPC ID</code> æ¥å®Œæˆã€‚å› ä¸ºè¿™ä¸ª ID æ˜¯ Client åˆ†é…çš„ï¼Œæ‰€ä»¥æ— æ³•ä½¿ç”¨ç´¯è¿›ç¡®è®¤çš„æ–¹å¼è€Œå¿…é¡»å¯¹æ¯ä¸ª ID éƒ½è¿›è¡Œè®°å½•ã€‚æ­¤å¤– CURP è¿˜å¯¹ <code>RIFL</code> åšäº†ä¸€äº›æ”¹åŠ¨ï¼Œåœ¨è®ºæ–‡çš„ <em>é™„å½•Â§C.1</em> èŠ‚æœ‰å±•å¼€ï¼Œä¸»è¦æ˜¯ä¸ºäº†é€‚é… Witness æä¾›çš„ Recoveryã€‚</p><h1 id="è¿›é˜¶æ“ä½œ"><a href="#è¿›é˜¶æ“ä½œ" class="headerlink" title="è¿›é˜¶æ“ä½œ"></a>è¿›é˜¶æ“ä½œ</h1><p>ä»æ›´æ–°æ“ä½œçš„æ­¥éª¤å¯ä»¥çœ‹åˆ° <code>Client</code> å‘ <code>Witnesses</code> å†™æ•°æ®ä»¥åŠ <code>Leader</code> å‘ <code>Backups</code> åŒæ­¥çŠ¶æ€éƒ½æ˜¯æœ‰å…¨åŒæ­¥çš„è¦æ±‚çš„ï¼Œå³è¦æ±‚æ‰€æœ‰çš„è¯·æ±‚å¯¹è±¡éƒ½å®Œæˆæ‰èƒ½ç®—å®Œæˆï¼Œè€Œåé¢çš„æ•…éšœæ¢å¤å’Œè¯»å–æ“ä½œä¹Ÿéƒ½ç”¨åˆ°äº†è¿™ä¸€ç‚¹ã€‚</p><p>è¿™æ ·æ“ä½œåœ¨ç½‘ç»œåˆ†åŒºæˆ–è€…å•èŠ‚ç‚¹å¤„ç†æ…¢ä¹‹ç±»æƒ…å†µä¸‹çš„å¯ç”¨æ€§å’Œæ€§èƒ½æ˜¯æ¯”è¾ƒè®©äººæ‹…å¿ƒçš„ã€‚è®ºæ–‡åœ¨é™„å½•è¿˜å±•å¼€äº†å¦ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥è®© <code>Client</code> å‘ <code>Witnesses</code> å†™æ•°æ®æ—¶åªå¾—åˆ°<em>è¶…å¤§å¤šæ•°(superquorum)</em> <code>Witnesses</code> çš„ç­”å¤å°±è¡Œã€‚è¿™é‡Œâ€œè¶…å¤§å¤šæ•°â€çš„è®¡ç®—æ–¹å¼æ˜¯ $$superquorum=f+\lceil f/2 \rceil + 1$$ï¼Œå…¶ä¸­<code>f</code>æ˜¯èƒ½å®¹å¿å¤šå°‘èŠ‚ç‚¹æŒ‚æ‰çš„æ•°é‡ã€‚è¿™é‡Œæ¯”ä¼ ç»Ÿå¤šæ•°æ´¾è¿˜å¤šäº†ä¸€ä¸ªâ€œå°‘æ•°æ´¾çš„å¤§å¤šæ•°â€çš„åŸå› æ˜¯ä¸ºäº†æ•…éšœæ¢å¤æ—¶å‰©ä¸‹çš„ <code>Witnesses</code> ä¹‹é—´è¿˜èƒ½ä¿æŒå¤šæ•°æ´¾ã€‚</p><blockquote><p>The reason why CURP needs a superquorum instead of a simple majority is to ensure commutativity of replays from witnesses during recovery</p></blockquote><p>è€Œç›¸åº”çš„ï¼Œ<code>Leader</code>åœ¨æ¢å¤çš„æ—¶å€™ä»¥åŠ<code>Client</code>åœ¨è¯»<code>Backup</code>ä¹‹å‰æŸ¥è¯¢çš„æ—¶å€™éƒ½éœ€è¦æ”¶é›†å¤šæ•°æ´¾<code>Witnesses</code>çš„ç»“æœã€‚å…¶å®å°±æ˜¯ç‰ºç‰²äº†ä¸€äº›è¯»æ—¶çš„ä¾¿åˆ©æ€§æ¥ä¼˜åŒ–å†™çš„æ“ä½œã€‚</p><p>æ­¤å¤– <code>Leader</code> å‘ <code>Backups</code> åŒæ­¥æ•°æ®ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œåªè¦åŒæ­¥åˆ°å¤šæ•°æ´¾ä¸Šï¼Œåœ¨æ¢å¤çš„æ—¶å€™é€‰æœ€æ–°çš„ã€‚åœ¨ <code>Client</code> è¯» <code>Backup</code> çš„æ—¶å€™ä¹Ÿé€‰å¤šæ•°æ´¾å’Œæœ€æ–°ä»»æœŸï¼Œç±»ä¼¼ Raft çš„é‚£ä¸€å¥—æ“ä½œã€‚</p><h1 id="ä¸€äº›è¯æ˜"><a href="#ä¸€äº›è¯æ˜" class="headerlink" title="ä¸€äº›è¯æ˜"></a>ä¸€äº›è¯æ˜</h1><p>è®ºæ–‡åœ¨ <em>é™„å½•Â§A</em> é‡Œé¢ç®€å•è¯æ˜äº†ä¸€ä¸‹ <code>Durability</code>, <code>Consistency</code> å’Œ <code>Linearizability</code> å‡ ä¸ªå…³é”®ç‰¹æ€§ï¼Œä¸è¿‡éƒ½æ˜¯åŸºäºåŸºæœ¬æ“ä½œçš„ç‰ˆæœ¬ï¼ˆå…¨åŒæ­¥å†™ï¼‰ã€‚è¿™é‡Œä¹Ÿæ´—ä¸€ä¸‹ç¨¿ã€‚</p><p>å…ˆå›é¡¾ä¸€ä¸‹å‡ ä¸ªæ“ä½œæ—¶çš„è§„åˆ™ï¼š</p><ul><li><code>Client</code> åªæœ‰ä¸¤ç§æƒ…å†µä¸‹å¯ä»¥å®Œæˆä¸€ä¸ªæ“ä½œï¼šè¯¥æ“ä½œè¢«<strong>æ‰€æœ‰</strong> <code>Witnesses</code> è®°å½• <em>æˆ–</em> è¯¥æ“ä½œè¢«<strong>æ‰€æœ‰</strong> <code>Backups</code> æŒä¹…åŒ–(å³è¢« <code>Leader</code> æ¥æ”¶)<blockquote><p>from Â§3.2.1, a client only completes an update operation if (1) it is recorded in all f witnesses or (2) it is replicated to f backups.</p></blockquote></li><li>ä¸€ä¸ªæœªåŒæ­¥(unsynced)çš„æ“ä½œå¿…é¡»ä¸æ‰€æœ‰å…¶ä»–æœªåŒæ­¥çš„æ“ä½œæ— å…³(commutative)<blockquote><p>a completed unsynced operation must be individually commutative with all preceding operations that are not synced yet.</p></blockquote></li><li>å¦‚æœ <code>Leader</code> è¦ç­”å¤ä¸€ä¸ªä¸å¯äº¤æ¢(not commutative)çš„æ“ä½œï¼Œéœ€è¦å…ˆä¸ <code>Backup</code> è¿›è¡Œä¸€æ¬¡åŒæ­¥(sync)<blockquote><p>a master must sync before responding if the current operation is not commutative with any other existing (preceding) unsynced operations.</p></blockquote></li></ul><h2 id="Durability"><a href="#Durability" class="headerlink" title="Durability"></a>Durability</h2><p>æ‰€æœ‰çš„æ“ä½œè‡³å°‘ä¼šå­˜åœ¨äºæ‰€æœ‰ <code>Backups</code> (synced) æˆ–æ‰€æœ‰ <code>Witnesses</code> (unsynced) ä¸Šï¼Œæ‰€ä»¥æ¢å¤çš„æ—¶å€™æ‰¾ä¸€ä¸ª <code>Backup</code> åŠ ä¸Šä¸€ä¸ª <code>Witness</code> å°±èƒ½æ‹¿åˆ°æ‰€æœ‰çš„ä¿¡æ¯ã€‚</p><h2 id="Consistency"><a href="#Consistency" class="headerlink" title="Consistency"></a>Consistency</h2><p>synced çš„æ“ä½œå­˜åœ¨åœ¨ Backup ä¸Šï¼Œå¹¶é€šè¿‡ ID çš„æ–¹å¼é˜²æ­¢é‡å¤æ‰§è¡Œã€‚unsynced çš„æ“ä½œå­˜åœ¨åœ¨ Witness ä¸Šï¼Œå¹¶ä¸”å¯ä»¥ä»¥ä»»æ„é¡ºåºé‡æ”¾ã€‚</p><p>ä¸è¿‡è®ºæ–‡å¥½åƒæœ‰ä¸€ä¸ªå†…å®¹æ²¡è®²ï¼Œå°±æ˜¯ <code>Witness</code> ä¸Šè®°å½•çš„æ“ä½œä¸ä¸€å®šæœ€ç»ˆä¼šæ‰§è¡Œï¼ˆæ¯”å¦‚<code>Client</code>å‘èµ·syncä¹‹å‰å‘ç”Ÿcrashï¼‰ï¼Œæ‰€ä»¥ <code>Witness</code> æ˜¯éœ€è¦æœ‰æœºåˆ¶å»ç¡®è®¤ä¸€ä¸ªè®°å½•ä¸‹æ¥çš„æ“ä½œæ˜¯æœ‰æ•ˆçš„ã€‚æˆ‘è§‰å¾—å¯ä»¥è®© <code>Leader</code> å®šæœŸç»™ <code>Witness</code> åŒæ­¥è¿™ä¸ªä¿¡æ¯ï¼ˆæ¯”å¦‚å°†è¿™ä¸ªä¹Ÿä½œä¸º sync çš„ä¸€æ­¥ï¼‰ï¼ŒåŒæ—¶ <code>Witness</code> åœ¨æ¢å¤æœŸé—´ä¸æä¾›æœªè¢«ç¡®è®¤çš„æ“ä½œã€‚</p><h2 id="Linearizability"><a href="#Linearizability" class="headerlink" title="Linearizability"></a>Linearizability</h2><p>è¿˜æ˜¯ä»å‰é¢çš„è§„åˆ™æ¨å¯¼ã€‚å¦‚æœä¸€ä¸ªå†™å…¥åœ¨åªè¢«éƒ¨åˆ† <code>Witness</code> è®°å½•åˆ°çš„æ—¶å€™å°±crashï¼Œé‡å¯ä¹‹åçš„ <code>Leader</code> å¯èƒ½ä¸ä¼šæœ‰è¿™ä¸ªä¿¡æ¯ï¼Œä½†æ˜¯è¿™æ—¶å€™ <code>Client</code> ä¹Ÿä¸ä¼šè®¤ä¸ºè¿™ä¸ªæ“ä½œå·²å®Œæˆï¼Œå› ä¸ºæ²¡æ”¶åˆ°æ‰€æœ‰ <code>Witness</code> çš„ç­”å¤ã€‚å¯¹äº<code>Client</code>è®¤ä¸ºå·²ç»å®Œæˆçš„æ“ä½œå†å»è¯»çš„æ—¶å€™ <code>Leader</code> èƒ½ä¿è¯çº¿æ€§ä¸€è‡´ã€‚è¯» <code>Backup</code> çš„æµç¨‹è®ºæ–‡çš„å›¾4ä¹Ÿç¨å¾®æ¶‰åŠåˆ°äº†çº¿æ€§ä¸€è‡´çš„å‡ ç§æƒ…å†µã€‚</p><p>ä¸è¿‡è¿™é‡Œåªæ˜¯æ–‡å­—è®ºè¿°ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¹¶æ³•å†…å®¹ï¼Œä½œä¸ºè¯æ˜æ„Ÿè§‰è¿˜æ˜¯æœ‰ç‚¹å•è–„ï¼Œä½†æ˜¯ä¹Ÿæƒ³ä¸åˆ°ä»€ä¹ˆåé¢ä¾‹å­â€¦â€¦</p><h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>è¿™ç¯‡æ–‡ç« çœç•¥äº†è®ºæ–‡ä¸­çš„ä¸€äº›å†…å®¹ï¼Œæ¯”å¦‚ä¸€äº›å®ç°ä¸Šçš„ç»éªŒç»†èŠ‚ï¼Œåˆ†åŒºçš„å¤„ç†ç­‰ç­‰ã€‚çœ‹ä¸‹æ¥è§‰å¾—åŸºæœ¬æ€æƒ³è¿˜å¥½ç†è§£ï¼Œè®ºæ–‡è¯´è¿™æ˜¯ä¸€ä¸ªé€šç”¨çš„ä¼˜åŒ–æ‰‹æ®µï¼Œä½†æ˜¯æ€ä¹ˆå˜æˆä¸€ä¸ªçœŸæ­£çš„ä¼˜åŒ–æ„Ÿè§‰è¿˜æ˜¯è¦åœ¨å®ç°çš„æ—¶å€™å¤šåšäº›å¾®æ“â€¦â€¦</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è®ºæ–‡åå­—æ˜¯ã€ŠExploiting Commutativity For Practical Fast Replicationã€‹&lt;/p&gt;
&lt;p&gt;CURPå…¨ç§°Consistent Unordered Replication Protocolï¼Œä¸»è¦æ˜¯åˆ©ç”¨æ“ä½œä¹‹é—´çš„ç›¸å…³æ€§ï¼ˆCommu</summary>
      
    
    
    
    
    <category term="Paper Reading" scheme="https://waynexia.github.io/tags/Paper-Reading/"/>
    
  </entry>
  
  <entry>
    <title>CeresDB çš„å•çº¿ç¨‹æ¨¡å‹å®è·µ (Rust China Conf 2022)</title>
    <link href="https://waynexia.github.io/2022/06/tpc-practice/"/>
    <id>https://waynexia.github.io/2022/06/tpc-practice/</id>
    <published>2022-06-16T12:46:10.000Z</published>
    <updated>2023-11-23T08:35:22.636Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>è¿™ç¯‡æ˜¯ä» Rust China Conf 2022 çš„ talk æ•´ç†æ¥çš„ï¼ˆæ ¡å¯¹å¬å†™è½¬å½•ç¨¿å¥½éº»çƒ¦â€¦â€¦</p></blockquote><p><strong>ï¼ˆè¿˜æ²¡æ ¡å¯¹å®Œï¼‰</strong></p><p>ä»‹ç»ä¸€ä¸‹å•çº¿ç¨‹æ¨¡å¼ä¸¤ä¸ªåœ¨ç”Ÿäº§ä¸­çš„ä¾‹å­ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/waynexia/helixdb">HelixDB</a> æ˜¯ä¸€ä¸ªThread Per Coreæ¨¡å‹çš„KVå­˜å‚¨ï¼Œ<a target="_blank" rel="noopener" href="https://github.com/ceresdb/ceresdb">CeresDB</a> ä¸­ä¹Ÿæœ‰éƒ¨åˆ†é€»è¾‘åœ¨å•çº¿ç¨‹æ¨¡å¼ä¸‹å·¥ä½œã€‚</p><h1 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h1><div class="heti heti--annotation">é¦–å…ˆçœ‹ä¸€ä¸‹CeresDBä¸­çš„ä¸€ä¸ªä¾‹å­ï¼Œåœ¨CeresDBä¸­æ‰€æœ‰çš„å†™è¯·æ±‚éƒ½ç”±Write Workerç»„ä»¶æ¥è¿›è¡Œå®é™…å¤„ç†ï¼Œä¸Šå±‚çš„Insertä¹‹ç±»çš„è¯·æ±‚æœ€åä¼šè½¬åŒ–ä¸ºå¯¹æ•°æ®çš„ä¿®æ”¹è¯·æ±‚ï¼Œå¹¶äº¤ç»™Write Workeræ‰§è¡Œï¼Œæ¯”å¦‚è¯´æ’å…¥æ•°æ®æˆ–è€…æ›´æ”¹è¡¨ç»“æ„ç­‰ç­‰ã€‚åŒæ—¶ä¹Ÿæœ‰ä¸€äº›åå°å¤„ç†å½’æ¡£çš„å·¥ä½œï¼Œæ¯”å¦‚è¯´<ruby>å‹å®<rt>compact</rt></ruby>æˆ–è€…<ruby>åˆ·å†™<rt>flush</rt></ruby>ã€‚</div><p>å¯¹ä»¥ä¸€å¼ è¡¨æ¥è¯´ï¼Œå†™æ“ä½œæœ¬èº«å°±æœ‰äº’æ–¥çš„å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥è¡¨ä¸ºå•ä½ï¼Œå°†æ¯å¼ è¡¨å¯¹åº”åˆ°ä¸€ä¸ªWrite Workerï¼Œä¸€ä¸ªWrite Workerä¸Šå¯èƒ½ä¼šè´Ÿè´£å¤šä¸ªè¡¨ï¼Œæ˜¯ä¸€ä¸ªä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè¿™å¼ è¡¨çš„æ‰€æœ‰å†™æ“ä½œéƒ½ç”±å¯¹åº”çš„Workeræ¥å®Œæˆã€‚é»˜è®¤æ˜¯æŒ‰ç…§æ ¸æ•°æ¥åˆå§‹åŒ–Write Workerï¼Œæ¯ä¸ªWrite Workerä¹‹é—´çš„è´Ÿè½½å’Œèµ„æºéƒ½è¿›è¡Œäº†éš”ç¦»ã€‚åŒ…æ‹¬Workeræœ¬èº«ä¼šç‹¬å ä¸€ä¸ªçº¿ç¨‹ï¼Œä»¥åŠWorkeræ‰€è´Ÿè´£åˆ°çš„é‚£äº›è¡¨æ¶‰åŠåˆ°çš„èµ„æºåœ¨é€»è¾‘ä¸Šä¹Ÿæ˜¯ä¸å…±äº«çš„ã€‚Write Workerçš„ä¸»é€»è¾‘å®é™…ä¸Šå°±æ˜¯ä¸æ–­åœ°ä»ä¸€ä¸ªchannelä¸­æ¥æ”¶ä»»åŠ¡å¹¶æ‰§è¡Œã€‚</p><p>è¿™æ ·çš„æ“ä½œèƒ½å¸¦æ¥ä¸¤ä¸ªå¥½å¤„ï¼Œé¦–å…ˆå¯¹äºæ¯å¼ è¡¨æ¥è¯´ï¼Œåå°çš„å†™å…¥æ“ä½œæ˜¯ä¸²è¡ŒåŒ–çš„ï¼Œæ‰€ä»¥åšä¸€äº›ç®€å•çš„é€»è¾‘å°±èƒ½å¤Ÿé¿å…å†™å†™å†²çªçš„é—®é¢˜ï¼Œèƒ½å¤Ÿç®€åŒ–çŠ¶æ€ç®¡ç†çš„ä»£ç ã€‚åŒæ—¶Write Workerå°†è¡¨ä»¥åŠè¡¨åæ‰€éšè—çš„èµ„æºéƒ½é¢„å…ˆåˆ†é…å¹¶ç‹¬å ï¼Œå¯ä»¥å»å‡å°‘èµ„æºç«äº‰çš„æƒ…å†µã€‚</p><p>å½“ç„¶è¿™ä¸ªå®Œå…¨ä¸²è¡ŒåŒ–æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„åœºæ™¯ï¼Œå®é™…ä¸Šè¿˜ä¼šæœ‰ä¸€äº›å¤æ‚çš„é€»è¾‘ï¼Œæ¯”å¦‚è¯´ä¸€äº›ä¸å…³å¿ƒå†™å…¥é¡ºåºçš„æ“ä½œå°±å¯ä»¥detachåˆ°åå°æ¥æ‰§è¡Œï¼Œå¿½ç•¥å®ƒä¸å…¶ä»–å‰å°æ“ä½œä¹‹é—´çš„é¡ºåºç­‰ã€‚</p><p>åˆšåˆšæ‰€è¯´åœ¨ç›®å‰æˆ‘ä»¬å¤§å¤šæ•°æƒ…å†µåº•ä¸‹ï¼Œè™½ç„¶åœ¨é€»è¾‘ä¸Šåšäº†åŒºåˆ†ï¼Œä½†åº•ä¸‹è¿˜æ˜¯åŒä¸€ä¸ªç‰©ç†èµ„æºï¼Œæ¯”å¦‚è¯´åŒä¸€å—ç£ç›˜ã€åŒä¸€å—ç½‘å¡ä¹‹ç±»çš„ã€‚åœ¨é€»è¾‘ä¸Šç‹¬å ï¼Œç‹¬å çš„å¯èƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶è·¯å¾„æˆ–è€…æ˜¯ä¸€ä¸ªSQLçš„é“¾æ¥ï¼Œé€šè¿‡è¿™ä¸ªæŠ½è±¡èƒ½å¤Ÿå‡å°‘ä¸Šå±‚èµ„æºäº’æ–¥çš„é€»è¾‘ï¼Œå¹¶ä¸”åœ¨ç‰©ç†èµ„æºæ‹“å±•çš„æ—¶å€™èƒ½å¤Ÿå¾ˆæ–¹ä¾¿çš„Scale outï¼Œæ¯”å¦‚è¯´ç®€å•çš„åŠ ç£ç›˜ã€åŠ ç½‘å¡å°±è¡Œï¼Œå› ä¸ºå·²ç»åšäº†é€»è¾‘èµ„æºçš„éš”ç¦»ï¼Œæ‰€ä»¥èƒ½å¤Ÿæ¯”è¾ƒæ–¹ä¾¿åœ°å»è¿›è¡Œæ‹“å±•ã€‚</p><p>Image</p><p>è¿™æ˜¯å•çº¿ç¨‹æ¨¡å‹åœ¨CeresDBä¸­çš„ä¸€ä¸ªåº”ç”¨åœºæ™¯ï¼Œä½œä¸ºä¸€ä¸ªé€šç”¨çš„æ‰‹æ®µï¼Œæˆ‘ç®€å•æ€»ç»“äº†å‡ ç‚¹å®ƒèƒ½å¤Ÿå¸¦æ¥çš„å¥½å¤„ï¼š</p><ul><li>é¦–å…ˆåœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„çŠ¶æ€åªä¼šåœ¨ä¸€ä¸ªçº¿ç¨‹å†…è¢«è®¿é—®å’Œä¿®æ”¹ï¼Œåœ¨ç¼–ç çš„æ—¶å€™å¯ä»¥ç®€åŒ–çŠ¶æ€ç®¡ç†çš„é€»è¾‘ã€‚èµ„æºä¹Ÿæ˜¯ä¸€æ ·ï¼Œå„ä¸ªèµ„æºåœ¨é€»è¾‘å±‚é¢ç‹¬ç«‹ï¼Œèƒ½å¤Ÿå‡å°‘èµ„æºçš„ç«äº‰å¼€é”€ã€‚</li><li>å……åˆ†åˆ©ç”¨äº†Rustçš„åç¨‹ç‰¹æ€§ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨async/awaitæ¥å‡å°‘çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚å¯èƒ½ä¹‹å‰æ˜¯æœ‰ä¸€å †çº¿ç¨‹ï¼Œå¹¶ä¸”çº¿ç¨‹æ•°é‡æ˜¯å¤§äºæ ¸æ•°ã€‚æ“ä½œç³»ç»Ÿå°±ä¼šå¯¹æˆ‘ä»¬çš„çº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œåˆ†æ—¶è°ƒåº¦åˆ°ä¸åŒçš„æ ¸ä¸Šæ¥æ‰§è¡Œã€‚æˆ‘ä»¬ç°åœ¨å¦‚æœæŠŠæ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²ç»é¢„å…ˆåˆ†é…åˆ°çº¿ç¨‹é‡Œé¢ï¼Œå°±å¯ä»¥å°†çº¿ç¨‹çš„åˆ‡æ¢ç®€åŒ–ä¸ºä¸€ä¸ªåç¨‹çš„åˆ‡æ¢ã€‚å¹¶ä¸”ç”±æ›´ç†è§£å…·ä½“ä½¿ç”¨æƒ…å†µçš„æˆ‘ä»¬è‡ªå·±æ¥ä»£æ›¿æ“ä½œç³»ç»Ÿè¿›è¡Œè°ƒåº¦ã€‚</li><li>å¦‚æœèƒ½å¤Ÿå†è¿›ä¸€æ­¥å°†è¿™äº›å·¥ä½œçº¿ç¨‹ä¸æ ¸å¿ƒç»‘å®šèµ·æ¥ï¼Œå½¢æˆThreadÂ PerÂ Coreçš„æ¨¡å¼ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥æé«˜CPUçš„äº²å’Œæ€§ä»¥åŠCacheçš„å‘½ä¸­ç‡ç­‰ã€‚</li></ul><p>Image</p><h1 id="Pros-amp-Cons"><a href="#Pros-amp-Cons" class="headerlink" title="Pros. &amp; Cons."></a>Pros. &amp; Cons.</h1><p>ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œæ‰€æåˆ°çš„å„ç§æ–¹æ³•éƒ½æœ‰é€‚ç”¨åœºæ™¯ï¼Œæ¥ä¸‹æ¥è¯¦ç»†è®¨è®ºä¸€ä¸‹å…³äºè¿™ç§æ–¹å¼å…·ä½“çš„ä¼˜åŠ¿å’Œå±€é™æ€§ã€‚</p><h2 id="It-gives"><a href="#It-gives" class="headerlink" title="It gives"></a>It gives</h2><p>æ¥ä¸‹æ¥è¯¦ç»†ä»‹ç»ä¸€ä¸‹å®ƒèƒ½å¸¦æ¥çš„å‡ ç‚¹ä¼˜åŠ¿ï¼Œé¦–å…ˆæ˜¯è°ƒåº¦æ¨¡å‹æ–¹é¢ï¼Œä»ä¹‹å‰æçš„ç”±æ“ä½œç³»ç»Ÿè¿›è¡Œçš„æŠ¢å å¼è°ƒåº¦ï¼Œå˜ä¸ºäº†å„ä¸ªåç¨‹ä¹‹é—´è¿›è¡Œçš„åä½œå¼è°ƒåº¦ã€‚</p><p>æ¥å¯¹æ¯”ä¸€ä¸‹ï¼Œå·¦è¾¹æ˜¯ä¸€ä¸ªæŠ¢å å¼è°ƒåº¦çš„ä¸€ç§å¸¸è§çš„æƒ…å†µã€‚äº§ç”Ÿè¿™ç§æƒ…å†µå…¶å®å°±æ˜¯æˆ‘ä»¬æŠŠè‹¥å¹²ä¸ªä»»åŠ¡åŒæ—¶æ”¾è¿›ä¸€ä¸ªçº¿ç¨‹å»æ‰§è¡Œï¼Œå¯èƒ½è¿™äº›ä»»åŠ¡ä¹‹é—´æ˜¯ä¼šæ¶‰åŠåˆ°åŒä¸€ä¸ªçŠ¶æ€æˆ–è€…é€»è¾‘èµ„æºï¼Œä½†æ˜¯è¿™äº›ä»»åŠ¡æ˜¯äº’æ–¥çš„ã€‚</p><p>æ¯”å¦‚è¯´è¿™é‡Œæœ‰ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶åœ¨æ‰§è¡Œä¸¤ä¸ªä»»åŠ¡ï¼Œè€Œè¿™ä¸¤ä¸ªä»»åŠ¡éƒ½æ˜¯æ¶‰åŠåˆ°åŒä¸€ä¸ªèµ„æºï¼Œå‡è®¾ä¸¤ä¸ªä»»åŠ¡åˆ†åˆ«å«xå’Œyã€‚å®ƒä»¬å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°ä¸€ä¸ªæ ¸ä¸Šæ¥æ‰§è¡Œï¼Œåœ¨è¿™é‡Œå¯èƒ½å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰§è¡Œäº†ä¸¤å¥ï¼Œç„¶åæ“ä½œç³»ç»ŸæŠŠç¬¬äºŒä¸ªçº¿ç¨‹è°ƒåº¦åˆ°è¿™ä¸ªæ ¸ä¸Šï¼ŒæŠŠç¬¬ä¸€ä¸ªçº¿ç¨‹è°ƒåº¦èµ°ï¼Œç¬¬äºŒä¸ªçº¿ç¨‹å°±æ‰§è¡Œäº†ä¸¤å¥ï¼Œè¿™æ ·äº¤æ›¿æ‰§è¡Œã€‚ä»ä¸€ä¸ªçº¿ç¨‹æ¥è¯´ï¼Œå®ƒæ„ŸçŸ¥åˆ°çš„æ˜¯è‡ªå·±æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œçš„ï¼Œä½†æ˜¯åœ¨å†™å®Œy=1ç„¶åå»è¯»yçš„æ—¶å€™ï¼Œå´ä¼šå‘ç°yå˜äº†ã€‚æ‰€ä»¥åœ¨è¿™ç§æ¨¡å¼ä¸‹å…¶å®æ˜¯éœ€è¦ä¸€ä¸ªæ•°æ®åŒæ­¥çš„ï¼Œå¯èƒ½æ˜¯é”æˆ–è€…åŸå­å˜é‡ä¹‹ç±»çš„æ‰‹æ®µï¼Œæ¥ä¿æŠ¤å¥½çŠ¶æ€å’Œå˜æ›´ã€‚</p><div class="heti heti--annotation">è€Œåœ¨å³è¾¹ï¼Œè¿™ä¸¤ä¸ªä»»åŠ¡ä¼šè¢«åˆ†é…åˆ°åŒä¸€ä¸ªçº¿ç¨‹å†…ã€‚å³æ¶‰åŠåˆ°åŒä¸€ä¸ªèµ„æºçš„ä¼šè¢«åˆ†é…åˆ°ä¸€èµ·ã€‚å¦‚æœä¸¤ä¸ªä»»åŠ¡è¿è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå°±ç®—è¿™ä¸ªçº¿ç¨‹æœ¬èº«è¢«æ“ä½œç³»ç»Ÿè°ƒåº¦èµ°ï¼Œå¯¹ä»»åŠ¡æ¥è¯´å®ƒï¼ˆä»»åŠ¡ï¼‰ä¹Ÿæ˜¯ä¸€ç›´è¿è¡Œçš„ã€‚å› ä¸ºæ•´ä¸ªçº¿ç¨‹è¢«è°ƒåº¦èµ°ï¼Œè¿™ä¸ªçº¿ç¨‹ä¸Šçš„å…¶ä»–ä»»åŠ¡ä¹Ÿæ— æ³•æ‰§è¡Œã€‚è¿™æ—¶å€™è™½ç„¶æ“ä½œç³»ç»Ÿè¿˜æ˜¯èƒ½å¤Ÿå¯¹çº¿ç¨‹è¿›è¡Œè°ƒåº¦ï¼Œä½†é€»è¾‘ä¸Šçš„è°ƒåº¦æƒå®é™…ä¸Šå°±æ˜¯ç”±<ruby>æ‰§è¡Œå™¨<rt>executor</rt></ruby>ä»»åŠ¡ä¹‹é—´æ¥è¿›è¡Œä¸€ä¸ªåä½œå¼è°ƒåº¦ã€‚è€Œæœ‰è¿™ä¸ªåŸºç¡€ä¹‹åè¿˜èƒ½å¤Ÿè¿›ä¸€æ­¥åœ°é™åˆ¶æ“ä½œç³»ç»Ÿçš„è°ƒåº¦ï¼Œå°½å¯èƒ½å¤šåœ°æŠŠè°ƒåº¦æƒè½¬ç§»åˆ°åº”ç”¨å±‚æ¥ã€‚</div><p>è€Œåä½œå¼è°ƒåº¦åˆ™æ˜¯ç”±å„ä¸ªä»»åŠ¡ä¸»åŠ¨äº¤å‡ºæ‰§è¡Œæƒï¼Œæ¯”å¦‚è¯´è¿™é‡Œå¦‚æœTask1ä¸æƒ³è¢«è°ƒåº¦èµ°ï¼Œé‚£å®ƒå¯ä»¥é€‰æ‹©ä¸äº¤å‡ºè‡ªå·±çš„æ‰§è¡Œæƒï¼Œè€ŒæŠŠè‡ªå·±å››æ¡å‘½ä»¤å…¨éƒ¨æ‰§è¡Œå®Œï¼Œç„¶åå†ç”±Task2æ¥æ‰§è¡Œï¼Œè¿™æ ·å°±èƒ½å¤Ÿæœ‰ä¸€ä¸ªç¡®å®šæ€§çš„æ‰§è¡Œæ¨¡å¼ã€‚Task1èƒ½å¤Ÿç¡®å®šè‡ªå·±åœ¨å†™yå’Œè¯»yä¹‹é—´ï¼Œè¿™ä¸ªyæ˜¯ä¸ä¼šå‘ç”Ÿå˜åŒ–çš„ã€‚è¿™æ ·èƒ½å¤Ÿå‡å°‘ç®€åŒ–æˆ‘ä»¬çš„çŠ¶æ€ç®¡ç†ï¼Œä¸éœ€è¦å»é”ä¸Šä¸€ä¸ªä¸´ç•ŒåŒºæ¥ç¡®ä¿å˜é‡æˆ–è€…èµ„æºåœ°ç‹¬å è®¿é—®ä¹‹ç±»çš„ï¼Œå› ä¸ºè¿™ä¸€ç‚¹å·²ç»åœ¨æˆ‘ä»¬æ¨¡å‹å±‚é¢å·²ç»ä¿éšœã€‚å¦å¤–ä¹Ÿèƒ½å¯¹ç³»ç»Ÿçš„å»¶æ—¶æ€§èƒ½æœ‰ä¸€å®šæå‡ã€‚</p><p>Image</p><p>åœ¨è¿™ä¸ªæ¡ä»¶ä¸‹ï¼Œæ›´è¿›ä¸€æ­¥å¯ä»¥æƒ³åˆ°å…¶å®ä¸å†éœ€è¦åŸå­æ“ä½œäº†ï¼Œæˆ–è€…æ¢å¥è¯è¯´æ¥è¯´ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åŸå­çš„ï¼Œå¯ä»¥ä¸å—é™äºç¡¬ä»¶çš„é™åˆ¶ï¼Œå¯¹ä»»æ„å¤šçš„æ•°æ®è¿›è¡Œâ€œåŸå­â€æ“ä½œï¼Œå› ä¸ºåªè¦ä¸ä¸»åŠ¨äº¤å‡ºæ‰§è¡Œæƒï¼Œé‚£è¿™ä¸ªæ“ä½œå°±å¯ä»¥ä¸€ç›´ä»¥ä¸€ç§ç¡®å®šçš„é¡ºåºæ‰§è¡Œã€‚</p><p>è¿™ä¸€ç‚¹å¸¦æ¥æœ€ç›´è§‚çš„å˜åŒ–å°±æ˜¯æˆ‘ä»¬<ruby>å·¥å…·ç»“æ„<rt>utils</rt></ruby>çš„å˜åŒ–ï¼Œæ¯”å¦‚è¯´å¸¸ç”¨çš„<code>Arc</code>(Atomic Reference Count)å¯èƒ½å°±å˜æˆ<code>Rc</code>(primitive Reference Count)ï¼Œå°±æ˜¯ä¸éœ€è¦åŸå­æ“ä½œçš„å¼•ç”¨è®¡æ•°ã€‚åŒæ—¶è¿˜æœ‰ä¸€ç±»å¤§é‡è¿ç”¨äº†åŸå­æ“ä½œçš„lock freeè¿™ç§ç»“æ„ï¼Œä¹Ÿä¸éœ€è¦æ‰å¤´å‘å»å†™è¿™ç§ä¸œè¥¿äº†ï¼Œç”¨æ™®é€šçš„å•çº¿ç¨‹ç»“æ„å°±èƒ½å¤Ÿå®Œæˆã€‚è¿˜èƒ½å¤Ÿä¿è¯è¿™ä¸ªç»“æ„ã€è¿™ä¸ªçŠ¶æ€åœ¨åŒä¸€æ—¶åˆ»ä¸ä¼šæœ‰å…¶ä»–äººæ¥è®¿é—®ã€‚</p><p>ä¸è¿‡ä¹Ÿä¸æ˜¯è¯´å®Œå…¨èƒ½å¤Ÿå»æ‰lock freeçš„ç»“æ„æˆ–è€…æ˜¯lockï¼Œæ¯•ç«ŸçŠ¶æ€ä¹‹é—´ä»¥åŠä»»åŠ¡ä¹‹é—´è¿˜æ˜¯éœ€è¦è¿›è¡ŒçŠ¶æ€åŒæ­¥çš„ï¼Œå®Œå…¨æŠ¹æ‰æ‰€æœ‰çš„å…±äº«çŠ¶æ€æ˜¯éå¸¸å›°éš¾çš„ï¼Œåœ¨ä¸¤ä¸ªå®è·µä¸­éƒ½æ˜¯é€‰æ‹©ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†æ¥å®ç°è¿™ä¸ªæ¨¡å‹ï¼Œç®—æ˜¯ä¸€ä¸ªå·¥ç¨‹ä¸Šçš„å–èˆã€‚</p><p>Image</p><p>é™¤äº†ä¸éœ€è¦åŸå­æ“ä½œï¼Œè¿˜æœ‰ä¸€ä¸ªç‰¹å¾å°±æ˜¯æ²¡æœ‰<code>Send</code>è¿™ä¸ªauto traitï¼Œå¯ä»¥çœ‹åˆ°åœ¨æ ‡å‡†åº“é‡Œé¢æ˜¯æ˜¾ç¤ºçš„ç»™<code>Rc</code>å®ç°äº†ä¸€ä¸ª<code>!Send</code>ã€‚</p><p>åœ¨æ¥ä¸‹æ¥è®²ä¹‹å‰ï¼Œå…ˆå›å¿†ä¸€ä¸‹Rustä¸­å…³äº<code>Send</code>çš„å®šä¹‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªç»“æ„èƒ½å¦å®‰å…¨åœ°è¢«å¤šä¸ªçº¿ç¨‹æ‰€æŒæœ‰ã€‚è¿™ä¸ªtraitéå¸¸å¸¸è§ï¼Œå¤§éƒ¨åˆ†åœ°æ–¹éƒ½èƒ½è§åˆ°ï¼Œæˆ–è€…è‡ªå·±å®šä¹‰è‡ªå·±çš„traitçš„æ—¶å€™ï¼Œä¹Ÿç»™å®ƒåŠ ä¸Šäº†<code>Send</code>ï¼ŒåŠ ä¸Š<code>Sync</code>ï¼Œæˆ–è€…åŠ ä¸Š<code>&#39;static</code>è¿™ç§ï¼Œå…ˆåŠ ä¸Šå†è¯´çš„è¿™äº›auto traitï¼Œä»¥åŠé‡äº‹ä¸å†³ï¼Œç”¨<code>Arc&lt;Mutex&lt;T&gt;&gt;</code>æ¥å µä½ç¼–è¯‘å™¨å…³äºç”Ÿå‘½å‘¨æœŸã€Sendä¹‹ç±»çš„æŠ¥é”™çš„åšæ³•ã€‚</p><p>è€Œä¸”ç›®å‰å¾ˆå¤šçš„åŸºç¡€è®¾æ–½éƒ½æ˜¯åœ¨<code>Send</code>è¿™ä¸€æ¡ä»¶è¢«æ»¡è¶³çš„æƒ…å†µä¸‹æ¥å®ç°çš„ï¼Œæ¯”å¦‚å¯èƒ½æˆ‘ä»¬çœ‹çœ‹è‡ªå·±çš„ä»£ç ï¼Œå¯èƒ½å¤§éƒ¨åˆ†éƒ½è¦æ±‚äº†<code>Send</code>ï¼Œæˆ–è€…æ˜¯åƒpub fn spawnè¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯å¯¹spawnè¿›è¡Œäº†futureä»¥åŠfutureçš„ç»“æœï¼Œä¹Ÿè¦æ±‚äº†ä¸€ä¸ª<code>Send</code>ã€‚</p><p>ä½†æ˜¯åœ¨æˆ‘ä»¬ç°åœ¨æ‰€è®¨è®ºçš„è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œå¯èƒ½<code>Send</code>å°±ä¸æ˜¯é‚£ä¹ˆå¸¸è§äº†ï¼Œå› ä¸ºæˆ‘ä»¬å¤§éƒ¨åˆ†çš„å·¥ä½œéƒ½æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å®Œæˆï¼Œæ²¡æœ‰è¿™æ ·ä¸€ä¸ªç»“æ„æˆ–è€…æ˜¯ä¸€ä¸ªä»»åŠ¡å‘é€åˆ°å¤šä¸ªçº¿ç¨‹çš„éœ€æ±‚ï¼Œè‡ªç„¶å°±ä¸éœ€è¦<code>Send</code>è¿™ä¸ªçº¦æŸï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸€å¼€å§‹å°±ä¸ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¸­å…±äº«å®ƒä»¬ã€‚</p><p>é‚£ä¹ˆå°‘äº†è¿™ä¸ªçº¦æŸä¹‹åï¼Œä¸ä»…æ˜¯å¸¸ç”¨çš„å·¥å…·ç±»å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿˜æœ‰ä»–ä»¬èƒŒåæ‰€éšå«çš„ç¼–ç¨‹ä¹ æƒ¯å¯èƒ½ä¹Ÿä¼šä¸åŒã€‚</p><p>Image</p><p>æœ€åä¸€ç‚¹å°±æ˜¯è·å–å¯è§æ€§çš„å¼€é”€ä¼šå‡å°‘ã€‚æ¯”å¦‚ä¹‹å‰å¯èƒ½å¸¸è§çš„æ˜¯ç”¨<code>Mutex</code>æˆ–è€…<code>RwLock</code>ï¼Œéœ€è¦å¤„ç†å¤šä¸ªèµ„æºå¯èƒ½è¢«åŒæ—¶è®¿é—®çš„æƒ…å†µã€‚ä½†åœ¨è¿™é‡Œå¯ä»¥ä»ç»“æ„ä¸Šé¿å…è¿™ç§æƒ…å†µçš„å‡ºç°ï¼Œåªéœ€è¦å»è·å¾—è¯­ä¹‰ä¸Šçš„ä¸€ä¸ªå†…éƒ¨å¯å˜æ€§å°±è¡Œäº†ã€‚ç†è®ºä¸Šæ˜¯å¯ä»¥æŠŠæ‰€æœ‰é¢å¤–çš„è¿è¡Œæ—¶æ£€æŸ¥éƒ½å»æ‰ï¼ŒåŒæ—¶è¿˜èƒ½å¤Ÿä¿è¯ä»£ç çš„å®‰å…¨ã€‚</p><p>å¦å¤–å°±æ˜¯æ‰€æœ‰çš„å·¥ä½œè´Ÿè½½ä»å¼€å§‹åˆ°å®Œæˆéƒ½åœ¨åŒä¸€ä¸ªworker threadä¸­ï¼Œè¿™ä¸ªworker threadåŒ…å«æ‰€æœ‰çš„ä¸Šä¸‹æ–‡ï¼Œä»è¿™ä¸€ç‚¹å‡ºå‘æ¥æ–¹ä¾¿åœ°å®ç°ä»»åŠ¡è°ƒåº¦å’Œèµ„æºæ§åˆ¶ç­‰åŠŸèƒ½ã€‚</p><p>Image</p><p>å‰é¢è¿™ä¹ˆå¤šè™½ç„¶ï¼Œæœ€åè¿˜æœ‰ä¸€ä¸ªä½†æ˜¯ï¼šè™½ç„¶åŒæ—¶åªä¼šæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨è¿›è¡Œï¼Œä¸å­˜åœ¨å¹¶å‘çŠ¶æ€çš„ä¿®æ”¹ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸èƒ½å¤Ÿå®Œå…¨ä¸¢æ‰é”ï¼Œå› ä¸ºåœ¨ä¸åŒçš„ä»»åŠ¡ä¹‹é—´è¿˜æ˜¯éœ€è¦åŒæ­¥çŠ¶æ€ã€‚ä¸ºäº†æ€§èƒ½é€šå¸¸ä¼šé€‰æ‹©å°†ä»»åŠ¡è¿›è¡Œç©¿æ’è¿›è¡Œï¼Œæ¯”å¦‚è¯´ä»»åŠ¡Aåœ¨ç­‰IOçš„æ—¶å€™å¯ä»¥äº¤å‡ºæ‰€æœ‰æƒï¼Œå®ƒå»åå°ç­‰IOï¼Œè®©ä»»åŠ¡Bçš„è®¡ç®—å…ˆå¼€å§‹ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯èƒ½æœ‰äº›æ“ä½œæ‰æ‰§è¡Œåˆ°äº†ä¸€åŠï¼Œæ‰€ä»¥è¦é€šè¿‡é”çš„æœºåˆ¶æ¥å‘Šè¯‰åˆ«çš„ä»»åŠ¡ï¼Œè¿™ä¸ªèµ„æºç°åœ¨ä¸èƒ½å¤Ÿè¢«è¿›è¡Œè®¿é—®/ä¿®æ”¹ã€‚</p><p>ä¸è¿‡åŒæ ·æ˜¯é”ï¼Œå•çº¿ç¨‹ä¸‹çš„é”ä¼šç¨å¾®ç®€å•ä¸€äº›ï¼Œä¸éœ€è¦æ¡ä»¶å˜é‡ä¹‹ç±»çš„æ‰‹æ®µï¼Œæ¯”å¦‚è¯´æœ€æœ´ç´ çš„å°±æ˜¯è‡ªæ—‹é”ï¼ˆç°åœ¨ä½ ä¹Ÿè®¸æ˜¯çŸ¥é“ä½ åœ¨<a target="_blank" rel="noopener" href="https://www.realworldtech.com/forum/?threadid=189711&curpostid=189723">å¹²ä»€ä¹ˆ</a>çš„ï¼‰ã€‚ä¸è¿‡æœ€å¥½è¿˜æ˜¯å’ŒRuntimeç›¸ç»“åˆæ¥å¹²æ¶‰Runtimeçš„è°ƒåº¦ï¼ˆçš„ç¡®èƒ½åœ¨user-landèƒ½åšåˆ°è¿™äº›ï¼ï¼‰ã€‚</p><p>å¦å¤–ä¸€ç‚¹éœ€è¦æ³¨æ„çš„å°±æ˜¯è¿™ä¸ªå·¥ä½œçº¿ç¨‹ä¸­ä¸èƒ½å¤Ÿæœ‰ä»»ä½•çš„blockingè¡Œä¸ºï¼Œè™½ç„¶åœ¨å¹³å¸¸çš„å¼‚æ­¥ä¸­ä¹Ÿæ˜¯éœ€è¦æ³¨æ„çš„ä¸€ç‚¹ã€‚ä½†æ˜¯åŒæ ·æ˜¯æ‰§è¡Œblockingæ“ä½œï¼Œåœ¨ä¸€å…±åªæœ‰ä¸€ä¸ªçº¿ç¨‹çš„æƒ…å†µä¸‹æŠŠè¿™ä¸ªçº¿ç¨‹blockä½å¸¦æ¥çš„åæœä¼šæ¯”å¹³å¸¸æ›´éº»çƒ¦ä¸€äº›ã€‚å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹å…¶ä»–çš„ä»»åŠ¡å¯ä»¥è¢«è°ƒåº¦åˆ°åˆ«çš„çº¿ç¨‹ä¸Šå»æ‰§è¡Œï¼Œä½†æ˜¯åœ¨è¿™é‡Œè¿™ä¸ªçº¿ç¨‹å…³è”çš„æ‰€æœ‰ä»»åŠ¡éƒ½å°†æ— æ³•è¿›è¡Œã€‚</p><p>é‚£æ˜¯ä¸æ˜¯è¿™ç§æƒ…å†µä¸‹å°±å®Œå…¨ä¸èƒ½è¿›è¡Œé˜»å¡å¼çš„IOäº†å‘¢ï¼Ÿå¦‚æœæ˜¯çº¯å¼‚æ­¥çš„IOå½“ç„¶æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚å¦‚æœä¸æ˜¯çš„è¯ï¼Œä¸€ä¸ªå¸¸è§çš„åŠæ³•å°±æ˜¯å¼€ä¸€ä¸ªæˆ–è€…å¤šä¸ªçº¿ç¨‹æ¥ä¸“é—¨æ‰§è¡Œè¿™äº›blockingçš„æ“ä½œï¼Œä¸»çº¿ç¨‹æŠŠè¿™äº›æ“ä½œç§»äº¤å‡ºå»ï¼ˆæŸç§ç¨‹åº¦ä¸Šå’Œæ¨¡æ‹Ÿå¼‚æ­¥IOå·®ä¸å¤šï¼‰æ¥ä¿è¯è‡ªå·±ä»ç„¶æ˜¯å¼‚æ­¥çš„ï¼Œè€ƒè™‘åˆ°ç¯å¢ƒä¸ç¯å¢ƒä¸èƒ½ä¸€æ¦‚è€Œè®ºï¼Œåœ¨åªèƒ½ä½¿ç”¨é˜»å¡å¼IOçš„æ—¶å€™è¿™ä¸ªæ‰‹æ®µå°±æ˜¯å¿…è¦çš„ã€‚</p><p>Image</p><h2 id="It-takes"><a href="#It-takes" class="headerlink" title="It takes"></a>It takes</h2><p>å¥½å¤„è®²äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆä»£ä»·æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>è¿™é‡Œåˆ—äº†ä¸¤ç‚¹æˆ‘è®¤ä¸ºæ¯”è¾ƒé‡è¦çš„ä»£ä»·ï¼Œä¸€ä¸ªæ˜¯ä¼ æŸ“æ€§ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯åšå¼ºåˆ¶åˆ†ç‰‡çš„éœ€æ±‚ã€‚é¦–å…ˆè¯´ä¼ æŸ“æ€§ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯Sendè¿™ä¸ªtraitçš„ä¼ æŸ“æ€§ï¼Œæˆ‘åˆšåˆšæ‰€è¯´æ•´ä¸ªç³»ç»Ÿå˜ä¸ºå•çº¿ç¨‹çš„æ¨¡å‹æ”¹åŠ¨ä¼šæ¯”è¾ƒå¤§ï¼Œä½†æ˜¯å¦‚æœåªæ”¹ä¸€éƒ¨åˆ†çš„è¯ä¹Ÿä¼šæœ‰é—®é¢˜ã€‚(todo: mesos)</p><p>æˆ‘ä»¬å…ˆæ¥å›å¿†ä¸€ä¸‹Rustä¸­æ˜¯æ€ä¹ˆå¤„ç†auto traitçš„ï¼Œè¿™é‡Œå°±ä»¥Sendä¸ºä¾‹ï¼Œå¦‚æœä¸€ä¸ªç»“æ„æ‰€æœ‰çš„fieldéƒ½æ˜¯Sendçš„ï¼Œç¼–è¯‘å™¨å°±ä¼šè‡ªåŠ¨ç»™è¿™ä¸ªç»“æ„ä¹Ÿæ¨å¯¼æˆSendã€‚åè¿‡æ¥å¦‚æœè¿™ä¸ªç»“æ„ä¸­æœ‰ä¸€ä¸ªæˆ–è€…æ˜¯å¤šä¸ªfieldï¼Œå®ƒæ˜¯Unsendçš„ï¼Œå°±å®ƒæ²¡æœ‰å®ç°Sendï¼Œé‚£ç¼–è¯‘å™¨å°±ä¼šæŠŠè¿™ä¸ªUnsendæ¨å¯¼åˆ°è¿™ä¸ªç»“æ„ä¸Šã€‚å¦‚æœä¸€ä¸ªç»“æ„ä¸­ä»»ä½•ä¸€ä¸ªåœ°æ–¹æ˜¯Unsendï¼Œé‚£è¿™ä¸ªç»“æ„å°±ä¼šè¢«æ¨å¯¼ä¸ºUnsendï¼Œè¿™ä¸ªç»“æ„ä¹Ÿå¯ä»¥æ˜¯Rustè‡ªåŠ¨ç”Ÿæˆçš„futureï¼Œé€šè¿‡asyncè¯­æ³•æ¥ç”Ÿæˆçš„futureï¼Œå®ƒæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªåŒ¿åçš„ç»“æ„ä½“ã€‚</p><p>å¦‚æœæ˜¯è¿™æ ·ï¼ŒUnsendå¯èƒ½å°±ä¼šéšç€è¿™ç§å‡½æ•°è°ƒç”¨æ‰©æ•£åˆ°æ•´ä¸ªç³»ç»Ÿã€‚ä½†è¿™æ˜¾ç„¶æ˜¯ä¸å¯æ¥å—çš„ï¼Œå› ä¸ºè¿™å°±å¼ºåˆ¶è¦æ±‚æˆ‘ä»¬æŠŠæ•´ä¸ªç³»ç»Ÿæ”¹é€ æˆå¤Ÿæ¥çº³Unsendã€‚è¿™ç§æ—¶å€™ä¸ºäº†é˜²æ­¢æŠŠUnsendæ‰©æ•£å¾—åˆ°å¤„éƒ½æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥è®©ä¸¤éƒ¨åˆ†é€šè¿‡channelæ¥äº¤æµï¼ŒæŠŠä¹‹å‰çš„æ˜¾ç¤ºå‡½æ•°è°ƒç”¨åŒ…è£…æˆä¸€ä¸ªä¸ªtaskæˆ–è€…æ˜¯requestï¼Œå°±ç±»ä¼¼äºæ¨¡æ‹ŸRpcçš„æ„Ÿè§‰ï¼Œé€šè¿‡è¿™ç§æ–¹æ³•æ¥æ„å»ºä¸€ä¸ªUnsend Boundaryï¼ŒæŠŠä¸¤éƒ¨åˆ†åˆ†ç¦»å¼€ï¼Œä»è€Œé¿å…è¿™ä¸ªé—®é¢˜ã€‚</p><p>Image</p><p>æˆ‘ä»¬CeresDBä¸­çš„Writeï¼Œå°±åˆšæ‰è¯´çš„Writeï¼Œä¹Ÿæ˜¯é€šè¿‡ä¸Šå±‚æ‰€å°è£…å¥½çš„Write requestæ¥æ‰§è¡Œæ“ä½œï¼Œä¸Šå±‚æ˜¯æŠŠè‡ªå·±æ‰€æ”¶åˆ°çš„å†™è¯·æ±‚åŒ…è£…æˆä¸€ä¸ªrequestï¼Œç„¶åé€šè¿‡channelå‘é€ç»™åº•ä¸‹å¯¹åº”çš„Workerï¼Œç„¶åè¿™ä¸ªWorkeræ‰§è¡Œå®Œå†æŠŠç»“æœå‘é€å›å»ï¼Œè¿™æ ·å°±é¿å…äº†ä¸€ä¸ªæ˜¾ç¤ºå‡½æ•°çš„è°ƒç”¨ï¼Œä¹Ÿå°±é¿å…äº†è¿™ä¸ªç±»å‹æ‰©æ•£åˆ°å…¶ä»–çš„éƒ¨åˆ†ï¼Œè€Œæ˜¯åªæŠŠå®ƒå±€é™åœ¨æˆ‘ä»¬çš„Workerä¸­ã€‚</p><p>Image</p><p>å¦å¤–ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¼ºåˆ¶åˆ†åŒºï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›å„ä¸ªçº¿ç¨‹ä¹‹é—´å°½é‡å‡å°‘äº¤æµæ¥å‡å°‘é¢å¤–å¼€é”€ï¼Œæ‰€ä»¥èƒ½å¤Ÿæœ€å¥½å°±æ˜¯é¢„å…ˆå°†å·¥ä½œè´Ÿè½½å’Œèµ„æºéƒ½è¿›è¡Œåˆ’åˆ†ï¼Œæ¯”å¦‚CeresDBæ˜¯æŒ‰ç…§è¡¨æ¥è¿›è¡Œpartitionï¼Œå¯èƒ½åˆ«çš„ç³»ç»Ÿè¿˜æŒ‰ç…§IDæˆ– Key rangeä¹‹ç±»çš„ã€‚å¯¹ä¸€äº›ç³»ç»Ÿæ¥è¯´å¯èƒ½åˆ†åŒºæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†æ˜¯å¯¹äºå¦å¤–ä¸€éƒ¨åˆ†ç³»ç»Ÿï¼Œå®ƒå¯èƒ½å°±æ¯”è¾ƒéš¾ä»¥æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„åˆ†åŒºæ–¹å¼ï¼Œé‚£æˆ‘ä»¬è¿™ç§å•çº¿ç¨‹çš„ç¼–ç¨‹æ¨¡å‹æˆ–è€…æ˜¯Thread Per Coreä¸å¤ªé€‚åˆã€‚</p><p>Image</p><p>åˆ†åŒºä¹Ÿè¦æ³¨æ„ç²’åº¦çš„é—®é¢˜ï¼Œæœ€å¥½èƒ½å¤Ÿä¿è¯æ¯ä¸ªåˆ†åŒºä¹‹é—´ä¸ä¼šç›¸å·®å¤ªå¤šï¼Œæˆ–è€…æ˜¯æ¯ä¸ªåˆ†åŒºå…ƒç´ çš„åŠ›åº¦ä¹Ÿä¸ä¼šç›¸å·®å¤ªå¤§ï¼Œæ¶‰åŠåˆ°åˆ†åŒºçš„ç³»ç»Ÿé€šå¸¸éƒ½ä¼šé‡åˆ°åˆ†åŒºè´Ÿè½½ä¸å‡çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸ºäº†èƒ½å¤Ÿçµæ´»åœ°è°ƒåº¦ï¼Œèƒ½å¤Ÿæ ¹æ®è´Ÿè·æ¥åŠ¨æ€åœ°è°ƒæ•´partitionï¼Œå°±è¦æ±‚æ¯ä¸ªåˆ†åŒºçš„å•å…ƒä¸ä¼šå¤ªå¤§ã€‚</p><p>å¦å¤–ï¼Œè¿˜è¦æ±‚æœ¬èº«èƒ½å¤Ÿæ‰§è¡Œè¿™ä¸ªRepartitionï¼Œè¿™ä¸ªå…¶å®å¤§éƒ¨åˆ†æ˜¯å·¥ç¨‹ä¸Šçš„é—®é¢˜ï¼Œå¯¹äºçº¿ç¨‹æœ¬èº«æ¥è¯´ï¼Œå®ƒæ‰€ä»£è¡¨çš„æ˜¯ä¸€ä¸ªè®¡ç®—èµ„æºï¼Œæ˜¯æ— çŠ¶æ€çš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œåˆ’åˆ†ï¼Œèƒ½å¾ˆæ–¹ä¾¿åœ°æŠŠæŸæ¡æŒ‡ä»¤åœ¨è¿™ä¸ªçº¿ç¨‹æˆ–è€…è¿™ä¸ªæ ¸ä¸Šæ‰§è¡Œï¼Œæˆ–è€…``æŠŠå®ƒè°ƒåº¦åˆ°å¦å¤–ä¸€ä¸ªçº¿ç¨‹æˆ–è€…å¦å¤–ä¸€ä¸ªæ ¸ä¸Šæ‰§è¡Œï¼Œè¿™ä¸ªæ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ã€‚</p><p>ä½†æ˜¯ä¸€ä¸ªä»»åŠ¡é€šå¸¸èƒŒåè¿˜å¯¹åº”äº†ä¸€äº›çŠ¶æ€å’Œèµ„æºï¼Œè¿™äº›ç›¸è¾ƒäºä»»åŠ¡æœ¬èº«æ˜¯æ›´éš¾ä»¥è°ƒåº¦çš„ï¼Œç‰¹åˆ«æ˜¯å¦‚æœæ¶‰åŠåˆ°æŒä¹…åŒ–çš„çŠ¶æ€ï¼Œæ¯”å¦‚æŠŠä»€ä¹ˆä¸œè¥¿å†™åˆ°ç£ç›˜ä¸Šï¼Œé‚£æˆ‘ä»¬è¿™ä¸ªä¸‹åœ¨è¿™ä¸ªç£ç›˜ï¼Œå¦å¤–ä¸€ä¸ªpartitionåœ¨å¦å¤–ä¸€ä¸ªç£ç›˜ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šè¦æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„é€»è¾‘ã€‚åŒæ—¶ä¸Šå±‚çš„åˆ†ç»„è·¯ç”±ä¹Ÿè¦ä¿è¯è·¯ç”±çš„æ­£ç¡®æ€§ã€‚</p><h1 id="How-to"><a href="#How-to" class="headerlink" title="How to"></a>How to</h1><p>é‚£ä¹ˆæœ€åå‡å¦‚åœºæ™¯ä¹Ÿå¾ˆé€‚åˆï¼Œæƒ³ä½“éªŒä¸€ä¸‹å®ƒå¸¦æ¥èˆ¹æ–°ä½“éªŒå’Œæ€§èƒ½æå‡ï¼Œé‚£è¦æ€ä¹ˆæ ·å¼€å§‹å¼€å‘å‘¢ï¼ŸFirst ofè¿™ä¸ªè¦æ±‚çº¯å¼‚æ­¥çš„ä»£ç ï¼Œæ‰€ä»¥ç¦»ä¸å¼€<code>async</code>/<code>.await</code>ã€‚</p><p>å…ˆçœ‹ä¸€ä¸‹æœ€é‡è¦çš„Runtimeï¼Œç›®å‰ä¸€äº›å¸¸ç”¨çš„Runtimeéƒ½æœ‰æä¾›ä¸è¦æ±‚<code>Send</code>çš„æ¥å£ï¼Œæ¯”å¦‚è¯´tokioå’Œfuturesï¼Œéƒ½æœ‰spawn localçš„æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°å’Œåˆšåˆšçš„spawnçš„åŒºåˆ«å°±æ˜¯æˆ‘ä»¬è¿™é‡Œå‡½æ•°ç­¾åä¸Šä¸å†è¦æ±‚Sendè¿™ä¸ªboundäº†ã€‚</p><p>å¦å¤–ä¹Ÿæœ‰ä¸€äº›ä¸“é—¨ä¸ºThread Per Coreæ¨¡å‹è®¾è®¡çš„è¿è¡Œæ—¶ï¼Œæ¯”å¦‚è¯´glommioå’Œmonoioï¼Œä¸è¿‡è¿™ä¸¤ä¸ªé™¤äº†Thread Per Coreä¹‹å¤–è¿˜ç»‘å®šäº†io_uringä½œä¸ºIOæ¥å£ï¼Œè™½ç„¶éå¸¸åˆç†ï¼Œå› ä¸ºæˆ‘ä»¬æœ¬èº«å°±æ˜¯æœ€å¥½æ˜¯èƒ½å¤Ÿå’Œå¼‚æ­¥IOç›¸ç»“åˆä½¿ç”¨ï¼Œä½†æ˜¯ä¹Ÿè®©å®ƒæ²¡æœ‰é‚£ä¹ˆçµæ´»ï¼Œå› ä¸ºä½œä¸ºä¸€ä¸ªè¿˜æ¯”è¾ƒæ–°çš„ç³»ç»Ÿç‰¹æ€§ï¼Œå¯èƒ½å¾ˆå¤šå­˜é‡çš„æœåŠ¡å™¨ç³»ç»Ÿç‰ˆæœ¬è¿˜æ²¡æœ‰å‡çº§ï¼Œå¯èƒ½å°±ä¼šéœ€è¦ç”¨åˆ°æˆ‘ä»¬åˆšåˆšæåˆ°çš„é‚£äº›æ‰‹æ®µå»åšä¸€ä¸ªé€‚é…ã€‚</p><p>åœ¨æˆ‘ä»¬çš„å®è·µä¸­ï¼Œä¹Ÿæœ‰é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œä¸ºäº†èƒ½å¤Ÿå…¼å®¹éé˜»å¡çš„IOæ¥å£ï¼Œéœ€è¦ç”¨åˆ°å‰é¢æåˆ°Blockingçš„çº¿ç¨‹æ–¹å¼ï¼Œå¯èƒ½è¿˜è¦å†åšä¸€äº›hackæ¥é€‚é…ï¼ŒæŠŠå®ƒè¿ç§»åˆ°å¸¸ç”¨çš„Runtimeä¸Šã€‚</p><p>è¿˜æœ‰æ ‡å‡†åº“ä¸­çš„ä¸€äº›å·¥å…·ç±»ä¹Ÿèƒ½å¤Ÿæ´¾ä¸Šç”¨åœºï¼Œæ¯”å¦‚ç”¨TLSä»£æ›¿ä¸€äº›å…¨å±€å˜é‡ï¼Œå®ƒä»¬ä¹Ÿå±äºè¢«åˆ†å¼€çš„â€œçŠ¶æ€â€ã€‚åœ¨åˆšåˆšæåˆ°æˆ‘ä»¬ä½¿ç”¨tokioæ¥æ¨¡æ‹ŸThread Per Core Runtimeçš„æ—¶å€™ï¼Œä¹Ÿæœ‰ä½¿ç”¨åˆ°TLSï¼Œå°±æ˜¯æŠŠæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ªæ­£å¸¸çš„tokio Runtimeï¼Œç„¶åæŠŠå®ƒæ”¾åœ¨TLSé‡Œé¢æ¥æ¨¡æ‹Ÿä¸€ä¸ªThread Per Core Runtimeã€‚</p><p>æ­¤å¤–è¿˜æœ‰Cellç±»ï¼Œä¸»è¦å°±æ˜¯ç”¨æ¥è·å–å†…éƒ¨å¯å˜æ€§çš„ï¼Œç”¨æ¥ä»£æ›¿é”ï¼Œåœ¨æ— åºç«äº‰çš„åœºæ™¯ä¸‹ä¸€ä¸ªæ¯”è¾ƒå¼€é”€æ›´å°çš„å†…éƒ¨å¯å˜æ€§çš„è·å–ã€‚</p><p>ä¸è¿‡è¿™é‡ŒRefCellå…¶å®è¿˜æ¶‰åŠåˆ°ä¸€ä¸ªåŠ¨æ€è¿è¡Œæ—¶çš„æ£€æŸ¥ï¼Œå°±æ˜¯å®ƒä¼šæ£€æŸ¥æˆ‘è¿™ä¸ªæ˜¯å¦æœ‰å…¶ä»–çš„ä¹ŸåŒæ—¶æŒæœ‰è¿™ä¸ªå¯å˜æ€§ï¼Œæœ‰çš„è¯å®ƒå°±ä¼šå¯¼è‡´panicã€‚äº‹å®ä¸Šåœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œå°±åƒåˆšæ‰æåˆ°çš„ä¸€æ ·ï¼Œæ˜¯èƒ½å¤Ÿåœ¨è®¾è®¡çš„æ—¶å€™å°±å®Œå…¨è§„é¿æ‰è¿™ä¸ªè¿è¡Œæ—¶çš„æ£€æŸ¥çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç†è®ºä¸ŠRefCellè¿˜å¯ä»¥æ›´è¿›ä¸€æ­¥æä¾›ä¸€ä¸ªä¿è¯ã€‚</p><p>é™¤äº†è¿™äº›ï¼Œè¿˜æœ‰ä¸€äº›å¹³æ—¶çš„å¼‚æ­¥ç¼–ç çš„æ³¨æ„äº‹é¡¹ä¹Ÿä¼šå˜å¾—å¾ˆé‡è¦ï¼Œæ¯”å¦‚å‰é¢æåˆ°çš„Blockingæ“ä½œï¼Œæˆ–è€…Clippyä¸­çš„ä¸€äº›Lintã€‚æ¯”å¦‚Clippyä¸­è¿™ä¸ªLintï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç”¨RefCellæ¥å¤§é‡ä»£æ›¿é”ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„awaitçš„æ—¶æœºï¼Œä»¥è¿™ä¸ªfnå‡½æ•°ä¸ºä¾‹ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨ç¬¬ä¸€è¡Œè·å–äº†xçš„å¯å˜å¼•ç”¨ï¼Œä½†æ˜¯åœ¨ç¬¬äºŒè¡ŒæŠŠå®ƒawaitèµ°ï¼Œè¿™ä¸ªawaitç›¸å½“äºäº¤å‡ºäº†æˆ‘ä»¬è¿™ä¸ªå‡½æ•°çš„æ‰§è¡Œæƒï¼Œè¿™ä¸ªæ—¶å€™æ˜¯èƒ½å¤ŸæŠŠå…¶ä»–çš„ä»»åŠ¡è°ƒåº¦è¿‡æ¥çš„ã€‚å¦‚æœæœ‰ç¬¬äºŒä¸ªfnå‡½æ•°åœ¨è¿™é‡Œè¿›å…¥äº†ï¼Œå®ƒåœ¨å°è¯•å»è·å–xçš„å¯å˜å¼•ç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±ç›¸å½“äºä¸€ä¸ªå¯å˜å¼•ç”¨è¢«ä¸¤ä¸ªå‡½æ•°æ‰€æŒæœ‰ï¼Œè¿™é‡Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªpanicã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ³¨æ„awaitçš„æ—¶æœºï¼Œawaitå…¶å®å°±æ˜¯éšå¼åœ°ä¼šäº¤å‡ºæ‰§è¡Œæƒã€‚</p><p>é™¤äº†è¿™äº›ï¼Œè¿˜æœ‰å¾ˆå¤šå¹³å¸¸å¼‚æ­¥ç¼–ç çš„æ—¶å€™é‚£äº›æ³¨æ„äº‹é¡¹ï¼Œåœ¨è¿™é‡Œå¯èƒ½å°±æ˜¯ä¼šå˜å¾—æ›´åŠ é‡è¦ï¼Œå› ä¸ºè¿èƒŒè¿™äº›äº‹é¡¹ï¼Œå¯èƒ½ä¼šå¸¦æ¥ä¸€äº›æ›´åŠ ä¸¥é‡çš„åæœã€‚å°±æ¯”å¦‚è¯´åˆšåˆšçš„Blockingï¼Œæˆ–è€…æ˜¯è¿™é‡Œçš„await holding refcellã€‚</p><p>è™½ç„¶ç›®å‰å·²ç»æœ‰å¾ˆå¤šåŸºç¡€çš„æ–¹å¼èƒ½å¤Ÿè®©æˆ‘ä»¬ç›¸å¯¹å®Œæ•´åœ°å®ç°è¿™ä¸€ä¸ªç‰¹æ€§ï¼Œæˆ–è€…è¯´è¿™ä¸€ä¸ªæ¨¡å‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥ä»ç”Ÿæ€æˆ–è€…æ˜¯åŸºç¡€åº“çš„è§’åº¦åšå¾—æ›´å¥½ã€‚æ¯”å¦‚è¯´åœ¨è®¾è®¡çš„æ—¶å€™å°±è€ƒè™‘èƒ½å¤Ÿä¿è¯ç‹¬å è®¿é—®è¿™ä¸€æ¡ä»¶çš„åŸºç¡€ç±»ï¼Œæ¯”å¦‚è¯´ä»channelåˆ°Runtimeç­‰ç­‰ï¼Œè¿˜èƒ½å¤Ÿæ›´è¿›ä¸€æ­¥åœ°å‹æ¦¨æ€§èƒ½ï¼Œä»¥åŠç°åœ¨å¯èƒ½åˆ°å¤„éƒ½è¦æ±‚çš„Sendï¼Œé‚£æ˜¯å¦åœ¨è®¾è®¡çš„æ—¶å€™æˆ‘ä»¬å†åŠ ä¸ŠSendè¿™ä¸ªtrait boundçš„æ—¶å€™ï¼Œæƒ³ä¸€æƒ³è¿™é‡Œæ˜¯å¦çœŸçš„éœ€è¦ã€‚</p><p>å¦‚æœæ˜¯ä¸€äº›ç®€å•çš„åœºæ™¯åœ¨ç›®å‰çš„ç”Ÿæ€ä¸­å·²ç»èƒ½å¤ŸåŸºäºTPCæ¨¡å‹æ„å»ºä¸€ä¸ªåŸºæœ¬å®Œæ•´çš„åº”ç”¨äº†ï¼Œä½†æ˜¯æƒ³è¦è½»æ¾ä¸Šæ‰‹ä»¥åŠæœ€å¤§åœ°å‘æŒ¥ä¼˜åŠ¿è¿˜éœ€è¦ä¸€äº›å‘å±•æ—¶é—´ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;è¿™ç¯‡æ˜¯ä» Rust China Conf 2022 çš„ talk æ•´ç†æ¥çš„ï¼ˆæ ¡å¯¹å¬å†™è½¬å½•ç¨¿å¥½éº»çƒ¦â€¦â€¦&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;ï¼ˆè¿˜æ²¡æ ¡å¯¹å®Œï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ä»‹ç»ä¸€ä¸‹å•çº¿ç¨‹æ¨¡å¼ä¸¤ä¸ªåœ¨ç”Ÿäº§ä¸­çš„ä¾‹å­ï¼Œ&lt;</summary>
      
    
    
    
    
    <category term="Rust" scheme="https://waynexia.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>reMarkable2 ä½¿ç”¨ä½“éªŒ</title>
    <link href="https://waynexia.github.io/2022/05/remarkable2/"/>
    <id>https://waynexia.github.io/2022/05/remarkable2/</id>
    <published>2022-05-04T01:37:44.000Z</published>
    <updated>2023-11-23T08:35:22.628Z</updated>
    
    <content type="html"><![CDATA[<p><em>é¢˜å›¾æ¥è‡ª<a href="remarkable.com">remarkable.com</a></em></p><h1 id="åˆä¸€æ¬¡å¹¿å‘ŠæŠ•æ”¾"><a href="#åˆä¸€æ¬¡å¹¿å‘ŠæŠ•æ”¾" class="headerlink" title="åˆä¸€æ¬¡å¹¿å‘ŠæŠ•æ”¾"></a>åˆä¸€æ¬¡å¹¿å‘ŠæŠ•æ”¾</h1><p>çŸ¥é“reMarkable2æ˜¯åœ¨æŸå¤©åˆ·æ¨çš„æ—¶å€™çœ‹è§äº†ä»–ä»¬æŠ•æ”¾çš„å¹¿å‘Šï¼Œçœ‹äº†ä¸¤å¤©ä¹‹åå°±å‰æ‰‹äº†ï¼Œéå¸¸å†²åŠ¨ã€‚ä¹‹å‰æ€€ç–‘å¹¿å‘Šæ˜¯ä¸æ˜¯çœŸçš„é‚£ä¹ˆæœ‰ç”¨ï¼Œæœ€åæ²¡æƒ³åˆ°ç”µè§†è´­ç‰©çš„ç«Ÿæ˜¯æˆ‘è‡ªå·±ã€‚</p><p>ä¸€ç›´è§‰å¾—çœ‹PDFå¾ˆä¸çˆ½ã€‚æ‰‹ä¸Šçš„è®¾å¤‡æœ‰å¤ªå°çš„kindleï¼Œå¤ªé‡çš„surfaceå’Œæ²¡æ„Ÿè§‰çš„ç”µè„‘å±å¹•ã€‚ä¸€ç›´æœ‰ç‚¹æƒ³å†æ•´ä¸€ä¸ªï¼Œä½†æ˜¯ä¹Ÿä¸€ç›´æ²¡ç‰¹åˆ«æƒ³ä¸‹æ‰‹ã€‚dpt-rp1çœ‹èµ·æ¥ç¡®å®ä¹Ÿå¾ˆä¸é”™ï¼Œä¸ä¸€å®šè¦å¢¨æ°´å±æ‰€ä»¥padä¹Ÿåœ¨è€ƒè™‘èŒƒå›´ã€‚è¿™ç§æƒ…å†µä¸‹å¯èƒ½æ¥ä¸‹æ¥åº”è¯¥è¯´çš„æ˜¯reMarkable2ä¸ºä»€ä¹ˆä¸ä¸€æ ·ï¼Œå¯æƒœçš„æ˜¯æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆã€‚å®ƒçš„å‡ ä¸ªäº®ç‚¹æ¯”å¦‚è–„å’Œæ‰‹å†™ä½“éªŒå¯¹æˆ‘éƒ½åªç®—â€œæœ‰äº†æ›´å¥½ï¼Œæ²¡æœ‰ä¹Ÿæ— æ‰€è°“â€çš„èŒƒç•´ï¼Œåªèƒ½è¯´æ˜¯å¹¿å‘ŠæŠ•æ”¾çš„æˆåŠŸå§ã€‚</p><h1 id="æ§½ç‚¹"><a href="#æ§½ç‚¹" class="headerlink" title="æ§½ç‚¹"></a>æ§½ç‚¹</h1><p>å› ä¸ºå…¥æ‰‹çš„æ—¶å€™å¯¹å®ƒçš„æœŸæœ›æ›´åå‘äºä¸€ä¸ªé˜…è¯»å™¨ï¼Œå¼€ç®±ç”¨äº†å‡ å¤©å°±æœ‰å¥½å¤šæƒ³åæ§½çš„åœ°æ–¹â€¦â€¦</p><ul><li><p>ç¿»ç›–æ­»è´µä½†æ˜¯åŠŸèƒ½éå¸¸å°‘ã€‚<br>æˆ‘è§‰å¾—è¿™ä¸ªç›–å­å°±æ˜¯ä¸€ä¸ªå¸¦ä¸¤å—ç£é“çš„å£³ï¼Œå®Œå…¨ä¸èƒ½ç®—æ˜¯ç”µå­é…ä»¶ã€‚æœºèº«ä¾§é¢ç•™æœ‰å‡ ä¸ªé‡‘å±è§¦ç‚¹ï¼Œä½†æ˜¯è¿™ä¸ªå£³å¯¹åº”çš„ä½ç½®å±…ç„¶ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚è€Œä¸”å£³æœ¬èº«å°é¢æœ‰ç£å¸ï¼Œä½†æ˜¯æœºå™¨ä¸èƒ½å“åº”ç¿»ç›–åŠ¨ä½œâ€¦â€¦è®©æŒ‰é”®ç„¦è™‘çš„äººéå¸¸éš¾å—ã€‚</p></li><li><p>æ²¡æœ‰èƒŒå…‰ç¯ã€‚<br>ä¸¤ä»£éƒ½æ²¡æœ‰ï¼Œä¸çŸ¥é“æœ‰ä»€ä¹ˆç‰¹åˆ«çš„åŸå› ã€‚åœ¨æˆ‘çš„æ¡Œé¢ç¯å¢ƒä¸Šåªæœ‰ä¸€ä¸ªå±å¹•ç¯ï¼Œæ‰€ä»¥å½“æ™šä¸Šé åœ¨æ¤…å­ä¸Šä¸å¼€é¢å¤–å…‰æºåŸºæœ¬ä¸èƒ½çœ‹ã€‚ç»è¿‡äº†ä¸€ä¸ªé˜´å¤©ï¼Œå®¤å†…å…‰çº¿ç¨å¾®æš—ä¸€ç‚¹å°±è¦å¼€é¡¶ç¯ä½¿ç”¨äº†ã€‚</p></li><li><p>å±å¹•åˆ†è¾¨ç‡ä½ã€‚<br>è¿™ä¸ªä¸»æ¨çš„æ˜¯åƒçœŸçº¸ä¸€æ ·çš„ä¹¦å†™ä½“éªŒï¼Œä½†æ˜¯è°çš„çº¸èƒ½å¤Ÿâ€¦â€¦å†™å‡ºé”¯é½¿ï¼Ÿè®¾å¤‡ç¬¬ä¸€æ¬¡å¼€æœºçš„ç¬¬ä¸€ä¸ªç¯èŠ‚å°±æ˜¯è®©ä½ æ‹¿ç¬”ä½“éªŒä¸€ä¸‹ï¼Œç»“æœæˆ‘ä¸€åˆ’æ‹‰å‡ºæ¥ä¸€æ¡é”¯é½¿ï¼Œå½“åœºèšŒåŸ ä½äº†ã€‚</p></li><li><p>è½¯ä»¶ï¼ˆå›ºä»¶ï¼‰ä½“éªŒå¾ˆå·®ï¼Œè¿™ä¸ªåˆ†ä¸¤æ–¹é¢ã€‚</p><ul><li>é¦–å…ˆæˆ‘è§‰å¾—è¿™ä¸ªç³»ç»Ÿï¼ˆv2.12.3ï¼‰çš„åŸºæœ¬åŠŸèƒ½æ˜¯ç¼ºå¤±çš„ï¼Œæ¯”å¦‚ç¬”å±…ç„¶ä¸æ”¯æŒè°ƒèŠ‚å‹æ„Ÿçµæ•åº¦ï¼Œå¯¼è‡´æˆ‘åœ¨ä¹ æƒ¯çš„åŠ›é“ä¸‹åªæœ‰ä¸€ç§ç¬”è§¦èƒ½ä½¿ç”¨;è€Œä¸”ä½ ç”šè‡³ä¸èƒ½åœ¨PDFä¸Šé€‰æ‹©æ–‡å­—ï¼Œsuch a REMARKABLE tabletã€‚</li><li>ä»¥åŠä¸é‚£ä¹ˆåŸºæœ¬çš„åŠŸèƒ½ä¹Ÿæ˜¯ç¼ºå¤±çš„ï¼ˆå¯¹äºä¸æƒ³æ¯ä¸ªæœˆå†å¤šæ58.88 hkdä¸”ä¸æƒ³æŠ˜è…¾ç”¨æˆ·æ¥è¯´ï¼‰ã€‚é‚®ä»¶ä¼ è¾“ã€ä¸‰æ–¹å­˜å‚¨å’Œå±å¹•åˆ†äº«è¿™äº›åŠŸèƒ½éƒ½è¢«<em>remarkable.com</em>åˆ—ä¸ºäº†ä»˜è´¹è®¢é˜…å†…å®¹ã€‚</li></ul></li></ul><h1 id="è¿˜ä¸é”™çš„åœ°æ–¹"><a href="#è¿˜ä¸é”™çš„åœ°æ–¹" class="headerlink" title="è¿˜ä¸é”™çš„åœ°æ–¹"></a>è¿˜ä¸é”™çš„åœ°æ–¹</h1><p>ä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯æ‹¿æ¥çœ‹PDFï¼Œæ¯”èµ·æˆ‘çš„voyageç¡®å®å¤§äº†ä¸å°‘ï¼Œå±å¹•å°æ˜¯voyageçœ‹ä¸æ¥çš„å”¯ä¸€å› ç´ ã€‚ä½†æ˜¯å®é™…æ‹¿A4çº¸æ¯”äº†ä¸‹æ‰å‘ç°rm2ä¹Ÿåªä»…ä»…æ¯”A5å°ºå¯¸ç¨å®½ä¸€äº›ï¼Œä½†æ˜¯è£æ‰é¡µé¢è¾¹ç¼˜çš„ç•™ç™½ä¹‹åä¹Ÿèƒ½å¤Ÿå¾ˆèˆ’æœåœ°å±•ç¤ºä¸€é¡µçº¸çš„å†…å®¹äº†ï¼Œå½“ç„¶å­—è¿˜æ˜¯å˜å°äº†ä¸€äº›ã€‚</p>    <figure class="figure-image">      <img src="compare.jpg" alt="å’Œkindle voyageä»¥åŠA5çº¸çš„å¯¹æ¯”ã€‚åŸºæœ¬åªæ¯”A5å®½å‡ æ¯«ç±³" width="100%" height="100% loading="lazy" />      <figcaption>å’Œkindle voyageä»¥åŠA5çº¸çš„å¯¹æ¯”ã€‚åŸºæœ¬åªæ¯”A5å®½å‡ æ¯«ç±³</figcaption>    </figure>  <p>åœ¨è¿™ä¹‹å‰æƒ³è¦åœ¨kindleä¸Šçœ‹çº¸èˆ’æœä¸€ç‚¹ï¼Œå°è¯•è¿‡å„ç§æ–¹å¼è¯•å›¾é‡æ’PDFæ¥é€‚åº”kindleï¼Œä¹Ÿè®¸ç®€å•åœ°è£ä¸€ä¸‹åŠ ä¸Šæ¨ªå±å°±èƒ½è®©ä½“éªŒæå‡ä¸å°‘ã€‚</p><p>æ‹¿ç€ç¬”çš„æ—¶å€™ä¼šè‡ªç„¶åœ°æƒ³å†™å†™ç”»ç”»ã€‚å†™å¾—å¤ªä¸‘å°±ä¸å±•ç¤ºäº†ï¼Œç”»å°±åƒä¸‹é¢è¿™æ ·ï¼Œéå¸¸è‰ºæœ¯ã€‚ä»”ç»†ç ”ç©¶äº†ä¸€ä¸‹ä¸ºä»€ä¹ˆåœ¨æ¿å­ä¸Šé¢å†™å­—å°±è¿™ä¹ˆéš¾çœ‹ï¼Œæœ€åå¾—å‡ºçš„ç»“è®ºæ˜¯æ¿å­çš„é—®é¢˜<del>ï¼ŒçœŸçš„</del>ã€‚å› ä¸ºå±å¹•æœ‰ä¸€å®šåšåº¦ï¼Œç¬”å°–æ¥è§¦åˆ°çš„ä½ç½®å’Œè®¾å¤‡ç”»å‡ºç¬”è§¦çš„ä½ç½®ä¹‹é—´å­˜åœ¨ä¸€ä¸ªå‚ç›´ä¸Šçš„è·ç¦»ã€‚å¦‚æœçœ¼ç›çœ‹æ¿å­çš„æ—¶å€™ä¸æ¿å¹³é¢æ³•çº¿å­˜åœ¨ä¸€ä¸ªè§’åº¦ï¼Œå°±ä¼šåœ¨è§†è§‰ä¸Šå¸¦æ¥ä¸€ä¸ªç¬”å°–å’Œç¬”è§¦çš„åå·®é‡ï¼Œæ„Ÿè§‰æœ€æ˜æ˜¾çš„æ˜¯ç”»ç”»çš„æ—¶å€™ä½ å¾ˆéš¾è®©ä¸¤æ¡çº¿å®Œç¾åœ°è¿æ¥èµ·æ¥ï¼Œå› ä¸ºä½ è§‰å¾—ä½ åº”è¯¥è½ç¬”çš„åœ°æ–¹å¹¶ä¸æ˜¯å¸¦ç”µç¢³ç²‰å‡ºæ¥çš„ä½ç½®ã€‚ç”šè‡³åœ¨Redditä¸Šçœ‹åˆ°ä¸€ä¸ªadviceï¼Œå¦‚æœä½ æ˜¯å³æ’‡å­çš„è¯å¯ä»¥å°è¯•å°†è®¾å¤‡çš„åå¥½è®¾ç½®è°ƒåˆ°å·¦æ’‡å­ï¼Œè¿™æ ·ç³»ç»Ÿå¯¹ç¬”è§¦è¿›è¡Œçš„ä¿®æ­£èƒ½å¤Ÿå‡è½»è¿™ä¸ªåç§»ç°è±¡ã€‚</p>    <figure class="figure-image">      <img src="doraemon.png" alt="ç”»" width="100%" height="100% loading="lazy" />      <figcaption>ç”»</figcaption>    </figure>  <p>è€Œæˆ‘çš„å¯¹äºä¸ºä»€ä¹ˆå†™å­—ä¼šå˜ä¸‘çš„ç»“è®ºæ˜¯ï¼Œåœ¨æˆ‘å†™å­—çš„æ—¶å€™æ‰‹ä¼šå°è¯•å»å¼¥è¡¥è¿™ä¸ªåå·®é‡ä»è€Œå¯¼è‡´å†™å‡ºæ¥çš„ä¸œè¥¿å˜å½¢<del>ï¼ˆé€æ¸è¿œç¦»å°æ ‡é¢˜ï¼‰</del>ã€‚</p><p>å› ä¸ºç”»ç”»æŠ€èƒ½å®åœ¨å¤ªå·®ï¼Œä¸å¤ªå¥½è¯´çœŸæ‹¿è¿™ä¸ªå½“ç”»æ¿ä¼šæ˜¯ä»€ä¹ˆä½“éªŒï¼Œä¸è¿‡è¿˜æ˜¯è¦æä¸€ä¸‹ç”¨äº†ä¸€æ®µæ—¶é—´æ„Ÿè§‰åˆ°çš„è¿™ä¸ªè®¾å¤‡åœ¨è½¯ä»¶æ–¹é¢éš¾å¾—åšäº†çš„ä¸€ä»¶æå‡ä½“éªŒçš„åŠŸèƒ½ã€‚åœ¨ç”¨ç¬”ç¼–è¾‘çš„æ—¶å€™å¯ä»¥ä½¿ç”¨å›¾å±‚åŠŸèƒ½ï¼Œæ¯”å¦‚ä¸Šé¢çš„Doraemonå’ŒNobitaå°±æ˜¯å…ˆç”»å¥½çœ¼çœ¶ï¼Œå†æ‹‰åˆ°å¦ä¸€ä¸ªå›¾å±‚å»æ¶‚çœ¼ç å­ï¼Œå¯ä»¥é˜²æ­¢ç”¨æ©¡çš®æ“¦çš„æ—¶å€™æŠŠå…¶ä»–å·²ç»ç”»å¥½çš„åœ°æ–¹æ“¦æ‰ã€‚</p><p>ä¸è¿‡åœ¨å¯¼å‡ºåˆ°åˆ«çš„è®¾å¤‡ä¸Šçš„æ—¶å€™ä¼šå‘ç°ç¬”è¿¹æœ‰äº›å¥‡æ€ªï¼Œæœ‰ç‚¹å–·ç²‰é¢œæ–™çš„æ„Ÿè§‰ã€‚å°±æ˜¯ä»ç“¶å­é‡Œé¢å–·å‡ºæ¥æ˜¯ç²‰æœ«ï¼Œæ‹¿ç«åŠ çƒ­ä¸€ä¸‹å°±ä¼šèåŒ–æˆé¢œæ–™é•€è†œçš„é‚£ç§ã€‚åœ¨è®¾å¤‡ä¸Šçœ‹èµ·æ¥åªæ˜¯æ¯”è¾ƒæµ…çš„ç¬”è¿¹ï¼Œå¯¼å‡ºæ¥ä¹‹åä¼šå˜å¾—å¥‡æ€ªåœ°åœ†æ¶¦èµ·æ¥ã€‚</p><h1 id="Workflow"><a href="#Workflow" class="headerlink" title="Workflow"></a>Workflow</h1><p>å¦‚æœæ˜¯çœ‹çº¸çš„è¯å°±è¾¹çœ‹è¾¹å†™å†™ç”»ç”»ï¼Œä¸è¿‡ç”±äºæ‰‹å†™è¯†åˆ«å·®ä¸å¤šå°±æ˜¯åªæœ‰è‹±æ–‡ï¼Œæ‰€ä»¥å¾—è¦èµ›åšèªŠå†™ä¸€ä¸‹ã€‚ä»ç™½çº¸å¼€å§‹çš„è‰ç¨¿å°±å½“ä½œæ˜¯å†™åœ¨çº¸ä¸Šäº†ï¼Œæœ€åè¿˜æ˜¯æ‹¿ç”»å›¾æ¿é‡æ–°ç”»ä¸€æ¬¡ï¼ˆå½“ç„¶æ‰‹ç»˜çš„ä¸œè¥¿ä¹Ÿå¤ªéš¾çœ‹è€Œä¸èƒ½ç›´æ¥æ‹¿å‡ºæ¥ç”¨ï¼‰ã€‚æ‹¿è¿™ä¸ªå†™å†™ç”»ç”»çš„æ—¶å€™ä½“éªŒè¿˜è¡Œï¼Œä¸åŒçš„äº‹æƒ…å•ç‹¬å¼€ä¸ä¸€æ ·ç¬”è®°æœ¬ï¼Œå¯ä»¥é¿å…è¿‡äº†ä¸€æ®µæ—¶é—´æœ›ç€ä¸€å †çº¸å¤´ç—›ï¼Œç°åœ¨æ¡Œé¢åŸºæœ¬å¯ä»¥ä¸ç”¨æ”¾a4çº¸äº†ã€‚</p><p>ä¹Ÿè®¸å› ä¸ºconnectæ˜¯ä»–ä»¬åé¢åŠ çš„åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨21å¹´10æœˆä¹‹å‰ä¹°çš„å¯ä»¥è·å¾—æ— é™çš„free connectæƒé™ã€‚ä½†æ˜¯ä»–è®¤è¯è´­ä¹°ä¿¡æ¯çš„æ–¹å¼éå¸¸åŸå§‹ï¼Œæ˜¯è®©ä½ æä¾›è®¢å•é‚®ä»¶çš„è®¢å•å·ä»–ä»¬æ¥äººå·¥ç¡®è®¤ï¼Œäºæ˜¯æ‰¾å½“æ—¶è´­ä¹°çš„åº—å®¶è¦äº†ä¸ªè€è®¢å•é€šè¿‡äº†éªŒè¯ï¼ˆåº—å®¶ç›´æ¥ç»™äº†æˆ‘ä¸€ä¸ªä¸¤å¹´å‰çš„è®¢å•ï¼Œé‚®ä»¶ä¸Šé¢å†™çš„æ˜¯ç¬¬å››æ‰¹è´§â€¦â€¦ï¼‰ã€‚è€Œconnectè§£é”çš„åŠŸèƒ½æˆ‘è§‰å¾—æ¯”è¾ƒæœ‰ç”¨çš„å°±å‡ ä¸ªï¼šæ–‡ä»¶åŒæ­¥ã€é‚®ä»¶å‘é€ä»¥åŠä¸‰æ–¹å­˜å‚¨é›†æˆã€‚å¦‚æœæ²¡æœ‰connectè®¢é˜…çš„è¯è¶…è¿‡äº”åå¤©æ²¡æœ‰æ‰“å¼€çš„æ–‡ä»¶å°±æ°¸è¿œä¸ä¼šåŒæ­¥ï¼Œè¿™æ˜¾ç„¶æ˜¯æœ‰äº›å½±å“ä½¿ç”¨äº†;è€Œé‚®ä»¶å‘é€å’Œä¸‰æ–¹å­˜å‚¨éƒ½èƒ½å¤Ÿæ¯”è¾ƒæ–¹ä¾¿åœ°å¯¼å…¥å¯¼å‡ºé˜…è¯»ææ–™å’Œæ¶‚é¸¦ã€‚ä¸è¿‡å¦‚æœå®Œå…¨æ²¡æœ‰connectçš„è¯ä¹Ÿèƒ½é€šè¿‡usbå’Œç”µè„‘è¿æ¥æ¥æœ‰çº¿ä¼ è¾“ï¼Œæ‰€ä»¥å¤‡ä»½èµ·æ¥ä¹Ÿè¿˜è¡Œã€‚</p><h1 id="reHackable"><a href="#reHackable" class="headerlink" title="reHackable"></a>reHackable</h1><p>reMarkableçš„ç³»ç»Ÿæ˜¯ä¸€ä¸ªå«åš<code>Codex</code>çš„linuxç³»ç»Ÿï¼Œé€šè¿‡usbè¿æ¥ä¸Šå°±ä¼šå¼€æ”¾ä¸€ä¸ªremote terminalç»™ä½ ï¼Œå¯èƒ½æ˜¯æ¯”è¾ƒå¼€æ”¾æ‰€ä»¥æœ‰è®¸å¤šä¸‰æ–¹åˆ›ä½œçš„å„ç§å·¥å…·æ¥å¢å¼ºä½¿ç”¨ä½“éªŒï¼Œ<a target="_blank" rel="noopener" href="https://github.com/reHackable/awesome-reMarkable">Awesome reMarkable</a>æ˜¯ä¸€ä¸ªawesomeåˆ—è¡¨ï¼Œå¯ä»¥æ‰¾åˆ°è®¸å¤šæœ‰è¶£çš„ä¸œè¥¿ã€‚æ¯”å¦‚æ‹¿æ¥æ‹‰å°æ¸…å•çš„<a target="_blank" rel="noopener" href="https://recalendar.me/">recalender</a>ï¼Œä»¥åŠçœ‹èµ·æ¥å¯ä»¥å®Œå…¨è‡ªå»ºconnectæœåŠ¡çš„<a target="_blank" rel="noopener" href="https://github.com/ddvk/rmfakecloud">rmfakecloud</a>ï¼Œç”šè‡³è¿˜æœ‰ä¸€ä¸ªåŒ…ç®¡ç†å™¨<a target="_blank" rel="noopener" href="https://toltec-dev.org/">Toltec</a>ã€‚æ´»è·ƒçš„hackå¸¦æ¥äº†è·Ÿå®˜æ–¹å…‹æ‰£featureå®Œå…¨ä¸ä¸€æ ·çš„ä½“éªŒï¼Œè™½ç„¶æ²¡æœ‰å®é™…ç”¨ä¸Šå‡ ä¸ªä½†æ˜¯çœ‹ç€å¾ˆèˆ’æœâ€¦â€¦</p><h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>æœ€åè¿˜æ˜¯æƒ³å¼ºè°ƒä¸€ä¸‹çœ‹PDFçš„éœ€æ±‚ä½“éªŒæœ€å¥½ä¹Ÿæœ€ä¾¿å®œçš„æ–¹æ¡ˆè¿˜æ˜¯æ‰“å°å‡ºæ¥ã€‚<del>å”¯ä¸€åªæœ‰ç”µå­é˜…è¯»å™¨èƒ½å¤Ÿå¸¦æ¥çš„æ˜¯å’Œé˜…è¯»æ— å…³çš„èŠ±é’±çš„å¿«æ„Ÿ</del></p><p>æœ€è¿‘ä¹Ÿåœ¨å•†åœºé—²é€›çš„æ—¶å€™ä½“éªŒäº†ä¸€äº›å…¶ä»–å“ç‰Œçš„å¢¨æ°´å±ï¼Œæ„Ÿè§‰reMarkableçš„ä»·æ ¼è¿˜æ˜¯å¤ªæ²¡ä¼˜åŠ¿äº†ã€‚ç”¨å·®ä¸å¤šä¸€åŠçš„é’±å°±èƒ½ä¹°åˆ°å·®ä¸å¤šçš„ä¹¦å†™ä½“éªŒä»¥åŠä¹Ÿè®¸ä¼šæ˜¯åŠ åˆ†é¡¹çš„ç½‘ç»œå’ŒåŒæ­¥ä½“éªŒï¼Œå¦‚æœå†è®©æˆ‘é€‰ä¸€æ¬¡å¯èƒ½è¿˜æ˜¯ä¼šé‡æ–°çº ç»“ä¸€ä¸‹çš„ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;em&gt;é¢˜å›¾æ¥è‡ª&lt;a href=&quot;remarkable.com&quot;&gt;remarkable.com&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;h1 id=&quot;åˆä¸€æ¬¡å¹¿å‘ŠæŠ•æ”¾&quot;&gt;&lt;a href=&quot;#åˆä¸€æ¬¡å¹¿å‘ŠæŠ•æ”¾&quot; class=&quot;headerlink&quot; title=&quot;åˆä¸€æ¬¡å¹¿å‘ŠæŠ•æ”¾&quot;&gt;&lt;/a&gt;åˆ</summary>
      
    
    
    
    
    <category term="Experience" scheme="https://waynexia.github.io/tags/Experience/"/>
    
    <category term="Device" scheme="https://waynexia.github.io/tags/Device/"/>
    
  </entry>
  
  <entry>
    <title>æ·±æµ·è¿·èˆªï¼šå†°ç‚¹ä¹‹ä¸‹</title>
    <link href="https://waynexia.github.io/2022/03/subnautica-below-zero/"/>
    <id>https://waynexia.github.io/2022/03/subnautica-below-zero/</id>
    <published>2022-03-11T17:31:45.000Z</published>
    <updated>2023-11-23T08:35:22.632Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æ˜¯ç³»åˆ—ç¬¬äºŒä½œã€‚ä½†æ˜¯ä»ä¸€äº›ä¹‹å‰çš„èµ„æ–™æ¥çœ‹ä¸€å¼€å§‹å†°ç‚¹ä¹‹ä¸‹æ˜¯ä½œä¸ºç¬¬ä¸€éƒ¨çš„ DLC çš„èº«ä»½é¢ä¸–çš„ï¼Œä¸è¿‡æˆ‘åœ¨ xbox å•†åº—çœ‹åˆ°çš„æ—¶å€™å®ƒå·²ç»å’Œã€Šæ·±æµ·è¿·èˆªã€‹åˆ†å¼€æˆä¸¤ä¸ªæ¡ç›®äº†ï¼Œä¹Ÿè®¸æ˜¯åšç€åšç€å°±æ‹¿å‡ºæ¥å•ç‹¬å”®å–äº†å§ã€‚ä¸è¿‡å¯èƒ½æ˜¯è¿™ä¸ªåŸå› ï¼Œå†°ç‚¹ä¹‹ä¸‹å¤§éƒ¨åˆ†çš„å…ƒç´ åŸºæœ¬å’Œä¹‹å‰ä¸€æ¨¡ä¸€æ ·ï¼Œç”»é¢å’Œæ“ä½œéƒ½æ˜¯ç†Ÿæ‚‰çš„å‘³é“<del>ï¼ˆæ²¡æœ‰è¯´å·æ‡’çš„æ„æ€ï¼‰</del>ã€‚</p><p>è¿™ä¸ªç³»åˆ—ç®€å•æ¥åº”è¯¥ç®—ä»¥æ¢ç´¢æµ·æ´‹ä¸ºä¸»é¢˜çš„ç”Ÿå­˜æ¸¸æˆã€‚ä¸¤æ¬¡éƒ½æ˜¯åœ¨ä¸€ç‰‡è¢«æµ·æ´‹è¦†ç›–çš„æ˜Ÿçƒä¸Šï¼ˆèƒŒæ™¯é‡Œé¢å¥½åƒæ˜¯åŒä¸€é¢—æ˜Ÿçƒï¼‰ï¼Œä»å è½æ—¶çš„ä¸€ä¸ªå°é€ƒç”Ÿèˆ±å¼€å§‹ï¼Œåœ¨æ¢ç´¢å‘¨å›´ç¯å¢ƒçš„è¿‡ç¨‹ä¸­è·å–ç”Ÿå­˜ç‰©èµ„ä¸è§£é”ç§‘æŠ€ï¼Œå¹¶é€šè¿‡ä¸æ–­åœ°æ‰©å¤§æ¢ç´¢èŒƒå›´æ¥æ¨è¿›å‰§æƒ…ã€‚è§‰å¾—è¿™ä¸ªç³»åˆ—æœ€æœ‰ç‰¹ç‚¹çš„åœ°æ–¹å°±æ˜¯å†æµ·æ´‹ä¸ºä¸»åœºæ™¯çš„è®¾å®šä¸‹å¸¦æ¥çš„ç«‹ä½“æ¢ç´¢çš„ä½“éªŒã€‚</p><p>è¿™ä¸€æ¬¡æ•…äº‹å‘ç”Ÿåœ¨å¦ä¸€å¼ åœ°å›¾ï¼Œä¸è¿‡å‰ä½œå…¶å®æ²¡æœ‰æ¨å®Œçš„æˆ‘å¹¶ä¸è®°å¾—å…·ä½“çš„åœ°å›¾æ˜¯ä»€ä¹ˆæ ·å­ï¼ŒçœŸæ­£è®©æˆ‘æ„Ÿåˆ°åœ°å›¾æ¢äº†çš„æ˜¯åœºæ™¯å…ƒç´ ã€‚å‰ä½œä»é€ƒç”Ÿèˆ±å‡ºæ¥ä¹‹ååœ¨å‘¨å›´è½¬æ‚ äº†å¾ˆä¹…æ‰è¿›è¡Œç¬¬ä¸€æ¬¡è¿œè¡Œï¼Œè¿˜è¢«è¾å°„è­¦å‘Šç»™å“äº†å›æ¥ã€‚ç„¶è€Œè¿™ä½œä¸ä»…æ²¡æœ‰è¾å°„è­¦å‘Šï¼Œç”šè‡³è¿˜èƒ½å¤Ÿå¾’æ‰‹å¼€é“€çŸ¿ã€‚ä¸è¿‡è¿™æ˜¯åé¢çš„å†…å®¹ï¼Œå†°ç‚¹ä¹‹ä¸‹ç¬¬ä¸€å¹•æ˜¯ä»å†°å·å¼€å§‹çš„ï¼Œåœ¨æˆ‘çš„å°è±¡ä¸­è¿™æ˜¯å‰ä½œæ²¡æœ‰çš„è¦ç´ ã€‚</p>    <figure class="figure-image">      <img src="map.png" alt="æœ¬ä½œåœ°å›¾ï¼Œç™½è‰²æ˜¯æ–°å¢çš„é™†ä¸Šå†°å·éƒ¨åˆ†ï¼Œä¸è¿‡ä¸€å¤§åŠéƒ½æ˜¯å»ä¸äº†çš„" width="30%" height="100% loading="lazy" />      <figcaption>æœ¬ä½œåœ°å›¾ï¼Œç™½è‰²æ˜¯æ–°å¢çš„é™†ä¸Šå†°å·éƒ¨åˆ†ï¼Œä¸è¿‡ä¸€å¤§åŠéƒ½æ˜¯å»ä¸äº†çš„</figcaption>    </figure>  <p>ç¬¬ä¸€ä½œè¿›åº¦åº”è¯¥ä¸åˆ°ä¸‰åˆ†ä¹‹ä¸€ï¼Œç”šè‡³éƒ½æ²¡è§åˆ°åˆ©ç»´å¦ã€‚å½“æ—¶æ˜¯åœ¨å®¿èˆé‡Œé¢ï¼Œæ·±å¤œä¸¤ç‚¹ä¸­æˆ‘è¿˜åœ¨æ”¶é›†ç‰©èµ„ã€‚å±å¹•é‡Œå¤–éƒ½æ˜¯ä¸€ä¸ªäººï¼Œå†…å¿ƒä¸€ç›´æœ‰è¦ç»•ä¸æ•£ææƒ§æ„Ÿã€‚æˆ‘è®°å¾—é‚£æ—¶çš„æ—¥è®°å¥½åƒå†™äº†â€œè¿™ä¸ªæ¸¸æˆç©å‡ºäº†æ·±æµ·ææƒ§ç—‡â€ä¹‹ç±»çš„è¯ï¼Œå†ç©äº†å‡ ä¸ªå°æ—¶å°±é¡¶ä¸ä½å¼ƒäº†ã€‚è¿™ä¸ªç°è±¡åœ¨è¿™ä¸€æ¬¡è¿˜æ˜¯æ²¡æœ‰å¥½è½¬ï¼Œå½“è‡ªå·±åˆä¸€æ¬¡è¢«ä¸¢åˆ°æµ·é‡Œï¼Œå‘¨å›´åªæœ‰ä¸‰å››ç«‹æ–¹ç±³çš„å®‰å…¨ç©ºé—´æ—¶ï¼Œè¿™ç§ç†Ÿæ‚‰çš„æ„Ÿè§‰åˆå›æ¥äº†ã€‚ç”±äºåœ°å›¾åœºæ™¯éå¸¸å¤æ‚ï¼Œåœ¨å…¨èº«è´¯æ³¨åœ°è´´ç€æµ·åº•ç§»åŠ¨å¯»æ‰¾ç‰©èµ„çš„æ—¶å€™ç•™æ„æ°§æ°”è¡¨å°±å·²ç»å¾ˆç´§å¼ äº†ï¼Œç»å¸¸æ— æš‡ç•™æ„å‘¨å›´æ½œè—ç€çš„å…¶ä»–ç”Ÿç‰©ã€‚åœ¨å‰æœŸè¿˜æ²¡æœ‰è½½å…·è£…å¤‡èƒ½ç¨å¾®å¢åŠ ä¸€äº›å®‰å…¨æ„Ÿçš„æ—¶å€™å¥½å‡ æ¬¡è¢«çªå¦‚å…¶æ¥çš„è¢­å‡»å“åˆ°ã€‚è€Œå°±ç®—æœ‰äº†è½½å…·ä¹‹åé¢å¯¹æœªçŸ¥ç”Ÿç‰©æ—¶ä»ç„¶éš¾ä»¥å…‹æœææƒ§ï¼Œæ€»æ˜¯å°å¿ƒç¿¼ç¿¼åœ°é¿å…å’Œå®ƒä»¬æ¥è§¦ï¼Œæƒ³å»çš„åœ°æ–¹æœ‰å¥‡æ€ªç”Ÿç‰©åœ¨å¾˜å¾Šæ—¶ç»å¸¸ç­‰åˆ°è‚šå­é¥¿ã€‚è¿™æ—¶å€™æƒ³æƒ³ç¥–å…ˆèµ°å‡ºäº†ä¸›æ—çœŸæ˜¯å¤ªå¥½äº†ï¼Œèƒ½ç»å¸¸æŠŠåŸºæœ¬çš„ç”Ÿå­˜å½“ä½œä¸€ä»¶ç†æ‰€å½“ç„¶çš„äº‹æƒ…çœŸå®å¤ªå¥½äº†ã€‚</p><p>è€Œä¼´ç€è¿™ç§æ„Ÿè§‰åœ¨æµ·æ´‹ä¸­æ¸¸å¼‹çš„è¿‡ç¨‹ä¹Ÿè®¸æ˜¯æ¸¸æˆé‡Œæœ€è®©æˆ‘å–œæ¬¢çš„åœ°æ–¹ã€‚å’Œåœ¨æ¸¸æ³³é¦†æ¸¸æ³³ä¸åŒï¼Œæ¸¸æˆç”»é¢å¹¶æ²¡æœ‰æ¸²æŸ“å¯†é“ºçš„å°ç“·ç –æˆ–è€…è¢«æ³¢çº¹æ‰“æ•£åˆ°åœ°ä¸Šçš„å…‰çº¿ï¼Œè€Œæ˜¯é€šè¿‡ç«‹ä½“çš„ç”Ÿæ€ç¯å¢ƒæ¥ç»™äººåœ¨æ°´ä¸­çš„æ„Ÿè§‰ã€‚è€Œä¸”æ˜¯ä¸€ç‰‡éå¸¸å¹¿é˜”ï¼Œåœ°é¢å´å²–ï¼Œæ²¡æœ‰åŒç±»ä½†æœ‰è®¸å¤šå…¶ä»–ç‰©ç§çš„æ°´ã€‚</p>    <figure class="figure-image">      <img src="environment.png" alt="å‰æœŸçš„è¿·è·¯ç‚¹" width="100%" height="100% loading="lazy" />      <figcaption>å‰æœŸçš„è¿·è·¯ç‚¹</figcaption>    </figure>  <p>ç„¶è€Œåœ¨å†™æœ¬ç¯‡çš„æ—¶å€™è§‰å¾—è¿™æ¬¡åˆè¦å¼ƒæ‰äº†ã€‚æ‰¾å®å†µå½•åƒå‚è€ƒäº†ä¸‹ï¼Œè¿™æ¬¡å‰§æƒ…åº”è¯¥æ˜¯åŸºæœ¬å¿«æ¨å®Œäº†ï¼Œä¸è¿‡è¿ç€æ¨äº†å‡ ä¸ªæ™šä¸Šè§‰å¾—è„‘è¢‹å·²ç»ä¸è¡Œäº†ã€‚åˆ°äº†åæœŸåŸºæœ¬ä¸Šæ‰€æœ‰åœ°æ–¹éƒ½èƒ½å¤Ÿå»ï¼Œæ‰¾ä¸œè¥¿ç¯èŠ‚å°±å˜å¾—éå¸¸éº»çƒ¦ã€‚æµ·æ´‹çš„éƒ¨åˆ†éšç€æ·±åº¦ä¸‹æ½œåœ°å½¢å˜å¾—è¶Šæ¥è¶Šç»•ï¼Œå°±ç®—ç»™äº†ä¿¡æ ‡ä¹Ÿè¦å»æ‰¾æ”»ç•¥æ‰çŸ¥é“æ€ä¹ˆèµ°ï¼Œè€Œé™†åœ°éƒ¨åˆ†ä¸€è¨€ä¸åˆå°±æ¥æç«¯å¤©æ°”æŠŠèƒ½è§åº¦é™åˆ°ä¼¸æ‰‹ä¸è§äº”æŒ‡ï¼Œè¿˜æœ‰é‡æ–°å›æ¥çš„å¼ºå¤§å¼•åŠ›ä¹Ÿç›´æ¥æŠŠæœºåŠ¨èƒ½åŠ›æ‘˜æ‰äº†ä¸€ä¸ªçºµè½´ã€‚è¿·è·¯è‡´æ­»çš„æ¬¡æ•°è¶Šæ¥è¶Šå¤šï¼Œä»¥è‡³äºç°åœ¨ä¸€å›æƒ³èµ·æ¥æ‰¾è·¯æ—¶åœ¨å¤©æ—‹åœ°è½¬çš„å±å¹•éƒ½ä¼šå¤´æ™•ã€‚å½“ç„¶è¿™ä¸ªè·¯ç—´å¯èƒ½æ˜¯æˆ‘çš„é—®é¢˜ï¼Œå°±ç®—æˆ‘åœ¨è¿™é‡ŒæŸ¥æ”»ç•¥çœ‹è·¯çº¿çš„æ¬¡æ•°å·²ç»æ¯” XB2 è¿˜å¤šäº†ï¼ˆ</p><p>è¿™ä¸€æ¬¡å¤§å‹æ€ªç‰©çš„æ‰ san ç¨‹åº¦å·²ç»æ¯”å‰ä½œå¥½äº†å¾ˆå¤šï¼Œä¸è¿‡è¿˜æ˜¯ä¸å¤ªèƒ½é€‚åº”ã€‚å¯¹æˆ‘æ¥è¯´æµ·æ´‹ä¸»é¢˜çš„å†’é™©å¤§æ¦‚è¦ ABZU é‚£ç§ç¨‹åº¦çš„æ‰ä¼šè§‰å¾—èˆ’æœå§ã€‚</p>    <figure class="figure-image">      <img src="fish.png" alt="å·²ç»å’Œè”¼å¤šäº†çš„ç”Ÿç‰©" width="50%" height="100% loading="lazy" />      <figcaption>å·²ç»å’Œè”¼å¤šäº†çš„ç”Ÿç‰©</figcaption>    </figure>  <p>å¯¹äºæ–°åŠ çš„å†°åŸåœºæ™¯å¹¶ä¸æ˜¯å¾ˆå–œæ¬¢ï¼Œä¸¢æ‰äº†ç«‹ä½“æ¢ç´¢çš„ç‰¹è‰²ï¼Œå’Œå…¶ä»–çš„ä½œå“æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ï¼Œè€Œä¸”å°±ç®—æ˜¯åœ¨åŒä¸€ä¸ªä½œå“é‡Œé¢ä¹Ÿè§‰å¾—å†°åŸçš„ç”Ÿç‰©ä¸å¦‚æµ·æ´‹æœ‰æ„æ€ï¼ˆå¯èƒ½å„ç§å¥‡å¥‡æ€ªæ€ªçš„é™†åœ°ç”Ÿç‰©å¹³æ—¶çœ‹å¾—ä¹Ÿä¸å°‘äº†ï¼‰ã€‚è¿˜æœ‰é™†åœ°ä¸Šçš„è½½å…·çœŸæ˜¯å¤ªå‚¬åäº†ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æ‰“å¼€æ–¹å¼æœ‰é—®é¢˜ï¼Œæ€»ä¹‹é€ å‡ºæ¥ä¹‹åå°±æ²¡ç¢°è¿‡å‡ å›ï¼Œå®æ„¿èµ°è·¯éƒ½ä¸æƒ³å¼€ã€‚é™¤æ­¤ä¹‹å¤–è¿˜æœ‰äº›å…¶ä»–å½±å“ä½“éªŒçš„ç»†èŠ‚ï¼Œæ„Ÿè§‰å’Œå…¶ä»–å‡ ä¸ªæ¥è§¦äº†ä¸€æ®µæ—¶é—´çš„ä»¥ steam alpha æ¨¡å¼å¼€å‘çš„ä½œå“ç±»ä¼¼ï¼Œå‚å®¶<del>å°ä½œåŠ</del>åšäº†æ–°å¥‡çš„æ ¸å¿ƒç©æ³•ï¼Œä½†æ˜¯ä¸çŸ¥é“å¦‚ä½•æ›´è¿›ä¸€æ­¥åœ°å®Œå–„å¹¶ç»§ç»­æŒ–æ˜ä¸°å¯Œçš„å†…å®¹ã€‚æœ€åç»™æˆ‘çš„æ„Ÿè§‰å°±æ˜¯å¼€å§‹å¾ˆæ–°å¥‡å¾ˆä¸Šå¤´ï¼Œä½†æ˜¯ç©ç€å®Œç€å°±æ€»æ˜¯æ„Ÿè§‰å·®äº†äº›ä¸œè¥¿ã€‚</p><p>æœ€åæ€»ç»“çš„è¯å°±æ˜¯<del>æŠ›æ‰ä¸å¥½çš„ä½“éªŒæ¥è¯´ä½“éªŒè¿˜æ˜¯å¯ä»¥çš„</del>ç•™ä¸€ä¸ªåœ¨æµ·ä¸­å†’é™©çš„æ¨¡ç³Šå°è±¡æ˜¯ä¸é”™çš„ï¼Œä½†æ˜¯ä¸å¤ªå¥½çš„æ¸¸ç©ä½“éªŒè®©æˆ‘ä¸å¤ªæƒ³ç»§ç»­æ“ä½œä¸‹å»å®Œæˆåé¢çš„å‰§æƒ…ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;è¿™æ˜¯ç³»åˆ—ç¬¬äºŒä½œã€‚ä½†æ˜¯ä»ä¸€äº›ä¹‹å‰çš„èµ„æ–™æ¥çœ‹ä¸€å¼€å§‹å†°ç‚¹ä¹‹ä¸‹æ˜¯ä½œä¸ºç¬¬ä¸€éƒ¨çš„ DLC çš„èº«ä»½é¢ä¸–çš„ï¼Œä¸è¿‡æˆ‘åœ¨ xbox å•†åº—çœ‹åˆ°çš„æ—¶å€™å®ƒå·²ç»å’Œã€Šæ·±æµ·è¿·èˆªã€‹åˆ†å¼€æˆä¸¤ä¸ªæ¡ç›®äº†ï¼Œä¹Ÿè®¸æ˜¯åšç€åšç€å°±æ‹¿å‡ºæ¥å•ç‹¬å”®å–äº†å§ã€‚ä¸è¿‡å¯èƒ½æ˜¯è¿™ä¸ªåŸå› ï¼Œå†°ç‚¹ä¹‹ä¸‹å¤§éƒ¨åˆ†çš„å…ƒç´ åŸºæœ¬å’Œä¹‹å‰ä¸€æ¨¡ä¸€æ ·ï¼Œç”»é¢å’Œæ“ä½œéƒ½æ˜¯</summary>
      
    
    
    
    
    <category term="Experience" scheme="https://waynexia.github.io/tags/Experience/"/>
    
    <category term="Game" scheme="https://waynexia.github.io/tags/Game/"/>
    
  </entry>
  
  <entry>
    <title>æ‚æŠ€ï¼šè¢« CGO ç©è½¬</title>
    <link href="https://waynexia.github.io/2021/12/embed-rust-lib-into-go/"/>
    <id>https://waynexia.github.io/2021/12/embed-rust-lib-into-go/</id>
    <published>2021-12-28T19:58:27.000Z</published>
    <updated>2023-11-23T08:35:22.624Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h1><p>æ•…äº‹å‘ç”Ÿåœ¨èš‚èšä¸€ä¸ªå†…éƒ¨é¡¹ç›®ä¸Šï¼Œè¿™ä¸ªé¡¹ç›®æœ‰ Go å’Œ Rust ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­ Rust åº“ä½œä¸ºä¸€ä¸ªå­˜å‚¨ç»„ä»¶è¢« Go çš„ä¸šåŠ¡éƒ¨åˆ†ä¾èµ–ç€ã€‚å‡ºäºç§ç§åŸå› ï¼Œä¸¤ä¸ªéƒ¨åˆ†éœ€è¦ä½œä¸ºåŒä¸€ä¸ªè¿›ç¨‹æ¥è¿è¡Œï¼Œä¸­é—´æœ‰ä¸€å±‚ C FFI æ¥å£ä½œä¸ºç†æƒ³ä¸ç°å®çš„æ¡¥æ¢ã€‚å¤§æ¦‚æ˜¯è¿™ä¸ªæ ·å­çš„</p><p><img src="/covers/embed-rust-lib-into-go.png" alt="img"></p><p>Rust éƒ¨åˆ†é¦–å…ˆå°†ä½¿ç”¨åˆ°çš„ Library çš„æ¥å£å’Œç»“æ„ä½¿ç”¨å¦ä¸€ä¸ªå°å°çš„ <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/reference/linkage.html">cdylib</a> shim é¡¹ç›®å°è£…ä¸€ä¸‹ï¼Œå¹¶é€šè¿‡è¿™ä¸ªé¡¹ç›®ç”Ÿæˆ Rust åº“çš„ç¼–è¯‘äº§ç‰©ã€ä¸€ä¸ªåŠ¨æ€é“¾æ¥å¯¹è±¡å’Œä¸€ä»½ C çš„æ¥å£å¤´æ–‡ä»¶ã€‚å†åŸºäº C header å†™ä¸€ä¸ª Go çš„ SDK ç»™ä¸Šå±‚ä½¿ç”¨ã€‚å•ç‹¬å·¦è¾¹çš„ Go æˆ–è€…å³è¾¹çš„ Rust é¡¹ç›®éƒ½ä¸å¤Ÿåˆºæ¿€ï¼Œè¿åœ¨ä¸€èµ·å°±å¾ˆå¾—åŠ²äº†ã€‚è¿™é‡Œä¸»è¦é›†ä¸­åœ¨ä¸­é—´é‚£ä¸€å›¢éº»èŠ±éƒ¨åˆ†ä¸Šï¼Œä¹Ÿæ˜¯ too young too simple æ‰äº†å¾ˆå¤šå¤´å‘çš„åœ°æ–¹ã€‚</p><p>å¤§æ¦‚ä¼šä»çº¿ç¨‹ã€å†…å­˜å’Œä¿¡å·ä¸‰ä¸ªæ–¹é¢è®²å‡ ä¸ªäº‹æ•…ã€‚</p><h1 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h1><p>åˆšå¼€å§‹çš„æ—¶å€™ shim å’Œ SDK éƒ½éå¸¸ç®€å•ï¼ŒSDK æ¯ä¸ªè¯·æ±‚éƒ½é€šè¿‡ CGO èµ°åˆ° shimï¼Œshim åœ¨è¿›è¡Œä¸€äº›ç»“æ„çš„è½¬æ¢åè°ƒç”¨ library æ¥å¤„ç†è¯·æ±‚ï¼Œç­‰å¾…è¯·æ±‚å®Œæˆä¹‹åæŠŠç»“æœè¿”å›ç»™ SDKã€‚æ¯”è¾ƒç¬¦åˆç›´è§‰çš„æµç¨‹ï¼Œä½†æ˜¯åœ¨æµ‹è¯•çš„æ—¶å€™å‡ºç°äº†é—®é¢˜ï¼Œæ•´ä¸ªç¨‹åºçš„è¡Œä¸ºéƒ½ä¸å¤ªæ­£å¸¸ã€‚å½“æ—¶åˆšå¼€å§‹è¿è°ƒï¼Œåœ¨è¿™ä¹‹å‰ component å’Œ library/shim éƒ½åªå•ç‹¬è¿›è¡Œäº†æµ‹è¯•ï¼Œå½“ç„¶å•ç‹¬æµ‹è¯•çš„æ—¶å€™å¤§å®¶éƒ½æ˜¯ä¸€åˆ‡æ­£å¸¸ï¼Œæ‰€ä»¥è¿è°ƒèµ·æ¥åœºæ™¯å°±å˜æˆäº†â€¦</p><p><img src="1.png" alt="img"></p><div class="heti heti--annotation">è™½ç„¶å¾ˆå¿«å°±æ€€ç–‘åˆ°äº† SDK å’Œ shim éƒ¨åˆ†ï¼Œä½†æ˜¯ä¹Ÿä¸æ¸…æ¥šé—®é¢˜åˆ°åº•å‡ºåœ¨å“ªé‡Œã€‚ç›´åˆ°ç¿»æ—¥å¿—çš„æ—¶å€™å‘ç°äº†ä¸€æ¡åŸæœ¬åªåº”è¯¥åœ¨å¯åŠ¨çš„æ—¶å€™è¾“å‡ºä¸€æ¬¡çš„æ—¥å¿—å‡ºç°äº†å¤æ•°æ¬¡ï¼Œæ‰æ„è¯†åˆ°ä¸å¯¹åŠ²ã€‚ï¼ˆåˆï¼‰å‡ºäºä¸€äº›åŸå› ï¼Œshim å’Œ library ä¸­éƒ½å­˜åœ¨æœ‰ <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Thread-local_storage">TLS</a>(<ruby> thread local storage<rt>çº¿ç¨‹å±€éƒ¨å­˜å‚¨</rt></ruby>)ç»“æ„ï¼Œæ¯”å¦‚åœ¨ Rust std ä¸­çš„ä¸€ç§<a target="_blank" rel="noopener" href="https://doc.rust-lang.org/std/macro.thread_local.html">å®ç°</a>ã€‚å®ƒä¼šåœ¨æ¯ä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡ä½¿ç”¨è¿™ä¸ªç»“æ„çš„æ—¶å€™è¿›è¡Œåˆå§‹åŒ–ï¼Œä¹‹ååŒä¸€ä¸ªçº¿ç¨‹éƒ½ä¼šä¸€ç›´è®¿é—®åˆ°è¿™ä¸ªå¯¹è±¡ï¼Œè€Œä¸åŒçš„çº¿ç¨‹ä¹‹é—´è®¿é—®åˆ°çš„æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚è€Œé‚£æ¡é‡å¤å‡ºç°çš„æ—¥å¿—å°±æ˜¯ä¸€ä¸ª TLS ç»“æ„åœ¨åˆå§‹åŒ–æ—¶è¾“å‡ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ TLS ä¸ç¬¦åˆé¢„æœŸåœ°è¢«é‡å¤åˆå§‹åŒ–äº†ã€‚</div><p>å…ˆçœ‹ä¸‹ Go åœ¨è¿›è¡Œ CGO è°ƒç”¨çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆã€‚Go runtime æä¾›çš„çº¿ç¨‹ä¸ç³»ç»Ÿçº¿ç¨‹ä¸æ˜¯ä¸€ä¸€å¯¹åº”ï¼Œåœ¨è¿›è¡Œé Go çš„è°ƒç”¨æ—¶ï¼Œä¼šæŠŠå½“å‰ goroutine æ”¾åœ¨ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ä¸Šï¼Œä½¿ç”¨è¿™ä¸ªç³»ç»Ÿçº¿ç¨‹å®Œæˆåç»­çš„è°ƒç”¨æµç¨‹ã€‚æ‰€ä»¥å¦‚æœä¸åšç‰¹æ®Šå¤„ç†çš„è¯å¯¹äº shim æ¥è¯´æ¯æ¬¡è¯·æ±‚éƒ½æœ‰å¯èƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªæ–°çš„çº¿ç¨‹ä¸Šï¼Œè€Œä½¿å¾—ä¹‹å‰ä¿å­˜åœ¨ TLS ä¸­çš„çŠ¶æ€å¤±æ•ˆã€‚å¹¶ä¸”æ›´åŠ ä¸¥é‡çš„æ˜¯ï¼Œshim çš„ TLS ä¸­åŒ…æ‹¬äº†ä¸€äº› library çš„çº¿ç¨‹å¥æŸ„ï¼Œå¯¼è‡´ library çš„éƒ¨åˆ†çŠ¶æ€ä¹Ÿå‡ºç°äº†æ··ä¹±ï¼Œæœ€ç»ˆæ•´ä¸ªè¿›ç¨‹çš„è¡Œä¸ºéƒ½å˜å¾—å¾ˆå¥‡æ€ªã€‚</p><div class="heti heti--annotation">ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ shim å’Œ library çš„çº¿ç¨‹å›ºå®šä½ï¼Œshim æ¥åˆ°è¯·æ±‚åé€šè¿‡<ruby>çº¿ç¨‹ä¿¡æ¯ä¼ é€’<rt>channel</rt></ruby>çš„æ–¹å¼ä¸ library äº¤äº’ï¼ŒåŒ…æ‹¬å‘é€è¯·æ±‚ä¸æ¥æ”¶ç»“æœï¼š</div><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Handle</span></span> &#123;<br>    runtime: Runtime <span class="hljs-comment">// this was TLS</span><br>&#125;<br><br><span class="hljs-keyword">impl</span> Handle &#123;<br>    <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">new</span></span>() -&gt; <span class="hljs-keyword">Self</span>&#123;<br>        <span class="hljs-keyword">let</span> worker_thread = std::thread::spawn(|| &#123;&#125;); <span class="hljs-comment">// main thread, channels inside</span><br>        <span class="hljs-keyword">let</span> runtime = Runtime::new(); <span class="hljs-comment">// callback threads</span><br>        <span class="hljs-keyword">Self</span> &#123; runtime &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒæ—¶æ¥éƒ½æ¥äº†ï¼Œä¹Ÿé¡ºä¾¿å°† library å¼‚æ­¥çš„æ¥å£æš´éœ²åˆ°äº†ä¸Šå±‚ï¼Œç”±åŸæ¥ä¸€æ¬¡ CGO å®Œæˆæ•´ä¸ªè¯·æ±‚çš„æ–¹å¼å˜æˆäº†ä¸€æ¬¡ CGO æäº¤è¯·æ±‚ï¼Œç»“æœé€šè¿‡åç»­å¦ä¸€æ¬¡ C åˆ° Go çš„è°ƒç”¨å¼‚æ­¥åœ°è¿”å›ï¼Œä¹Ÿèƒ½å¤Ÿé˜²æ­¢å¤§è¯·æ±‚æŠŠ Go runtime spawn å‡ºæ¥çš„ CGO çº¿ç¨‹é˜»å¡å¤ªé•¿æ—¶é—´ã€‚ç°åœ¨æ•´ä¸ªçš„äº¤äº’æµç¨‹çœ‹èµ·æ¥å¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="2.png" alt="img"></p><p>ä¸è¿‡è¿™åªæ˜¯å¾ˆåŸºç¡€çš„æ–¹æ¡ˆï¼Œâ€œå˜ç”µå™¨â€ CGO çš„åŸç†å¾ˆç®€å•ï¼Œä½†ä¹Ÿå­˜åœ¨è®¸å¤šä¼˜åŒ–ç©ºé—´ï¼Œèƒ½å¤Ÿåœ¨è§£å†³é—®é¢˜çš„åŒæ—¶é™ä½æŸè€—ç‡ã€‚è¿™é‡Œæ˜¯æ‰¾åˆ°çš„ä¸€äº›æ“ä½œï¼ˆ<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/PdeLX4loFaXr4E74hsrHCw">1</a>,<a target="_blank" rel="noopener" href="https://about.sourcegraph.com/go/gophercon-2018-adventures-in-CGO-performance/">2</a>,<a target="_blank" rel="noopener" href="https://www.cockroachlabs.com/blog/the-cost-and-complexity-of-CGO/">3</a>ï¼‰ï¼Œå½“ç„¶å¤§éƒ¨åˆ†éƒ½è¿˜æ²¡åšï¼ˆ</p><h1 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h1><p>é™¤æ­¤ä¹‹å¤–ï¼Œä¸ºäº†é€šè¿‡ C çš„æ¥å£æ¥ä¼ é€’æ•°æ®ï¼Œéœ€è¦å¯¹æ•°æ®ç»“æ„è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼Œè¿™ä¸€éƒ¨åˆ†ä¸»è¦åœ¨ shim å’Œ SDK è¿›è¡Œã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠæ‰€æœ‰éœ€è¦ä¼ é€’çš„ç±»å‹éƒ½èƒ½å¤Ÿç”¨ C è¡¨ç¤ºå‡ºæ¥ï¼Œåœ¨<a target="_blank" rel="noopener" href="http://jakegoulding.com/rust-ffi-omnibus/">è¿™é‡Œ</a> æœ‰ä¸€äº›ä¾‹å­ï¼Œæˆ–è€…æ˜¯åƒè¿™æ ·ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-meta">#[repr(C)]</span><br><span class="hljs-keyword">pub</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Bytes</span></span> &#123;<br>    ptr: *<span class="hljs-keyword">mut</span> libc::c_void,<br>    len: libc::size_t,<br>&#125;<br><br><span class="hljs-keyword">crate</span> <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">make_bytes</span></span>(<span class="hljs-keyword">mut</span> bytes: <span class="hljs-built_in">Vec</span>&lt;<span class="hljs-built_in">u8</span>&gt;) -&gt; <span class="hljs-keyword">Self</span> &#123;<br>    bytes.shrink_to_fit();<br>    <span class="hljs-keyword">let</span> (ptr, len, cap) = bytes.into_raw_parts();<br>    <span class="hljs-built_in">debug_assert_eq!</span>(len, cap);<br>    Bytes &#123;<br>        ptr: <span class="hljs-keyword">unsafe</span> &#123; mem::transmute::&lt;*<span class="hljs-keyword">mut</span> <span class="hljs-built_in">u8</span>, *<span class="hljs-keyword">mut</span> libc::c_void&gt;(ptr) &#125;,<br>        len,<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>Go ä¸ Rust åœ¨è¿œç¦» FFI è¾¹ç•Œçš„åœ°æ–¹ï¼ˆä¸€èˆ¬æ¥è¯´ï¼‰éƒ½èƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†å†…å­˜é—®é¢˜ï¼Œè¿™äº›éæ³•çš„æŒ‡é’ˆå’Œåœ°å€åŸºæœ¬ä¸Šéƒ½æ˜¯æ²¡èƒ½å¥½å¥½å¤„ç†å¦ä¸€æ–¹ä¸¢è¿‡æ¥çš„ä¸œè¥¿é€ æˆçš„ã€‚åœ¨å½“æ—¶ä¸ºäº†å‡å°‘å·¥ä½œé‡å·²ç»é€šè¿‡å¤§é‡çš„æ‹·è´å‡å°‘äº†è®¸å¤šä½¿ç”¨è£¸æŒ‡é’ˆçš„åœ°æ–¹ï¼Œå‰©ä¸‹çš„ä¸»è¦é›†ä¸­åœ¨ä¸¤å¤„ï¼Œå³æ¥æ”¶å¯¹æ–¹ä¼ é€’è¿‡æ¥çš„æ•°æ®ä»¥åŠé€šçŸ¥å¯¹æ–¹å›æ”¶è¿™ä¸€å—æ•°æ®çš„å†…å­˜ã€‚è¿™ç§æ—¶å€™é™¤å¼€éµå®ˆè€ç”Ÿå¸¸è°ˆçš„â€œ<span class="heti-em"><strong>è°åˆ†é…è°é‡Šæ”¾</strong></span>â€åŸåˆ™å¤–ï¼Œå‰©ä¸‹çš„åŸºæœ¬ä¹Ÿåªèƒ½ç°åœº<del>æŠ“å¤´å‘åæ‚”</del>å®šä½äº†ã€‚</p><p>æœ€å…ˆçš„å…¥æ‰‹ç‚¹å°±æ˜¯å‘ç”Ÿé”™è¯¯æ—¶æ‰€æ‰“å‡ºæ¥çš„å †æ ˆï¼ŒæŒ‰ç…§ç»éªŒè·Ÿç€ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯åçš„ç¬¬ä¸€æ¡ Go routine backtrace é€šå¸¸æ˜¯å‘ç”Ÿé—®é¢˜çš„åœ°æ–¹ï¼ˆåº”è¯¥â€¦â€¦ï¼Ÿï¼‰ã€‚å¯ä»¥å…ˆé¡ºç€è°ƒç”¨æ ˆæ£€æŸ¥ä¸€ä¸‹ä»£ç ä¸­æ˜¯å¦æœ‰ä¸æ­£ç¡®çš„æŒ‡é’ˆä½¿ç”¨ã€‚ä¸è¿‡è¿™ä¸ªå †æ ˆä¸­åªä¼šå­˜åœ¨ Go è¿™ä¸€éƒ¨åˆ†çš„ä¿¡æ¯ã€‚å½“é—®é¢˜å‡ºç°åœ¨ Go ä¹‹å¤–çš„æ—¶å€™æ—¥å¿—ä¼šå˜å¾—éå¸¸è¿·æƒ‘ï¼ŒåŸºæœ¬åªèƒ½å¤ŸçŸ¥é“æ˜¯å“ªä¸€ä¸ª CGO å‡½æ•°å€¼å¾—æ€€ç–‘ã€‚è¿™ä¸€éƒ¨åˆ†å°±å’Œæ™®é€šçš„å†…å­˜é—®é¢˜æ’æŸ¥å·®ä¸å¤šï¼Œåˆ—ä¸¾å‡ ä¸ªå¸¸ç”¨çš„æ­¥éª¤ï¼š</p><h2 id="æ‰“å°æ—¥å¿—"><a href="#æ‰“å°æ—¥å¿—" class="headerlink" title="æ‰“å°æ—¥å¿—"></a>æ‰“å°æ—¥å¿—</h2><p>å¦‚æœé—®é¢˜æ¯”è¾ƒå¥½å¤ç°çš„è¯ï¼Œå¯ä»¥åœ¨è·¯å¾„ä¸Šå¤šå¢åŠ ä¸€äº›æ—¥å¿—è¾“å‡ºï¼ŒæŠŠå€¼å¾—æ€€ç–‘çš„æŒ‡é’ˆåœ°å€ä»¥åŠå®ƒä»¬è§£å¼•ç”¨ä¹‹åçš„å†…å®¹æ‰“å°å‡ºæ¥ï¼Œæœ‰æ—¶èƒ½å¤Ÿè§‚å¯Ÿåˆ°ä¸€ä¸ªæŒ‡é’ˆæ˜¯å¦‚ä½•ä¸€æ­¥æ­¥èµ°å‘éæ³•çš„ã€‚æ³¨æ„è§£å¼•ç”¨æ—¶æœ€å¥½æ”¾åˆ°å¦ä¸€è¡Œæ—¥å¿—ä¸­ï¼Œæ¯•ç«Ÿæ¯ä¸€ä¸ªè§£å¼•ç”¨æ“ä½œéƒ½æ˜¯åœ¨éæ³•è¾¹ç¼˜è¹¦è¿ªï¼Œå¦‚æœè¿™ä¸ªæŒ‡é’ˆåœ¨è§£å¼•ç”¨çš„æ—¶å€™å‡ºé”™å¯èƒ½ä¼šå¸¦ç€å…¶ä»–æœ‰ç”¨çš„æ—¥å¿—è¾“å‡ºä¸€èµ·æ¶ˆå¤±ã€‚</p><h2 id="å€ŸåŠ©å·¥å…·"><a href="#å€ŸåŠ©å·¥å…·" class="headerlink" title="å€ŸåŠ©å·¥å…·"></a>å€ŸåŠ©å·¥å…·</h2><p>ä¹Ÿå¯ä»¥é€šè¿‡ä¸€äº›å·¥å…·æ¥ç›‘æµ‹å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œæ¯”å¦‚å„ç§ <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/beta/unstable-book/compiler-flags/sanitizer.html">sanitizer</a> å’Œ <a target="_blank" rel="noopener" href="https://valgrind.org/">valgrind</a> ç­‰ï¼Œæœ‰çš„æ—¶å€™ä¸æ˜¯æ‰€æœ‰çš„å†…å­˜é—®é¢˜éƒ½ä¼šå¯¼è‡´ç¨‹åºæŒ‚æ‰ï¼Œä¸€äº›éæ³•çš„å†…å­˜æ“ä½œæœ‰å¯èƒ½è¢«å¿½ç•¥ï¼Œæ¯”å¦‚æ•°ç»„ç¨å¾®è¶Šç•Œä¸€ç‚¹ç‚¹ï¼Œä¸å°å¿ƒ free å¤šæ¬¡æˆ–å¿˜è®° free ç­‰ã€‚è¿™äº›å·¥å…·èƒ½å¤ŸåŠæ—¶åœ°å‘ç°è¿™äº›é—®é¢˜ã€‚ä¸è¿‡å®ƒä»¬éƒ½æˆ–å¤šæˆ–å°‘ä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½å½±å“ï¼Œæ‰€ä»¥ä¹Ÿä¸æ˜¯æ‰€æœ‰æƒ…å†µéƒ½é€‚ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># valgrind</span><br>$ cargo build<br>$ valgrind --leak-check=full --show-leak-kinds=all --tool=memcheck $(BIN)<br><br><span class="hljs-comment"># address sanitizer</span><br>$ <span class="hljs-built_in">export</span> RUSTFLAGS=-Zsanitizer=address RUSTDOCFLAGS=-Zsanitizer=address<br>$ cargo run -Zbuild-std --target x86_64-unknown-linux-gnu<br></code></pre></td></tr></table></figure><h2 id="ç‰¹æ®Šå€¼"><a href="#ç‰¹æ®Šå€¼" class="headerlink" title="ç‰¹æ®Šå€¼"></a>ç‰¹æ®Šå€¼</h2><p>æœ‰äº›ç¯å¢ƒä¼šåœ¨å†…å­˜æ“ä½œå‰åæŠŠé‚£ä¸€å—å†…å­˜è®¾ç½®ä¸Šç‰¹æ®Šå€¼æ¥è¡¨ç¤ºè¿™å—å†…å­˜çš„çŠ¶æ€ï¼Œä½¿å®ƒèƒ½æ–¹ä¾¿åœ°è¢«è§‚å¯Ÿåˆ°ã€‚å¦‚ jemalloc çš„ <code>--enable-fill</code> <a target="_blank" rel="noopener" href="https://github.com/jemalloc/jemalloc/wiki/Use-Case%3A-Find-a-memory-corruption-bug">å‚æ•°</a> æˆ– MariaDB çš„ <code>TRASH_ALLOC()</code> <a target="_blank" rel="noopener" href="https://github.com/MariaDB/server/blob/c9fcea14e9e1f34a97451706eac51276c85bbea7/include/my_valgrind.h?_pjax=%23js-repo-pjax-container,%20div%5Bitemtype=%22http://schema.org/SoftwareSourceCode%22%5D%20main,%20%5Bdata-pjax-container%5D#L97-L100">å®</a>ï¼Œä¼šæŠŠå›æ”¶çš„å†…å­˜å¡«ä¸Šä¸€ä¸ªç‰¹æ®Šå€¼ï¼Œå¦‚æœçœ‹åˆ°è¿™ä¸ªå€¼çš„è¯å°±çŸ¥é“æ˜¯å‘ç”Ÿäº† use after freeã€‚</p><h2 id="ç¼©å°èŒƒå›´"><a href="#ç¼©å°èŒƒå›´" class="headerlink" title="ç¼©å°èŒƒå›´"></a>ç¼©å°èŒƒå›´</h2><p>åˆ†ä¸ºä¸¤ä¸ªæ–¹é¢çš„ç¼©å°ã€‚å¦‚æœæ¡ä»¶å…è®¸çš„è¯ä¹Ÿå¯ä»¥é€šè¿‡æ³¨é‡Šæ‰ä¸€äº›ä»£ç æ¥ç¼©å°æ’æŸ¥èŒƒå›´ï¼Œæ¯”å¦‚å…ˆä¸è¿›è¡Œ free æ“ä½œæˆ–è€…æš‚åœéƒ¨åˆ†è·¯å¾„è¿›è¡Œè§‚å¯Ÿï¼›ä»¥åŠç¼©çŸ­è°ƒç”¨è·¯å¾„ï¼ŒæŠŠå„ä¸ªç»„ä»¶å•ç‹¬æ‹¿å‡ºæ¥ mock æµ‹è¯•ã€‚</p><p>è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å°åœ°æ–¹ï¼Œæ¯”å¦‚è§‚å¯ŸæŒ‡é’ˆæ˜¯å¦å¯¹é½ï¼Œå‡ºé”™çš„æŒ‡é’ˆä¸å‘¨å›´æŒ‡é’ˆçš„èŒƒå›´ç­‰ã€‚æ¯”å¦‚è¿™é‡Œ Go ä¸ Rust è¿è¡Œåœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…ï¼Œèƒ½å¤Ÿè§‚å¯Ÿå‡º Go å‡ºæ¥çš„æŒ‡é’ˆå’Œ Rust å‡ºæ¥çš„æŒ‡é’ˆåœ¨ä¸¤ä¸ªåœ°å€æ®µä¸Šï¼ŒæŒ‡é’ˆæœ¬èº«çš„å€¼æœ‰æ—¶å€™ä¹Ÿèƒ½å¤Ÿè¯´æ˜ä¸€äº›ä¿¡æ¯ã€‚ä¸è¿‡è¯´å½’è¯´ï¼ŒçœŸå†™å‡ºæ¥çš„å†…å­˜é—®é¢˜éƒ½æ˜¯è¡¨é¢ä¸Šåƒç¯‡ä¸€å¾‹ï¼ŒèƒŒåœ°é‡Œå„æœ‰åƒç§‹ã€‚å½“ç¨‹åºå†…å­˜å‡ºé”™æ—¶å¯èƒ½ä¼šå¸¦æ¥å„ç§åƒå¥‡ç™¾æ€ªçš„è¡¨ç°ï¼Œæå¤šäº†å°±èƒ½å¤Ÿå¯¹ä¸åŒçš„é—®é¢˜è¿›è¡Œåˆ†ç±»å¹¶æ¡ˆã€‚æ¯•ç«Ÿä¸€èˆ¬æ¥è¯´å…¨ç„¶æ— è®¡å¯æ–½çš„æƒ…å†µæ¯”è¾ƒå°‘ï¼Œè€Œé€šå¸¸æ˜¯æœ‰è®¸å¤šæ‰‹æ®µä½†ä¸çŸ¥é“å“ªä¸€ä¸ªæ‰èƒ½å¾—åˆ°ä¿¡æ¯ã€‚æ¯ä¸ªæŠ€èƒ½éƒ½ä¼šæœ‰æ–½æ³•æ—¶é—´æ¶ˆè€—ï¼Œä¸‡ä¸€è¢« invalid pointer çº ç¼ å¤ªä¹…å¯¼è‡´åšæ¢¦éƒ½æ˜¯panicå°±å¾ˆç—›è‹¦äº†ğŸ˜‡ã€‚</p><p>åœ¨åˆ¶ä½œ shimï¼Œbinding å’Œå®ƒä»¬çš„ c demo çš„æ—¶å€™é€šè¿‡ä¸€äº› C é‡æ–°ä½“éªŒäº†ä¸€ä¸‹<span class="heti-em">æ–‡æ˜çš„è¿›æ­¥</span>ã€‚ä¸è¿‡ç°åœ¨å›è¿‡å¤´æƒ³æƒ³åº”è¯¥è¿˜æœ‰æ›´å…ˆè¿›çš„æ–¹æ³•æ¥é¿å…ä¸€äº›é—®é¢˜çš„ï¼Œæœ‰çš„æ—¶å€™çš„ç¡®æ˜¯è‡ªå·±ä½œæ­»ã€‚</p><h1 id="ä¿¡å·"><a href="#ä¿¡å·" class="headerlink" title="ä¿¡å·"></a>ä¿¡å·</h1><p>è¿™æ˜¯ä¸€ä¸ªèŠ±äº†æ¯”è¾ƒä¹…æ—¶é—´çš„é—®é¢˜ï¼Œå™©æ¢¦ä»ä¸€æ¬¡ SIGSEGV å¼€å§‹ï¼ˆè¿™ä¸ªæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå†…å­˜é—®é¢˜ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">fatal error: unexpected signal during runtime execution<br>[signal SIGSEGV: segmentation violation code=0x2 addr=0x18589091b1 pc=0x7f9205f814ba]<br>runtime stack:<br>runtime.throw(&#123;0xace954, 0xefc4e055&#125;)<br>        /home/go/src/runtime/panic.go:1198 +0x71 fp=0x7f91dce8afe8 sp=0x7f91dce8afb8 pc=0x448451<br>runtime.sigpanic()<br>        /home/go/src/runtime/signal_unix.go:719 +0x396 fp=0x7f91dce8b038 sp=0x7f91dce8afe8 pc=0x45fdf6<br></code></pre></td></tr></table></figure><p>è¿™é‡Œä»å¤ç°å°±ä¸é¡ºåˆ©ï¼ŒåŸå§‹åœºæ™¯å¤§æ¦‚éœ€è¦åŠå¤©åˆ°ä¸€å¤©æ‰èƒ½å‡ºç°ï¼ŒåŒæ—¶ä¹Ÿæœ‰å…¶ä»–æœªè§£å†³çš„é—®é¢˜æ··æ‚åœ¨ä¸€èµ·ï¼Œå¹¶ä¸”å­˜åœ¨è®¸å¤šä¸åŒçš„ç³»ç»Ÿç¯å¢ƒå’Œæµé‡ï¼Œå„æ–¹é¢æ¥è¯´éƒ½éå¸¸åœ°ç‹±ã€‚</p><p>åœ¨èŠ±äº†ä¸€äº›æ—¶é—´æŠŠå…¶ä»–çš„å› ç´ éƒ½æ’é™¤æ‰ä¹‹åï¼Œç»ˆäºèƒ½å¤Ÿå¼€å§‹çœ‹ SIGSEGV äº§ç”Ÿçš„ core dump æ–‡ä»¶ã€‚ä½†æ˜¯é€šè¿‡ gdb æ¥çœ‹ core çš„æ—¶å€™ï¼Œéƒ½åŸºæœ¬ä¸Šæ˜¯è¿™æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs plain">Thread  (Thread 0x7f7c45fef700 (LWP 47715)):<br>#0  0x0000000000895b93 in runtime.futex ()<br>#1  0x0000000000860a20 in runtime.futexsleep ()<br>#2  0x0000000001dea010 in runtime.sched ()<br>#3  0x0000000000000080 in ?? ()<br>#4  0x00007f7c45feccb0 in ?? ()<br>#5  0x0000000000000000 in ?? ()<br>Thread  (Thread 0x7f7c457ee700 (LWP 47716)):<br>#0  0x0000000000895b93 in runtime.futex ()<br>#1  0x00000000008609ab in runtime.futexsleep ()<br>#2  0x000000c00011e840 in ?? ()<br>#3  0x0000000000000080 in ?? ()<br>#4  0x0000000000000000 in ?? ()<br>Thread  (Thread 0x7f7c4468c700 (LWP 52927)):<br>#0  0x00007f7c49301489 in syscall () from /lib64/libc.so.6<br>#1  0x00007f7c49834da9 in futex_wait (self=0x7f7c4468a640, ts=...) at parking_lot_core-0.8.5/src/thread_parker/linux.rs:112<br></code></pre></td></tr></table></figure><p>é—®å·çš„é‚£äº›å¾ˆå¥½çŒœæ˜¯ Go çš„ m:n çº¿ç¨‹æ¥çš„ï¼Œä½†æ˜¯å…¶ä»–é Go çš„çº¿ç¨‹å´éƒ½åœåœ¨ syscall ä¸Šã€‚ä¸€ä¸‹å­å®Œå…¨ä¸çŸ¥é“åˆ°åº•è¯¥ blame è°ï¼Œä¸ºäº†æŸ¥çœ‹ä¸‹ Go é‡Œé¢å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Œä¹Ÿç”¨è¿‡ <a target="_blank" rel="noopener" href="https://github.com/go-delve/delve">delve</a> æ¥çœ‹çœ‹ Go çš„å †æ ˆï¼Œç”¨æ³•å’Œ gdb ç±»ä¼¼ã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰äº›ç—›è‹¦çš„è¿‡ç¨‹ï¼Œdump å‡ºäº†å‡ åƒä¸ª goroutine çš„ backtraceï¼Œè€Œä¸”èŠ±äº†äº›æ—¶é—´ç®€å•çœ‹äº†ä¸‹æ ˆé¡¶ä¹‹åå‘ç°åŸºæœ¬éƒ½æ˜¯ä¸šåŠ¡ goroutineï¼Œæ²¡æœ‰ä»€ä¹ˆå¥½æ€€ç–‘çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plain">(dlv)   Goroutine 1 - User: main.go:207 main.main (0xfa6f0e) [chan receive (nil chan) 451190h16m34.324364485s]<br>  Goroutine 2 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [force gc (idle) 451190h16m34.619109482s]<br>  Goroutine 3 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [GC sweep wait]<br>  Goroutine 4 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [GC scavenge wait]<br>  Goroutine 5 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [finalizer wait 451190h14m6.860088484s]<br>* Goroutine 17 - User: /root/go/src/runtime/sys_linux_amd64.s:165 runtime.raise (0x82acc1) (thread 71636) [GC assist marking]<br>  Goroutine 47 - User: /root/go/src/runtime/proc.go:367 runtime.gopark (0x7f8076) [select 451190h16m34.324667846s]<br>  Goroutine 48 - User: /root/go/src/runtime/sigqueue.go:169 os/signal.signal_recv (0x825998) (thread 67111)<br></code></pre></td></tr></table></figure><p>å”¯ä¸€çš„ä¿¡æ¯å°±æ˜¯çœ‹åˆ°äº† SIGSEGV æ˜¯ä»å“ªé‡Œå‡ºæ¥çš„ï¼ˆGoroutine 17ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">runtime.throw(&#123;0xace954, 0xefc4e055&#125;)<br>        /home/go/src/runtime/panic.go:1198 +0x71 fp=0x7f91dce8afe8 sp=0x7f91dce8afb8 pc=0x448451<br>runtime.sigpanic()<br>        /home/go/src/runtime/signal_unix.go:719 +0x396 fp=0x7f91dce8b038 sp=0x7f91dce8afe8 pc=0x45fdf6<br></code></pre></td></tr></table></figure><p>çœ‹ç€æœ‰ç‚¹çœ¼ç†Ÿï¼Œå°±æ˜¯ç»å¸¸åœ¨é”™è¯¯ä¿¡æ¯é‡Œé¢å‡ºç°çš„ç¬¬ä¸€è¡Œ stackã€‚è¿™ä¸ª goroutine åªæœ‰ä¸Šé¢ä¸¤å±‚ã€‚åªèƒ½è¯´è¿™ä¸ªä¿¡æ¯è™½ç„¶æœ‰ç”¨ï¼Œä½†åŸºæœ¬æ²¡ç”¨ã€‚</p><p>åˆç»è¿‡äº†ä¸€äº›æ—¶é—´çš„æŒ£æ‰ï¼Œæœ€åæ€€ç–‘ä¸Šé¢çœ‹åˆ°çš„ core dump å¹¶ä¸æ˜¯å®é™…ä¸Šçš„ç¬¬ä¸€æ‰‹å †æ ˆã€‚é€šè¿‡æŠŠæ•´ä¸ªè¿›ç¨‹æŒ‚åœ¨ gdb é‡Œé¢è¿è¡Œï¼Œç»ˆäºèƒ½å¤Ÿæ‹¿åˆ°éæ³•æ“ä½œå®é™…ä¸Šå‡ºç°çš„ä½ç½®ï¼Œè®© gdb åœ¨ä¿¡å·ç¬¬ä¸€æ¬¡æŠ›å‡ºçš„æ—¶å€™å…ˆäº Go runtime æ•è·åˆ°å®ƒã€‚ç°åœ¨å›çœ‹èµ·æ¥æƒ³è¯´ï¼šå¦‚æœæ—©çŸ¥é“ï¼Œå †æ ˆä¿¡å·ä¼šè¢« Go runtime è½¬æ‰‹â€¦</p><p><img src="3.png" alt="img"></p><p>åœ¨èƒ½å¤Ÿçœ‹åˆ°ç¬¬ä¸€æ¡ˆå‘ç°åœºä¹‹åï¼Œåç»­çš„æµç¨‹å°±æ¯”è¾ƒæ™®é€šäº†ï¼Œè€Œä¸”æ ¹å› æ˜¯ä¸ªè‡ªå·±æŒ–çš„å¼±æ™ºå‘ã€‚</p><h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>åˆ†äº«æˆ‘å¾ˆå–œæ¬¢çš„ä¸€å¥è¯ï¼š</p><blockquote><p>å›å­ä¸ç«‹äºèŠ±æ´»ä¹‹ä¸‹ã€‚</p></blockquote><p>å¦‚æœå†è®©æˆ‘é€‰ä¸€æ¬¡ï¼Œæ‰“æ­»ä¹Ÿä¸ä¼šè¡¨æ¼”è¿™ä¸ªæ‚æŠ€ã€‚ç‰¹åˆ«æ˜¯æœ€åå‘ç°ä¸€é€šæ“ä½œçŒ›å¦‚è™ï¼Œä¸€çœ‹QPSåªæœ‰5 ğŸ˜‡ã€‚è¿˜ä¸å¦‚ä¹–ä¹–å¼„ä¸€äº›é è°±çš„ä¸œè¥¿ï¼ˆè™½ç„¶è¢«æ¯’æ‰“ä¹‹å‰ä¹Ÿè§‰å¾— CGO ä¸è¿‡å¦‚æ­¤â€¦â€¦ï¼‰ã€‚</p><!-- # å‚è€ƒ -->]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h1&gt;&lt;p&gt;æ•…äº‹å‘ç”Ÿåœ¨èš‚èšä¸€ä¸ªå†…éƒ¨é¡¹ç›®ä¸Šï¼Œè¿™ä¸ªé¡¹ç›®æœ‰ Go å’Œ Rust ä¸¤ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­ Rust åº“ä½œä¸ºä¸€ä¸ªå­˜å‚¨ç»„ä»¶è¢« Go çš„ä¸šåŠ¡éƒ¨åˆ†ä¾èµ–ç€ã€‚å‡ºäºç§</summary>
      
    
    
    
    
    <category term="Rust" scheme="https://waynexia.github.io/tags/Rust/"/>
    
  </entry>
  
  <entry>
    <title>å¤©ç©—ä¹‹å’²ç¨»å§¬</title>
    <link href="https://waynexia.github.io/2021/02/sakuna-rice-and-ruin/"/>
    <id>https://waynexia.github.io/2021/02/sakuna-rice-and-ruin/</id>
    <published>2021-02-24T15:49:28.000Z</published>
    <updated>2023-11-23T08:35:22.628Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>æœ€åæ”¾staffåå•çš„æ—¶å€™çš„ç‰‡å°¾æ›²ã€‚å¦å¤–ä¸€ä¸ªå”±å¾—ä¸å¤ªæ­£ç»çš„ç‰ˆæœ¬ä¹Ÿå¾ˆæœ‰æ„æ€ï¼Œå˜å¥åœ¨è®¸å¤šåœºæ™¯é‡Œé¢éƒ½å‡ºç°è¿‡ã€‚å¯èƒ½æ˜¯æ­Œæ¯”è¾ƒæ…¢ï¼Œæ‰“å‡ºstaffä¹‹åèººåœ¨åºŠä¸Šå¬ç€å¬ç€ç¡ç€äº†ã€‚</p></blockquote><div class="aplayer-box" data-name='ãƒ¤ãƒŠãƒˆç”°æ¤å”„' data-artist='å¤§å¶‹å•“ä¹‹ / æœå€‰ã•ã‚„' data-url='https://music.163.com/song/media/outer/url?id=1813023950.mp3' data-cover='https://p1.music.126.net/RtdA4v9i3JESvxWC_LVLeQ==/109951165639529932.jpg' ></div><hr><p>ç§ç”°ï¼Œæˆ˜æ–—å’Œæ•…äº‹èåˆå¾—ä¸é”™çš„æ¸¸æˆï¼ˆ<strong>åŒ…å«å‰§é€</strong>ï¼‰</p><p>è™½ç„¶è¯´ç§ç”°æ€ä¹ˆæƒ³éƒ½æ˜¯é‡å¤åº¦å¾ˆé«˜ï¼Œå¾ˆæ¯ç‡¥çš„ä¸œè¥¿ï¼Œä½†æ˜¯åœ¨ç›®å‰ç»å†çš„åä¸ªæ˜¥ç§‹ä¸­å¹¶æ²¡æœ‰è§‰å¾—é‡å¤åˆ°ä»¤äººçŠ¯å›°ï¼Œåè€Œè§‰å¾—éå¸¸æœ‰è¶£ã€‚æ“ä½œè™½ç„¶éƒ½æ˜¯å›ºå®šçš„â€“è€•åœ°æ’ç§§é…è‚¥æ–™æ”¶å‰²å‡ºç±³ï¼Œä½†æ˜¯ä¸­é—´æœ‰è®¸å¤šäº‹æƒ…æ¥è°ƒèŠ‚ï¼Œæ¯”å¦‚è¯´æ®æ±‚ï¼Œæ¢ç´¢ï¼Œä¸€äº›éšæœºå–å¾—çš„ç‰©å“ï¼Œä¸åŒçš„ç›®æ ‡å±æ€§æ‰€è¦æ±‚çš„å®Œå…¨ä¸åŒçš„ç§æ¤æ–¹æ³•ç­‰ã€‚ä¸è¿‡å¯æƒœæœ€åè¿˜æ˜¯æ²¡ç§æ˜ç™½åœ°ï¼Œå‡ ä¸ªå±æ€§çš„å½±å“å› ç´ ä¹Ÿæ²¡å¼„æ¸…æ¥šï¼Œä¸€äº›ç—…å‘ä½œçš„æ—¶å€™ä¹Ÿä¸çŸ¥é“æ€ä¹ˆè§£å†³ï¼Œæ€»çš„æ¥è¯´åº”è¯¥åªçŸ¥é“äº†åŸºæœ¬è¿‡ç¨‹è¿™ç§éå¸¸çš®æ¯›çš„ä¸œè¥¿ã€‚ä½œä¸ºç§ç”°æ¨¡æ‹Ÿå™¨æ¥è¯´åº”è¯¥è¿˜æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†è¦ç´ æ²¡ä½“éªŒåˆ°ï¼Œæ¯”å¦‚æœ€åé¢æ–°ä¿®çš„æ°´ç£¨åŠä¹‹ç±»çš„ã€‚ä½†æ˜¯ä¸°æ”¶çš„å¿«ä¹è¿˜æ˜¯å¾ˆå¥½ä½“éªŒåˆ°äº†<del>ï¼ˆèƒ½ç»“å‡ºç©—ä¹Ÿå¾ˆå‰å®³äº†ï¼‰</del>ã€‚</p><p>æ®è¯´æ—¥æœ¬å†œæ—æ°´äº§çœçš„ç½‘ç«™åœ¨æ¸¸æˆå‘å”®ä¹‹åè®¿é—®é‡çˆ†å¢ï¼Œæ˜¯å› ä¸ºç§ç”°ç³»ç»Ÿå¤ªç¡¬æ ¸ï¼Œç©å®¶ç›´æ¥å¼€å§‹å‚è€ƒç°å®çš„ç§ç”°æ”»ç•¥äº†ã€‚æˆ‘ä¹Ÿå› ä¸ºæ°´ç¨»çš„ç–¾ç—…ä¸€ç›´æ²»ä¸å¥½ç¿»æ”»ç•¥ç¿»åˆ°äº†å†œä¸šç½‘ç«™ï¼Œä½†æ˜¯é©¬ä¸Šå°±çœ‹ä¸æ‡‚è¢«åŠé€€å‡ºæ¥äº†ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯æ‰¾é’ˆå¯¹æ€§çš„æ”»ç•¥æ¯”è¾ƒé€‚åˆæˆ‘â€¦â€¦</p><p>æ“ä½œæ–¹é¢æœ‰äº›åœ°æ–¹ä¸æ˜¯å¾ˆé¡ºæ‰‹ï¼Œä¸€æ˜¯ç¾½è¡£åªæœ‰å…«ä¸ªæ–¹å‘ï¼Œå¯èƒ½æ˜¯é’ˆå¯¹é”®ç›˜è®¾è®¡çš„æ“ä½œå§ï¼Œåœ¨å‰æœŸæ²¡æœ‰ä¹ æƒ¯çš„æ—¶å€™æœ‰äº›å°å­è·³å¾—çœŸæ˜¯è¡€å‹å‡é«˜â€¦å¦ä¸€ä¸ªæ˜¯è·Ÿç€ç©å®¶ç§»åŠ¨å’Œè‡ªåŠ¨è°ƒæ•´è§†è§’ï¼Œåœ¨ä¸€èˆ¬æ—¶å€™è¿˜è¡Œï¼Œæ¯”å¦‚çˆ¬å®¶å‰é¢é‚£æ®µå±±å¡å°±å¯ä»¥åªç”¨å·¦æ‘‡æ†å®Œæˆï¼Œä½†æ˜¯åˆ°äº†æ’ç§§çš„æ—¶å€™å°±å˜æˆäº†å™©æ¢¦ï¼Œç”¨æ‘‡æ†çš„ä½ æ°¸è¿œå¯¹ä¸é½æ–¹å‘ï¼Œåªèƒ½ä¸Šåƒåœ¾åå­—é”®æ¥å‹‰å¼ºç”¨ç”¨ï¼Œè€Œä¸”å‘ç°æ­ªäº†ä¹Ÿå¾ˆéš¾å¾®è°ƒã€‚</p>    <figure class="figure-image">      <img src="2021021717524300-3E76408CDEF3BAC51A41DB325F1EE97E.jpg" alt="å†³æˆ˜å‰çš„ç¥­å…¸" width="70%" height="100% loading="lazy" />      <figcaption>å†³æˆ˜å‰çš„ç¥­å…¸</figcaption>    </figure>  <p>æˆ˜æ–—éš¾åº¦å¯¹æˆ‘è¿™ä¸ªæ‰‹æ®‹ç©å®¶æ¥è¯´æ„Ÿè§‰å¾ˆå‹å¥½ï¼Œè€Œä¸”æ¯”è¾ƒè‡ªç”±çš„åœ°æ–¹å°±æ˜¯å¯ä»¥è‡ªå·±éšä¾¿è°ƒèŠ‚æˆ˜æ–—å’ŒåŠ¡å†œçš„æ¯”ä¾‹ï¼Œæ‰“ä¸è¿‡äº†å°±ä¸æ‰“äº†ï¼Œå›å»ç§ç§ç”°åƒé¥±é¥±å°±èƒ½ç¢¾å‹ã€‚å…³é”®é“å…·ä¹Ÿæ¯”è¾ƒå°‘å¡ï¼Œè€Œä¸”æœ€åæ‰“bossçš„æ­¦å™¨è¿˜æ˜¯ç›´æ¥é€çš„ï¼Œå¤§æ¦‚åœ¨ç¥­å…¸ä¹‹å‰çš„ä¸€å¹´å·¦å³åº”è¯¥å°±æ²¡ä»€ä¹ˆä¸œè¥¿éœ€è¦å†å»åˆ»æ„æ”¶é›†äº†ã€‚å¦‚æœæ˜¯ç§ç”°çˆ±å¥½è€…ï¼Œåœ¨å‰§æƒ…ç»“æŸä¹‹åè¿˜æœ‰ä¸€ä¸ªä¸‰ç™¾å±‚çš„å¤©è¿”å®«å¯ä»¥å½“end gameï¼Œèƒ½ç»§ç»­ç§ç”°-åƒé¥­-æ‰“æ¶çš„å®Œæ•´æµç¨‹ã€‚è™½ç„¶å‡ºç°å¾—æ¯”è¾ƒçªå…€ï¼Œä¸æ˜¯å¾ˆæ¸…æ¥šå®ƒçš„èƒŒæ™¯ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘æ¼äº†ï¼‰ã€‚ä¸è¿‡æˆ‘å‡ åå±‚å°±æ»šè›‹äº†ï¼ˆ</p><p>æˆ˜æ–—æ–¹é¢çš„é‡å¤æ„Ÿåˆ°åé¢å°±æœ‰äº›å‡ºç°äº†ã€‚æ¸¸æˆçš„æ€ªç‰©ç§ç±»è®¾è®¡å¾—æ¯”è¾ƒå°‘ï¼Œå‰åæœŸåœ°å›¾çš„éš¾åº¦å˜åŒ–åŸºæœ¬åªæ˜¯é€šè¿‡è°ƒæ•´æ€ªç‰©å¼ºåº¦æ¥å®ç°çš„ã€‚ä½†æ˜¯å¯¹æ¯”å¡å°”è¾¾æ›´å¤§çš„åœ°å›¾ï¼Œæ€ªç‰©ç§ç±»ä¹Ÿæ²¡æœ‰éå¸¸å¤šã€‚ç§ç±»å°‘å¯èƒ½å¹¶ä¸æ˜¯ç›´æ¥çš„åŸå› ï¼Œå‡ºæˆ˜æ–—æ˜¯ä¸‹å‰¯æœ¬çš„å½¢å¼ï¼Œä»¥åŠä¸€äº›ææ–™æ”¶é›†å’Œæ€ªç‰©ä¸æˆ˜æ–—åŸºæœ¬ç»‘å®šåº”è¯¥ä¹Ÿæ˜¯å¾ˆé‡è¦çš„åŸå› ã€‚</p><hr><p>æ•…äº‹æ–¹é¢çš„æ¢—æ¦‚åœ¨æœ€å¼€å§‹çš„introç« èŠ‚å°±è®²è¿°çš„å·®ä¸å¤šäº†ï¼Œç¥ä»™é—¯äº†ç¥¸è¢«èµ¶åˆ°è’éƒŠé‡å²­å’Œå‡¡äººä¸€èµ·ç§ç”°ã€‚è¿™ä¸ªé¬¼å²›æ—¥ä¹‹ç©—æ˜¯sakunaçˆ¶æ¯ä¹‹å‰è®¤è¯†çš„åœ°æ–¹ï¼Œå¥½åƒä¹Ÿæ˜¯sakunaå‡ºç”Ÿçš„åœ°æ–¹ï¼ˆæœ‰è¿™ä¸ªå—ï¼Œå¥½åƒè®°é”™äº†ï¼‰ï¼Ÿã€‚ä¸»åœºæ™¯å°±æ˜¯ä¸Šé¢é‚£ä¸ªå±±å¤´ï¼Œä¸€ä¸ªå°æˆ¿å­å’Œä¸€å—ç”°ã€‚å› ä¸ºå¤§å®¶åŸºæœ¬ä¸Šéƒ½ä¸æ˜¯ä»€ä¹ˆæ­£ç»äººï¼ˆå­—é¢ï¼‰ï¼Œæœ‰è¶£çš„æ—¥å¸¸ä¸å°‘ã€‚ä¸è¿‡æ¯•ç«Ÿæ˜¯ç§ç”°æ¸¸æˆï¼Œå‰§æƒ…ä»€ä¹ˆçš„å“ªæœ‰ç”°é‡è¦ï¼ˆï¼‰å¿ƒç¯å’Œç«å±±çˆ†å‘ä¸¤ä¸ªå°é«˜æ½®çš„æ„Ÿè§‰æŒºä¸é”™ï¼Œä½†æ˜¯å½“æ—¶æ»¡è„‘å­éƒ½æ˜¯æ°´ç¨»ï¼Œæ²¡æœ‰å¾ˆå¸¦å…¥è¿›å»ã€‚</p><p>å…³äºsakunaçš„çˆ¶æ¯å»å“ªé‡Œäº†åœ¨æœ€ç»ˆæˆ˜ä¹‹å‰å±…ç„¶ä¸€ç›´æ²¡è¯´ï¼Œç”šè‡³åœ¨å¿ƒç¯å…¬ä¸»é‚£ä¸€æ¬¡å›å¾¡æŸ±éƒ½çš„æ—¶å€™æˆ‘éƒ½è¿˜ä»¥ä¸ºçˆ¶æ¯è¿˜åœ¨ï¼Œç„¶åè‡ªå·±ççŒœäº†ä¸€å †å¥‡æ€ªçš„è®¾å®šã€‚æœ€åå·®ç‚¹å¿˜äº†è¿˜æœ‰è®¸å¤šä¼ç¬”å¥½åƒæ²¡å›æ”¶ï¼Œæ˜¯è°åœ¨æ“çºµé¬¼æ—å‘¢ï¼Œåšç¾½è¡£å’Œå®ç°ç»“çš„æ„¿æœ›çš„æ˜¯è°ï¼Œå†œèŠ±çš„æ¥å†æ˜¯ä»€ä¹ˆç­‰ç­‰ï¼Œä½†æ˜¯è§‰å¾—è¿™ä¸ªç§ç”°ç³»ç»Ÿå·²ç»å¾ˆå®Œå–„ï¼Œå¦‚æœè¯´è¦å‡ºç»­é›†çš„è¯ä¹Ÿæƒ³ä¸åˆ°ä¼šæ€ä¹ˆæ“ä½œï¼Œå°±å½“è¿™äº›æ˜¯ç•™ç™½å§ã€‚</p>    <figure class="figure-image">      <img src="2021021719023200-3E76408CDEF3BAC51A41DB325F1EE97E.jpg" alt="æœ€åè§ä¸€é¢" width="70%" height="100% loading="lazy" />      <figcaption>æœ€åè§ä¸€é¢</figcaption>    </figure>  <p>å¹´åå¼€å§‹ç©ï¼Œæ–­æ–­ç»­ç»­ç©äº†åä¸ªå°æ—¶å·¦å³ä¹‹ååœ¨åˆäº”åˆå…­å…³åœ¨æˆ¿é—´é‡Œé¢è‚äº†ä¸¤å¤©æ‰“é€šä¸»çº¿ï¼Œç°åœ¨è¿˜æ˜¯åœ¨æƒ³ç§ç”°çš„äº‹æƒ…ã€‚ç”šè‡³æœ‰ç‚¹æƒ³å»åšåšå†œæ´»ï¼Œè¿˜å¥½æ˜¯åœ¨å†¬å¤©ï¼ˆ</p><p>RPGçš„å±æ€§è¦ç´ é€šè¿‡ç§ç”°åƒé¥­ä½“ç°å‡ºæ¥çš„ï¼Œä¸€æ—¥ä¸‰é¤éƒ½æœ‰å±æ€§å½±å“ã€‚å¤´ä¸¤ä¸‰å¹´è¿‡ç€ä¸€è¨€ä¸åˆå°±åªé å–æ°´åº¦è¿‡ä¸€å¤©çš„æ—¥å­ï¼Œåˆ°äº†åé¢ç”°åœ°å’Œç›å¤šèµ·æ¥ä¹‹åéƒ½æ‡’å¾—æ¯å¤©ç¿»åº“å­˜ï¼Œåªæ¯æ™šæŠŠçŒåˆ°çš„é£Ÿç‰©å¤„ç†ä¸€ä¸‹ï¼Œå®Œå…¨åƒä¸å®Œï¼ˆç»å…¸ç©·çš„æ—¶å€™ä¸èˆå¾—ç”¨æ¶ˆè€—å“ï¼Œåº“å­˜è¶³äº†æ‡’å¾—ç¿»å‡ºæ¥xï¼‰ã€‚åœ¨æ‰“å®Œä¹‹åå¬è¯´åˆ°äº†ä¸€ä¸ªé‚ªé“æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡å †è‚¥æ¥å»¶é•¿é£Ÿç‰©çš„ä¿è´¨æœŸã€‚è¿™åœºæ™¯æƒ³æƒ³å°±å¾ˆä¸å¾—äº†ï¼Œå¯æƒœä»æ¥æ²¡æœ‰è¿‡æŠŠå †è‚¥çš„ä¸œè¥¿æ‹¿å»åƒçš„æƒ³æ³•ï¼Œç™½èŠ‚çœäº†å¾ˆå¤šä¸œè¥¿ï¼ˆæ¯æ¬¡å»å †è‚¥çš„æ—¶å€™éƒ½æƒ³åæ§½å•æ‰€å±…ç„¶æ²¡æœ‰é—¨</p><!-- é‡æ–°å›åˆ°å±±å¤´ä¸Šé¢ï¼Œé™¤æ‰äº†ä½œæ¶çš„å¤§é¾™ï¼Œç»ˆäºå’Œçˆ¶æ¯è§é¢å¹¶å‘Šåˆ«ï¼Œå’Œå¾¡æŸ±éƒ½çš„ç¥ä»™ä»¬æœ‰äº†æ›´å¤šçš„å¾€æ¥ï¼Œå’Œä¼™ä¼´ä»¬ä¸€èµ·å¼€å¦æ›´å¤šçš„ç”°åœ°ï¼Œç­‰ç€æŸä¸€å¤©å¤§æ¡¥å†æ¬¡å‡ºç°ã€‚ -->    <figure class="figure-image">      <img src="2021021719094300-3E76408CDEF3BAC51A41DB325F1EE97E.jpg" alt="ä¸»é¢˜æ›²å’Œå¤§å®¶çš„äººè®¾éƒ½å¾ˆæ£’ï¼Œè°ä¸æƒ³å¼€ç€ç¥ä»™å»ç§ç”°å‘¢" width="70%" height="100% loading="lazy" />      <figcaption>ä¸»é¢˜æ›²å’Œå¤§å®¶çš„äººè®¾éƒ½å¾ˆæ£’ï¼Œè°ä¸æƒ³å¼€ç€ç¥ä»™å»ç§ç”°å‘¢</figcaption>    </figure>  <p>åœ¨æœ€åæ‰“å€’å¤§å®¶å¤§é¾™æ„‰å¿«åœ°èµ°åœ¨å›å®¶çš„è·¯ä¸Šçš„æ—¶å€™ï¼Œæƒ³åˆ°å¥¹ä»¬æ˜å¹´è¿˜æ˜¯è¦æ¥ç€ç§ç”°ï¼Œæˆ‘æ˜å¤©è¦å¼€å§‹ä¸Šç­ã€‚å°±çªç„¶è§‰å¾—å·¥ä½œçœŸæ˜¯â€¦ğŸ˜­</p><hr><p>çœ‹ç€edä¸­å‡ ä¸ªäººèµ°åœ¨ç”°é—´å°è·¯ä¸Šï¼Œåœ¨æƒ³åº”è¯¥æœ‰å¾ˆå¤šç±»ä¼¼å¤äº‹è®°é‡Œé¢çš„æ•…äº‹æš—å–»æ²¡æœ‰getåˆ°å§ï¼Ÿæ¯•ç«Ÿé‚£äº›ç¥ç¥‡çš„åå­—é‡Œé¢ä¹Ÿæœ‰å¾ˆå¤šç©—å•Šç¨»å•Šä»€ä¹ˆçš„ã€‚ä¸´ç»“å±€çš„æ—¶å€™ä¸€ç›´åœ¨çŒœä¹‹åä¼šæ€ä¹ˆå®‰æ’ï¼Œè¿˜æ˜¯éå¸¸å‡ºä¹æ„æ–™çš„ã€‚æœ¬æ¥ä»¥ä¸ºåªæœ‰åœ£å¥³ä¼šå›åˆ°å‡¡é—´ï¼Œæ²¡æƒ³åˆ°é‡‘å¤ªå’Œé¥²ä¸¸ä¹Ÿä¸€èµ·ä¸‹å»äº†ã€‚é™¤äº†sakunaå’Œç»“ä¹‹å¤–çš„å…¶ä»–äººéƒ½æ²¡æœ‰çŒœå¯¹ï¼š</p><div class="heti heti--vertical"><blockquote><p>ä¹‹å<strong>ç±³é²ç¼‡</strong>å›åˆ°å‡¡é—´ï¼Œç¼–å†™äº†å¤šæœ¬ä¹¦ç±å¹¶å‡ºç‰ˆäºä¸–ã€‚è¿˜æˆç«‹äº†å¼—ç½—æ‘©æ–¯æ–°æ•™æ´¾ï¼Œå¸¦ç»™äººä»¬å…¨æ–°çš„è§‚ç‚¹å’Œä»·å€¼è§‚ã€‚ï¼ˆæ²¡æ‰¾åˆ°å¯¹åº”çš„å®—æ•™ï¼‰</p><p><strong>é¥²ä¸¸</strong>åœ¨å‡¡é—´æˆä¸ºäº†ä¸€ä½æ¸©æŸ”çš„å†œå¤«ï¼Œç”±äºä»–èƒ½å¯¹åˆ«äººçš„æ„Ÿå—äº§ç”Ÿæ·±åˆ»å…±é¸£ï¼Œæ‰€ä»¥æ‘å­é‡Œçš„äººæœ‰äº‹éƒ½ä¼šæ‰¾ä»–å•†é‡ã€‚</p><p><strong>ç”°å³å«é—¨</strong>è¿˜æ˜¯ä¸€æ ·åœ¨æ—¥ä¹‹æƒ å‹¤å¥‹ç§ç¨»ï¼Œè™½ç„¶æ€»æœ‰ç‚¹è¿‡å¤´ï¼Œä½†ä¹Ÿå› ä¸ºä»–æ‡‚ç¤¼æ³•è§„åˆ™ï¼Œæ‰€ä»¥åˆæ¸æ¸è·è®¤å¯ç§°ä¸ºä¸°ç©°ç¥ã€‚</p><p>å›åˆ°å‡¡é—´çš„<strong>é‡‘å¤ª</strong>æˆäº†é©°åè¿œè¿‘çš„ä¼ è¯´é”»é€ å¸ˆï¼Œå¬è¯´ä»–è¿˜æˆäº†æŒºä¼šå–é…’çš„é…’è±ªã€‚</p><p>ä¸é‡‘å¤ªåˆ†å¼€åï¼Œ<strong>ç»“</strong>æˆä¸ºä¸€ä½ç¾ä¸½çš„çººç»‡å¥³ç¥ã€‚è¯¸ç¥å¬é—»äº†å¥¹çš„æ¶ˆæ¯åï¼Œç»œç»ä¸ç»åœ°é€ è®¿æ—¥ä¹‹æƒ å‘å¥¹æ±‚å©šï¼Œä½†æ¯æ¬¡éƒ½è¢«ä½ä¹…åèµ¶å›å»ã€‚www</p><p><strong>é­‚çˆ·</strong>æœ€è¿‘å€’æ˜¯å¸¸å¸¸å‘å‘†ï¼Œæˆ–è®¸æ˜¯å› ä¸ºä½ä¹…åçš„æˆé•¿è®©ä»–äº†æ— ç‰µæŒ‚äº†å§ã€‚ä¸ç®¡æ€ä¹ˆè¯´ï¼Œèº«ä¸ºäººè‡£çš„ä»–ä¼¼ä¹è¿‡å¾—æŒºå¹¸ç¦ã€‚</p><p>è€Œ<strong>å¿ƒç¯</strong>äºå…¬äºç§éƒ½å¾—åˆ°ç¥çµæ ‘å°Šçš„é‡ç”¨ï¼Œæ¯å¤©éƒ½å¿™ç¢Œä¸”å……å®ã€‚ä¹‹åå´å› æŸä»¶äº‹åœ¨éƒ½åŸå’Œå¦ä¸€åå‘æ˜ç¥èµ·äº†äº‰ç«¯ï¼Œä¸è¿‡è¿™åˆæ˜¯å¦ä¸€ä¸ªæ•…äº‹äº†ã€‚</p><p><strong>ä½ä¹…å</strong>åˆ™å®è‡³åå½’ï¼Œæˆäº†é›…é‚£ç‰¹æœ€ä¼Ÿå¤§çš„ä¸°ç©°ç¥ã€‚æ®è¯´åœ¨å¾€åæ•°ç™¾å¹´ï¼Œå¥¹çš„ç¨»å­ä¸ºè¯¸ç¥æ‰€çˆ±ï¼Œå°†ä¸°ç©°å¸¦ç»™å‡¡é—´ã€‚</p>    <figure class="figure-image">      <img src="2021021719085300-3E76408CDEF3BAC51A41DB325F1EE97E.jpg" alt="" width="100%" height="20% loading="lazy" />      <figcaption></figcaption>    </figure>  </blockquote></div>]]></content>
    
    
      
      
    <summary type="html">&lt;blockquote&gt;
&lt;p&gt;æœ€åæ”¾staffåå•çš„æ—¶å€™çš„ç‰‡å°¾æ›²ã€‚å¦å¤–ä¸€ä¸ªå”±å¾—ä¸å¤ªæ­£ç»çš„ç‰ˆæœ¬ä¹Ÿå¾ˆæœ‰æ„æ€ï¼Œå˜å¥åœ¨è®¸å¤šåœºæ™¯é‡Œé¢éƒ½å‡ºç°è¿‡ã€‚å¯èƒ½æ˜¯æ­Œæ¯”è¾ƒæ…¢ï¼Œæ‰“å‡ºstaffä¹‹åèººåœ¨åºŠä¸Šå¬ç€å¬ç€ç¡ç€äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&quot;aplayer-box&quot; </summary>
      
    
    
    
    
    <category term="Experience" scheme="https://waynexia.github.io/tags/Experience/"/>
    
    <category term="Game" scheme="https://waynexia.github.io/tags/Game/"/>
    
  </entry>
  
  <entry>
    <title>Paper Reading: Adaptive Radix Tree</title>
    <link href="https://waynexia.github.io/2020/07/adaptive-radix-tree/"/>
    <id>https://waynexia.github.io/2020/07/adaptive-radix-tree/</id>
    <published>2020-07-13T21:45:12.000Z</published>
    <updated>2023-11-23T08:35:22.616Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯-ART"><a href="#ä»€ä¹ˆæ˜¯-ART" class="headerlink" title="ä»€ä¹ˆæ˜¯ ART ?"></a>ä»€ä¹ˆæ˜¯ ART ?</h1><p>ART æ˜¯ä¸€ä¸ªèƒ½æä¾›é«˜æ•ˆç‚¹çš„å¢åˆ æŸ¥æ”¹ï¼Œä»¥åŠèŒƒå›´æŸ¥è¯¢çš„ç´¢å¼•ç»“æ„ã€‚æ˜¯ä¸€ä¸ªæœ‰åºçš„æ˜ å°„ã€‚åç§°ä¸­çš„ radix è¡¨ç¤ºè¿™æ˜¯ä¸€é¢—ç”¨åŸºæ•°æ¥æ„å»ºçš„ç»“æ„ï¼Œå†…éƒ¨æ•°æ®æ˜¯æœ‰åºå­˜å‚¨çš„ï¼Œæ‰€ä»¥æœ‰é«˜æ•ˆèŒƒå›´æŸ¥è¯¢çš„èƒ½åŠ›ã€‚ç›¸æ¯”äºå…¶ä»–å¸¸è§çš„åŸºæ•°ç»“æ„ï¼ŒART çš„ç©ºé—´åˆ©ç”¨ç‡æ›´é«˜ã€‚è¿™å¾—ç›Šäºå®ƒ adaptive çš„ç‰¹æ€§ï¼Œå³èƒ½å¤Ÿæ ¹æ®ç©ºé—´ä½¿ç”¨æƒ…å†µåŠ¨æ€åœ°è°ƒèŠ‚èŠ‚ç‚¹å¤§å°ã€‚</p>    <figure class="figure-image">      <img src="./1.png" alt="Compare to HashTable" width="50%" height="100% loading="lazy" />      <figcaption>Compare to HashTable</figcaption>    </figure>  <h1 id="åŸºæ•°æ ‘"><a href="#åŸºæ•°æ ‘" class="headerlink" title="åŸºæ•°æ ‘"></a>åŸºæ•°æ ‘</h1><p>æ˜¯trieæ ‘çš„ä¸€ç§ã€‚è¿™ç§æ•°æ®ç»“æ„æ‰€å‚¨å­˜çš„ä¿¡æ¯å¹¶ä¸åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œæ˜¯ç”±ä¸€æ¡ç”±æ ¹åˆ°å¶èŠ‚ç‚¹çš„è·¯å¾„æ‰€è¡¨ç¤ºï¼ˆå½“ç”¨ä½œæ˜ å°„çš„æ—¶å€™é€šå¸¸ä¸ºé”®çš„ä¿¡æ¯å‚¨å­˜åœ¨è·¯å¾„ä¸Šï¼Œå€¼çš„ä¿¡æ¯å­˜äºå¯¹åº”çš„å¶èŠ‚ç‚¹ï¼‰ã€‚</p>    <figure class="figure-image">      <img src="2.png" alt="An ART" width="50%" height="100% loading="lazy" />      <figcaption>An ART</figcaption>    </figure>  <h1 id="Adaptive-Node"><a href="#Adaptive-Node" class="headerlink" title="Adaptive Node"></a>Adaptive Node</h1><p>ART ä½¿ç”¨èƒ½åŠ¨æ€è°ƒèŠ‚å¤§å°ï¼ˆè‡ªé€‚åº” adaptiveï¼‰çš„èŠ‚ç‚¹ä½œä¸ºå†…éƒ¨æ ‘èŠ‚ç‚¹ï¼Œèƒ½å¤Ÿæé«˜å†…å­˜ä½¿ç”¨ç‡ã€‚DBMS ä¸­å¸¸è§çš„æœ‰åºç´¢å¼•æ•°æ®ç»“æ„B-treeæˆ–è€…ä¼ ç»Ÿçš„radix treeå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹çš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œå› æ­¤å­˜åœ¨ç©ºé—´æ”¾å¤§çš„é—®é¢˜ã€‚ç±»ä¼¼äºç£ç›˜æˆ–å†…å­˜é¡µè¡¨çš„å¤§å°ï¼ŒèŠ‚ç‚¹çš„å¤§å°é€šå¸¸éœ€è¦å–èˆï¼ŒèŠ‚ç‚¹å¤ªå¤§çš„è¯æµªè´¹å¾ˆä¸¥é‡ï¼ŒèŠ‚ç‚¹å¤ªå°è·¯å¾„åˆå¾ˆé•¿ï¼Œå½±å“è¯»å†™æ•ˆç‡ã€‚</p>    <figure class="figure-image">      <img src="3.png" alt="" width="70%" height="100% loading="lazy" />      <figcaption></figcaption>    </figure>  <p>è™½ç„¶ç†è®ºä¸Šè¯´èƒ½å¤Ÿä½¿ç”¨åŠ¨æ€æ•°ç»„ä½œä¸ºå†…éƒ¨èŠ‚ç‚¹ï¼Œä½†æ˜¯è¿™æ ·ä¼šæ¶‰åŠåˆ°é¢‘ç¹çš„å†…å­˜åˆ†é…é‡Šæ”¾ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒARTå°†èŠ‚ç‚¹çš„å¤§å°å›ºå®šä¸ºäº†å››ç§ã€‚åˆ†åˆ«ä¸º4ã€16ã€48ä»¥åŠ256ã€‚å¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹æ ¹æ®å¤§å°ï¼Œåœ¨å…·ä½“çš„ç»“æ„ä»¥åŠè¡Œä¸ºä¸Šä¼šæœ‰ç»†å¾®ä¸åŒ</p><h1 id="å››ç§èŠ‚ç‚¹çš„å…·ä½“å®ç°"><a href="#å››ç§èŠ‚ç‚¹çš„å…·ä½“å®ç°" class="headerlink" title="å››ç§èŠ‚ç‚¹çš„å…·ä½“å®ç°"></a>å››ç§èŠ‚ç‚¹çš„å…·ä½“å®ç°</h1><p>é¦–å…ˆèŠ‚ç‚¹ç±»å‹çš„å˜åŒ–ä»…å‘ç”Ÿåœ¨ä¸Šæº¢æˆ–è€…ä¸‹æº¢æ—¶ï¼Œå³å¯ä»¥/éœ€è¦ä½¿ç”¨å¦ä¸€ç§ç±»å‹çš„èŠ‚ç‚¹æ¥ä»£æ›¿ã€‚éœ€è¦æ³¨æ„ç”±äºå‰ç¼€æ ‘çš„ç‰¹æ€§ï¼Œä¸€ä¸ªèŠ‚ç‚¹çš„æœ€å¤§å®½åº¦æ˜¯æœ‰é™çš„ï¼Œå› æ­¤å¹¶ä¸ä¼šæ¨ªå‘åˆ†è£‚æˆä¸¤ä¸ªèŠ‚ç‚¹ã€‚</p><h2 id="Node4-ä¸-Node16"><a href="#Node4-ä¸-Node16" class="headerlink" title="Node4 ä¸ Node16"></a>Node4 ä¸ Node16</h2>    <figure class="figure-image">      <img src="4.png" alt="Node4 and Node16" width="40%" height="100% loading="lazy" />      <figcaption>Node4 and Node16</figcaption>    </figure>  <p>Node4 ä¸ Node16 åœ¨ç»“æ„ä¸Šé¢æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯ç”±ä¸€å¯¹æ•°é‡ç›¸ç­‰çš„æ•°ç»„ç»„æˆï¼Œå…¶ä¸­ä¸€ä¸ªå­˜æ”¾é”®ï¼Œå¦ä¸€ä¸ªå­˜æ”¾æŒ‡é’ˆã€‚</p><h2 id="Node48"><a href="#Node48" class="headerlink" title="Node48"></a>Node48</h2>    <figure class="figure-image">      <img src="5.png" alt="Node48" width="40%" height="100% loading="lazy" />      <figcaption>Node48</figcaption>    </figure>  <p>Node48 ä¸å‰ä¸¤ç§ä¸€æ ·ä¹Ÿæ˜¯ç”±ä¸¤ä¸ªæ•°ç»„ç»„æˆï¼Œä¸è¿‡å­˜å‚¨é”®çš„æ•°ç»„æœ‰256çš„å®¹é‡ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡ä¸‹æ ‡è¿›è¡Œç´¢å¼•ã€‚</p><h2 id="Node256"><a href="#Node256" class="headerlink" title="Node256"></a>Node256</h2>    <figure class="figure-image">      <img src="6.png" alt="Node256" width="40%" height="100% loading="lazy" />      <figcaption>Node256</figcaption>    </figure>  <p>Node256ä¸Node48ç›¸æ¯”å…¶å®å°±æ˜¯ç¬¬äºŒä¸ªæ•°ç»„çš„å¤§å°ä¹Ÿæ¥åˆ°äº†256ï¼Œé”®ä¸å€¼æœ‰æ»¡å°„çš„å…³ç³»ï¼Œå¯ä»¥çœç•¥ä¸€æ¬¡ç´¢å¼•ã€‚</p><h1 id="è·¯å¾„å‹ç¼©"><a href="#è·¯å¾„å‹ç¼©" class="headerlink" title="è·¯å¾„å‹ç¼©"></a>è·¯å¾„å‹ç¼©</h1><p>æ–‡ä¸­å°†è·¯å¾„å‹ç¼©åˆ†æˆäº†ä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯ path compression å’Œ lazy expansionã€‚ path compression æŒ‡å°†åªæœ‰ä¸€ä¸ª key çš„èŠ‚ç‚¹å¾€ä¸‹åˆå¹¶ï¼Œç›´åˆ°éœ€è¦åŒºåˆ†å¤šä¸ªå­èŠ‚ç‚¹ä¸ºæ­¢ã€‚lazy expansion è¡¨ç¤ºæŠŠä¸€ä¸ªèŠ‚ç‚¹è·¯å¾„ä¸Šæ²¡æœ‰åˆ†å‰çš„éƒ¨åˆ†æŠ˜å èµ·æ¥ã€‚</p>    <figure class="figure-image">      <img src="7.png" alt="Two ways of path compression" width="70%" height="100% loading="lazy" />      <figcaption>Two ways of path compression</figcaption>    </figure>  <p>æ—¢ç„¶è·¯å¾„è¢«å‹ç¼©ï¼Œé‚£ä¹ˆåœ¨æŸ¥æ‰¾çš„æ—¶å€™ä¹Ÿéœ€è¦åœ¨æ¯”è¾ƒ key æ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚æ–‡ä¸­å°†å¤„ç†åˆ†ä¸ºäº†ä¸¤ç±»ã€‚æ‚²è§‚çš„æ–¹å¼æ˜¯èŠ‚ç‚¹å‚¨å­˜ä¸€ä¸ªé•¿åº¦ä¸å®šçš„å‰ç¼€å€¼ï¼Œåœ¨æ¯æ¬¡ä¸‹é™åœ°æ—¶å€™ä½¿ç”¨è¿™ä¸ªå€¼è¿›è¡Œæ¯”è¾ƒã€‚ä¹è§‚åœ°æ–¹å¼æ˜¯èŠ‚ç‚¹åªå‚¨å­˜è¢«å‹ç¼©åœ°å‰ç¼€åœ°é•¿åº¦ï¼Œåœ¨æ¯æ¬¡ä¸‹é™è¿‡ç¨‹ä¸­ç›´æ¥è·³è¿‡è¿™ä¸ªé•¿åº¦çš„ key çš„å¤„ç†ï¼Œå¹¶åœ¨æœ€åè¾¾åˆ°å¶å­èŠ‚ç‚¹æ—¶å†æ¯”è¾ƒ key æ˜¯å¦ç›¸ç­‰ã€‚æ–‡ä¸­çš„èŠ‚ç‚¹å°†è¿™ä¸¤ç§æ–¹å¼ç»„åˆèµ·æ¥ï¼Œåœ¨ä¸‹é™çš„æ—¶å€™æŒ‰ç…§å‰ç¼€é•¿åº¦è¿›è¡ŒåŠ¨æ€å¤„ç†ã€‚</p><h1 id="èŠ‚ç‚¹-header"><a href="#èŠ‚ç‚¹-header" class="headerlink" title="èŠ‚ç‚¹ header"></a>èŠ‚ç‚¹ header</h1><p>ä¸€ä¸ªèŠ‚ç‚¹é™¤äº†è‡ªå·±çš„æ•°æ®åŸŸä¹‹å¤–ï¼Œè¿˜åŒ…å«äº†ä¸€äº›å…ƒä¿¡æ¯ã€‚ä¾‹å¦‚èŠ‚ç‚¹çš„ç±»å‹ï¼Œå®é™…å®¹é‡ï¼Œå‹ç¼©çš„è·¯å¾„ï¼ˆå‰ç¼€å’Œ / æˆ–å‰ç¼€çš„é•¿åº¦ï¼‰ç­‰ã€‚åœ¨æ–‡ä¸­ï¼ŒèŠ‚ç‚¹æœ‰å…«å­—èŠ‚çš„å‰ç¼€åŒºåŸŸä»¥åŠå››å­—èŠ‚çš„å‰ç¼€é•¿åº¦åŸŸï¼Œå³ä¸Šä¸€æ®µæåˆ°çš„æ‚²è§‚ä¸ä¹è§‚ç›¸ç»“åˆçš„å¤„ç†æ–¹æ³•ã€‚</p><h1 id="è¯»å†™æ“ä½œ"><a href="#è¯»å†™æ“ä½œ" class="headerlink" title="è¯»å†™æ“ä½œ"></a>è¯»å†™æ“ä½œ</h1><h2 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h2><p>å¯¹äº Node4 é‡‡ç”¨éå†çš„æ–¹æ³•ï¼ŒNode16 ä½¿ç”¨ SIMD æˆ–è€…äºŒåˆ†æ¥æ¯”è¾ƒå½“å‰çš„ keyï¼ŒNode48 ä¸ Node256 åˆ†åˆ«åªéœ€è¿›è¡Œä¸¤æ¬¡ / ä¸€æ¬¡ç´¢å¼•å°±èƒ½å¯¹æ¯”åˆ°å‰ç¼€è¿›è¡Œä¸‹é™ã€‚<br>ä¸€ä¸ªä¸€èˆ¬çš„æŸ¥è¯¢æµç¨‹ä¸ºæ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹è¿›è¡Œä¸‹é™æˆ–è¿”å›å®ŒæˆæŸ¥æ‰¾ï¼Œå¯¹äºä¸å­˜åœ¨çš„é”®æˆ–è€…èŠ‚ç‚¹è¿”å›ç©ºã€‚å¦å¤–ç”±äº path compression çš„å­˜åœ¨ï¼Œå¯èƒ½ä¸€æ¬¡ä¸‹é™ä¼šå®Œæˆå¤šä¸ª bytes çš„æ¯”è¾ƒã€‚<br>è€Œ range scan å¯ä»¥ä½¿ç”¨ç±»ä¼¼æ·±æœçš„æ•°æ¬¡æŸ¥è¯¢å®ç°ã€‚</p><h2 id="æ’å…¥-åˆ é™¤"><a href="#æ’å…¥-åˆ é™¤" class="headerlink" title="æ’å…¥ / åˆ é™¤"></a>æ’å…¥ / åˆ é™¤</h2><p>ä¸€èˆ¬ä¸€ä¸ª key çš„æ’å…¥æˆ–åˆ é™¤å¯èƒ½å‡ºç°å‡ ç§ç‰¹æ®Šæƒ…å†µã€‚å‘ç”Ÿä¸Šæº¢/ä¸‹æº¢æ—¶éœ€è¦è¿›è¡ŒèŠ‚ç‚¹çš„æ›¿æ¢æ¥å®Œæˆæ‰©/ç¼©å®¹ï¼›å¦‚æœä¸€æ¬¡æ‰©ç¼©å®¹è§¦å‘äº†è·¯å¾„å‹ç¼©ï¼Œé‚£ä¹ˆä¼šæœ‰å†…éƒ¨èŠ‚ç‚¹çš„æ–°å¢æˆ–åˆ é™¤ï¼Œä»¥åŠèŠ‚ç‚¹å…ƒä¿¡æ¯é‡Œå‰ç¼€æ•°æ®çš„è°ƒæ•´ã€‚<br>å¦‚æœä¸€æ¬¡æ‰©å®¹çš„èŠ‚ç‚¹æ˜¯ lazy expansion çš„ï¼Œæˆ–è€…ç¼©å®¹å¯¼è‡´èŠ‚ç‚¹çš„å®é™…å®¹é‡å˜ä¸º1ï¼Œé‚£ä¹ˆè¿™æ¡è·¯å¾„çš„é•¿åº¦ä¼šå‘ç”Ÿå˜åŒ–ï¼ˆä»¥æ’å…¥ä¸ºä¾‹ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°èŠ‚ç‚¹æ›¿æ¢å½“å‰çš„å¶å­èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ–°èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå¶å­èŠ‚ç‚¹ï¼Œåˆ†åˆ«ä¸ºä¹‹å‰çš„ä»¥åŠæ–°å¢çš„ï¼ŒèŠ‚ç‚¹çš„å‰ç¼€ä¹Ÿä¼šå˜æˆä¸¤ä¸ªå¶å­èŠ‚ç‚¹çš„ key çš„é‡åˆéƒ¨åˆ†ï¼‰ï¼›å¦‚æœæ–°æ’å…¥èŠ‚ç‚¹çš„ key ä¼šå½±å“ä¸€ä¸ªèŠ‚ç‚¹çš„å‰ç¼€ï¼Œé‚£ä¹ˆä¹Ÿä¼šåœ¨è¯¥èŠ‚ç‚¹ä¸Šé¢æ–°å¢ä¸€ä¸ª inner èŠ‚ç‚¹ï¼Œå¹¶ç›¸åº”åœ°è°ƒèŠ‚å‰ç¼€ï¼›å…¶ä»–çš„æƒ…å†µåªéœ€è¦è¿›è¡Œç®€å•çš„æ’å…¥åˆ é™¤å°±è¡Œäº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ä¸Šè¿°å‡ ç§æƒ…å†µä¸­ï¼Œä¸€æ¬¡å¢åˆ è¿‡ç¨‹ä¸­ä¼šå—åˆ°å½±å“çš„èŠ‚ç‚¹æœ€å¤šä»…æœ‰ä¸¤ä¸ªã€‚</p><h1 id="æ•°æ®è¡¨ç¤º"><a href="#æ•°æ®è¡¨ç¤º" class="headerlink" title="æ•°æ®è¡¨ç¤º"></a>æ•°æ®è¡¨ç¤º</h1><p>ä¸ºäº†å®ç°æ•°æ®æœ‰åºæ’åˆ—ï¼Œéœ€è¦èƒ½å°†æ•°æ®ç±»å‹è¡¨ç¤ºæˆäºŒè¿›åˆ¶å¯æ¯”è¾ƒï¼ˆbinary comparableï¼‰çš„å½¢å¼ã€‚<br>æ— ç¬¦å·æ•´å‹å¤©ç„¶æ»¡è¶³è¦æ±‚ï¼Œåªæ˜¯éœ€è¦æ³¨æ„å¤§å°ç«¯ã€‚æœ‰ç¬¦å·æ•´å‹éœ€è¦åšä¸€æ¬¡å¼‚æˆ–æ“ä½œæ¥å¤„ç†è¡¥ç è¡¨ç¤ºæ³•ã€‚æµ®ç‚¹æ•°ç¨å¾®å¤æ‚ä¸€äº›ï¼ŒæŒ‰ç…§ [ æ­£ï¼Œè´Ÿ ] x [ è§„æ ¼åŒ–ã€éè§„æ ¼åŒ–ã€NaNã€âˆã€0 ] åˆ†ä¸ºäº’ä¸é‡å çš„åç±»ï¼Œç„¶åé‡æ–°ç»™ rankã€‚å¯¹äºå­—ç¬¦ä¸²æœ‰ Unicode å®šä¹‰çš„æ¯”è¾ƒç®—æ³•ã€‚</p><h1 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h1><p>åœ¨æœ¬æ–‡çš„ benchmark ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“æ•°æ®çš„ key åˆ†å¸ƒæ¯”è¾ƒå¯†é›†æ—¶ï¼ŒART æœ‰ç€å¾ˆä¼˜ç§€çš„è¡¨ç°ã€‚è€Œä¸”é™¤äº† range scan èŒƒå›´è¯»ä¹‹å¤–ï¼ŒART çš„ bulk load èŒƒå›´å†™ä¹Ÿæœ‰å¾ˆå¤§çš„å‘æ˜ç©ºé—´ã€‚</p><h1 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h1><p>æ–‡ç« ä»‹ç»äº†ä¸¤ç§å¹¶å‘æ–¹æ¡ˆï¼Œåˆ†åˆ«æ˜¯ Optimistic Lock Coupling å’Œ Read-Optimized Write EXclusion (ROWEX)ã€‚å®ƒä»¬çš„æ€§èƒ½å¾ˆæ¥è¿‘ã€‚</p>    <figure class="figure-image">      <img src="8.png" alt="Comparison of serval concurrency schemas" width="70%" height="100% loading="lazy" />      <figcaption>Comparison of serval concurrency schemas</figcaption>    </figure>  <h2 id="Optimistic-Lock-Coupling"><a href="#Optimistic-Lock-Coupling" class="headerlink" title="Optimistic Lock Coupling"></a>Optimistic Lock Coupling</h2><p>æ˜¯åœ¨ä¼ ç»Ÿ Lock Coupling æ–¹æ¡ˆä¸Šçš„ä¸€ç§ä¼˜åŒ–ã€‚Lock Coupling çš„é‡ç‚¹åœ¨äºä¸€ä¸ªæ“ä½œåŒæ—¶æœ€å¤šæŒæœ‰ä¸¤æŠŠé”ï¼Œæ˜¯çº¿ç¨‹åŒæ­¥ B-Tree çš„å¸¸è§åšæ³•ã€‚å¹¶ä¸”åœ¨ ART çš„èƒŒæ™¯ä¸‹ï¼Œä¸€æ¬¡ä¿®æ”¹æœ€å¤šåªä¼šå½±å“åˆ°ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œéå¸¸é€‚åˆä½¿ç”¨ Lock Coupling æ¥å®ç°å¹¶å‘ã€‚ä½†æ˜¯ Lock Coupling å› ä¸ºæ¯æ¬¡å–å¾—ä¸€æŠŠé”éƒ½ä¼šä¿®æ”¹èŠ‚ç‚¹çš„å†…å®¹ï¼Œæ‰€ä»¥å¯¹ç¼“å­˜å¾ˆä¸å‹å¥½ï¼Œå¯¼è‡´å…¶æ•ˆç‡ä½ä¸‹ã€‚åœ¨è¿™é‡Œé‡‡ç”¨ä¸€ç§ Optimistic çš„åšæ³•ï¼Œå³å‡è®¾å†²çªå¾ˆå°‘å‡ºç°ï¼Œæ¯æ¬¡åªåœ¨è¯»å®Œä¹‹åæ£€æµ‹ç‰ˆæœ¬ä¿¡æ¯æ¥åˆ¤æ–­æœ‰æ²¡æœ‰è¯»åˆ°è¿‡æ—¶ä¿¡æ¯ï¼Œè€Œéé¢„å…ˆä¸Šé”æ¥ç¡®ä¿äº’æ–¥ã€‚å¦‚æœæ£€æµ‹åˆ°äº†è¿‡æœŸä¿¡æ¯åˆ™è¿›è¡Œé‡è¯•ï¼Œä¸ºäº†é˜²æ­¢é¥¿æ­»å¯ä»¥åœ¨è‹¥å¹²æ¬¡é‡è¯•å¤±è´¥ä¹‹åè¿›è¡ŒåŠ é”ã€‚</p><h2 id="ROWEX"><a href="#ROWEX" class="headerlink" title="ROWEX"></a>ROWEX</h2><p>åˆ™ç¨å¾®å¤æ‚ä¸€ç‚¹ï¼Œå®ƒè¦æ±‚ writer é€šè¿‡åŸå­æ“ä½œæ¥ä¿è¯ reader ä¸ä¼šå‡ºç°è„è¯»ã€‚è¿™ä¸ªæ–¹æ³•ä¹Ÿä½¿ç”¨åˆ°äº†é”ï¼Œä¸è¿‡ä»…é’ˆå¯¹ writer æä¾›äº’æ–¥æ€§ï¼Œè€Œè¯»æ“ä½œæ˜¯ wait-free å¹¶ä¸”ä¸ Optimistic Lock Coupling ä¸åŒï¼Œæ˜¯ä¿è¯æˆåŠŸçš„ã€‚</p><h1 id="Bench"><a href="#Bench" class="headerlink" title="Bench"></a>Bench</h1><p>åœ¨<a target="_blank" rel="noopener" href="https://dbis-informatik.uibk.ac.at/sites/default/files/2018-06/hot-height-optimized.pdf">HOT (SIGMOD 2018)</a> çš„ appendix A æ‰¾åˆ°ä¸€ä¸ªæ¯”è¾ƒå…¨é¢çš„ Cross Validationã€‚TL; DR. åœ¨æ•°æ®å¯†é›†æŸ¥è¯¢æ¯”æ‰«æå¤šï¼Œå†™æ“ä½œæ¯”é‡è¾ƒå¤šçš„æƒ…å†µä¸‹ ART æœ‰å¾ˆä¼˜ç§€çš„è¡¨ç°ï¼Œçº¯æ‰«è¡¨æ€§èƒ½å¹¶ä¸æ¯” B-Tree å¥½ã€‚å¤§é‡å¯†é›†æ•°æ®ç‚¹æŸ¥è¡¨ç°å¯ä»¥è¶…è¿‡ HashTableï¼Œä¸è¿‡æ€§èƒ½ä¼šå—åˆ°æ•°æ®åˆ†å¸ƒçš„å½±å“ã€‚</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;ä»€ä¹ˆæ˜¯-ART&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯-ART&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯ ART ?&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯ ART ?&lt;/h1&gt;&lt;p&gt;ART æ˜¯ä¸€ä¸ªèƒ½æä¾›é«˜æ•ˆç‚¹çš„å¢åˆ æŸ¥æ”¹ï¼Œä»¥åŠèŒƒå›´æŸ¥è¯¢çš„ç´¢å¼•ç»“æ„ã€‚æ˜¯ä¸€ä¸ªæœ‰åºçš„æ˜ å°„ã€‚åç§°ä¸­çš„ r</summary>
      
    
    
    
    
    <category term="Paper Reading" scheme="https://waynexia.github.io/tags/Paper-Reading/"/>
    
  </entry>
  
</feed>
